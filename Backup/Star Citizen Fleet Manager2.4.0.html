<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Star Citizen Fleet Manager v2.4.0</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/dexie@3/dist/dexie.js"></script>
  <style>
    /* === HOLOGRAPHIC THEME CSS === */
    body { margin:0; padding:0; font-family: 'Orbitron', Arial, sans-serif; background: radial-gradient(circle, #001022, #000000); color: #00FFFF; overflow-x: hidden; position: relative; }
    .starfield { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:0; }
    .star { position:absolute; background: white; border-radius:50%; opacity:0.8; animation: twinkle 3s infinite ease-in-out; }
    @keyframes twinkle { 0%, 100% { opacity: 0.8; } 50% { opacity: 0.3; } }
    .holo-panel { background: rgba(0,0,0,0.5); border:2px solid #00FFFF; box-shadow:0 0 15px rgba(0,255,255,0.7); border-radius:8px; padding:20px; margin:20px auto; max-width:1400px; backdrop-filter: blur(5px); animation: boot-up 1s ease-in-out; position: relative; z-index:1; }
    @keyframes boot-up {0% {opacity:0; transform: translateY(20px);} 100% {opacity:1; transform: translateY(0);} }
    .header { text-align:center; text-shadow:0 0 5px #00FFFF; font-size:1.8em; margin-bottom: 10px; }
    .header-container { 
      display: grid; 
      grid-template-columns: 1fr auto auto; 
      gap: 20px; 
      align-items: start; 
      margin-bottom: 20px; 
    }
    .app-title-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .control-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      min-width: 200px;
    }
    .control-buttons button {
      padding: 8px 12px;
      font-size: 0.85em;
      white-space: nowrap;
      border: 1px solid #00FFFF;
      background: rgba(0,0,0,0.8);
      color: #00FFFF;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Orbitron', Arial, sans-serif;
      border-radius: 4px;
    }
    .control-buttons button:hover {
      box-shadow: 0 0 10px #00FFFF;
      background: rgba(0,255,255,0.1);
    }
    .status-section {
      display: flex;
      flex-direction: column;
      min-width: 280px;
    }
    .version-info { 
      font-size:0.9em; 
      color:#00FF88; 
      text-shadow:0 0 3px #00FF88; 
      text-align:right; 
      line-height:1.2; 
      padding: 10px;
      border: 1px solid #00FF88;
      border-radius: 6px;
      background: rgba(0,0,0,0.6);
      margin-bottom: 10px;
    }
    .version-refresh {
      font-size: 0.8em;
      color: #00FFFF;
      cursor: pointer;
      text-decoration: underline;
      margin-top: 4px;
    }
    .version-refresh:hover { color: #FF4500; }
    .api-status { 
      padding: 8px; 
      border: 1px solid #00FFFF; 
      border-radius: 6px; 
      background: rgba(0,0,0,0.6); 
      font-size: 0.8em; 
      margin-bottom: 10px;
    }
    .api-status div { margin: 3px 0; }
    .api-ok { color: #00FF88; }
    .api-fail { color: #FF4500; }
    .api-pending { color: #FFFF66; }
    .activity-log { 
      padding: 8px; 
      border: 1px solid #00FFFF; 
      border-radius: 6px; 
      background: rgba(0,0,0,0.6); 
      font-size: 0.75em; 
      max-height: 180px; 
      overflow-y: auto; 
    }
    .activity-log div { 
      margin: 2px 0; 
      padding: 2px 0;
      border-bottom: 1px solid rgba(0,255,255,0.2);
    }
    .activity-log div:last-child { border-bottom: none; }
    .nav-tabs { display:flex; justify-content:center; margin:20px 0; flex-wrap: wrap; gap: 10px; }
    .nav-tab { padding:12px 24px; border:2px solid #00FFFF; border-radius:6px; cursor:pointer; transition:all 0.3s; font-weight: bold; }
    .nav-tab:hover { box-shadow:0 0 15px #00FFFF; transform: translateY(-2px); }
    .nav-tab.active { background: rgba(0,255,255,0.2); border-bottom:4px solid #FF4500; }
    .content { display:none; }
    .content.active { display:block; }
    .metrics-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px,1fr)); gap:20px; margin-bottom: 20px; }
    .metric-card { 
      background:rgba(0,0,0,0.7); 
      border:1px solid #00FFFF; 
      padding:20px; 
      text-align:center; 
      box-shadow:0 0 10px rgba(0,255,255,0.5); 
      border-radius: 6px;
      transition: transform 0.3s;
    }
    .metric-card:hover { transform: translateY(-3px); }
    .metric-card h3 { margin: 0 0 10px 0; color: #FF4500; }
    .alert { color: #FF4500; text-shadow:0 0 5px #FF4500; }
    input, select, button { 
      background: rgba(0,0,0,0.8); 
      border:1px solid #00FFFF; 
      color:#00FFFF; 
      padding:8px; 
      margin:5px; 
      font-family: 'Orbitron', Arial, sans-serif; 
      border-radius: 4px;
      transition: all 0.3s;
    }
    input:focus, select:focus { 
      outline: none; 
      box-shadow: 0 0 8px #00FFFF; 
      border-color: #FF4500;
    }
    button:hover { box-shadow:0 0 10px #00FFFF; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border:1px solid #00FFFF; padding:10px; text-align:left; }
    th { 
      background:rgba(0,255,255,0.1); 
      cursor:pointer; 
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    th:hover { background: rgba(0,255,255,0.2); }
    tr:nth-child(even) { background: rgba(0,255,255,0.05); }
    tr:hover { background: rgba(0,255,255,0.1); }
    .reliability-green { color:#00FF88; font-weight: bold; }
    .reliability-yellow { color:#FFFF66; font-weight: bold; }
    .reliability-red { color:#FF4500; font-weight: bold; }
    #offline-banner { background: rgba(255,69,0,0.9); color:white; text-align:center; padding:12px; display:none; font-weight: bold; }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(350px,1fr)); gap:25px; }
    .form-section { 
      background: rgba(0,0,0,0.4); 
      padding: 20px; 
      border: 1px solid #00FFFF; 
      border-radius: 8px;
    }
    .form-section h3 { 
      margin-top: 0; 
      color: #FF4500; 
      text-align: center;
      border-bottom: 1px solid #00FFFF;
      padding-bottom: 10px;
    }
    .ship-image { width:120px; height:auto; border-radius: 4px; }
    .modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.8); }
    .modal-content { 
      background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(0,16,34,0.9));
      margin:5% auto; 
      padding:25px; 
      border:2px solid #00FFFF; 
      width:90%; 
      max-width:600px; 
      box-shadow:0 0 25px #00FFFF; 
      border-radius: 10px;
    }
    .close { color:#FF4500; float:right; font-size:32px; font-weight:bold; cursor: pointer; }
    .close:hover, .close:focus { color:#00FFFF; text-decoration:none; }
    .filter-group { display:flex; flex-wrap:wrap; gap:12px; margin-bottom:25px; }
    .tooltip { position:relative; display:inline-block; }
    .tooltip .tooltiptext { 
      visibility:hidden; 
      width:250px; 
      background-color:rgba(0,0,0,0.9); 
      color:#00FFFF; 
      text-align:center; 
      border-radius:6px; 
      padding:8px; 
      position:absolute; 
      z-index:1000; 
      bottom:125%; 
      left:50%; 
      margin-left:-125px; 
      opacity:0; 
      transition:opacity 0.3s;
      border: 1px solid #00FFFF;
    }
    .tooltip:hover .tooltiptext { visibility:visible; opacity:1; }
    .detail-info { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px,1fr)); gap:20px; margin-bottom:20px; }
    .detail-card { 
      background:rgba(0,0,0,0.7); 
      border:1px solid #00FFFF; 
      padding:18px; 
      border-radius:6px; 
      transition: transform 0.3s;
    }
    .detail-card:hover { transform: translateY(-2px); }
    .detail-card h4 { 
      margin-top: 0; 
      color: #FF4500; 
      border-bottom: 1px solid #00FFFF;
      padding-bottom: 5px;
    }
    .back-button, .update-button, .reset-button { 
      background:rgba(0,0,0,0.8); 
      border:2px solid #FF4500; 
      color:#FF4500; 
      padding:12px 24px; 
      cursor:pointer; 
      font-family:'Orbitron', Arial, sans-serif; 
      margin-right:15px; 
      border-radius: 6px;
      font-weight: bold;
      transition: all 0.3s;
    }
    .back-button:hover, .update-button:hover, .reset-button:hover { 
      box-shadow:0 0 15px #FF4500; 
      background: rgba(255,69,0,0.1);
      transform: translateY(-2px);
    }
    .name-link { color:#00FFFF; text-decoration:underline; cursor:pointer; font-weight: bold; }
    .name-link:hover { color:#FF4500; }
    .sync-status { 
      color:#FFFF66; 
      font-size:0.9em; 
      display:none; 
      margin:10px 0; 
      text-align: center;
      padding: 10px;
      background: rgba(255,255,102,0.1);
      border: 1px solid #FFFF66;
      border-radius: 4px;
    }
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #00FFFF;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .status-ok { background: #00FF88; }
    .status-fail { background: #FF4500; }
    .status-pending { background: #FFFF66; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    .enhanced-card {
      background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(0,16,34,0.6));
      border: 2px solid #00FFFF;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      transition: all 0.3s;
    }
    .enhanced-card:hover {
      box-shadow: 0 0 20px rgba(0,255,255,0.5);
      transform: translateY(-3px);
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .header-container { 
        grid-template-columns: 1fr; 
        text-align: center; 
        gap: 15px;
      }
      .control-buttons { 
        grid-template-columns: repeat(3, 1fr); 
        justify-self: center;
      }
      .status-section { min-width: auto; }
      .nav-tabs { flex-direction: column; align-items: center; }
      .form-grid { grid-template-columns: 1fr; }
      .filter-group { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="starfield"></div>
  <div id="offline-banner" class="alert">⚠️ Offline Mode - Using Cached Data</div>
  <div class="holo-panel">
    <div class="header-container">
      <div class="app-title-section">
        <div class="header" id="app-header">
          Star Citizen Fleet Manager v2.4.0
          <div style="font-size: 0.6em; margin-top: 5px;">
            UEE Citizen Console - Citizen: <span id="user-handle">Anonymous</span>
          </div>
        </div>
      </div>
      
      <div class="control-buttons">
        <button id="sync-btn">🔄 Sync Data</button>
        <button id="export-btn">📤 Export</button>
        <button id="import-btn">📥 Import</button>
        <button id="refresh-version-btn">🌐 Refresh Version</button>
        <button id="health-check-btn">🩺 API Check</button>
        <button id="clear-cache-btn">🗑️ Clear Cache</button>
        <input type="file" id="import-file" style="display: none;">
      </div>

      <div class="status-section">
        <div class="version-info" id="sc-version">
          <div style="font-weight:bold; margin-bottom: 5px;">⭐ Star Citizen Version</div>
          <div id="sc-version-text">Loading...</div>
          <div id="version-last-update" style="font-size: 0.8em; margin-top: 4px; color: #888;">Never updated</div>
          <div class="version-refresh" onclick="refreshSCVersion()">🔄 Refresh Version</div>
        </div>
        <div id="api-status" class="api-status">
          <div style="font-weight: bold; margin-bottom: 5px;">🌐 API Status</div>
        </div>
        <div id="activity-log" class="activity-log">
          <div style="font-weight: bold; margin-bottom: 5px;">📋 Activity Log</div>
        </div>
      </div>
    </div>

    <div id="sync-status" class="sync-status">
      <div class="loading-spinner"></div>Syncing with the Verse...
    </div>

    <div class="nav-tabs">
      <div class="nav-tab active" data-tab="dashboard">🏠 Dashboard HUD</div>
      <div class="nav-tab" data-tab="add">➕ Add Asset</div>
      <div class="nav-tab" data-tab="search">🔍 Search Fleet</div>
      <div class="nav-tab" data-tab="trading">💰 Trade Routes</div>
      <div class="nav-tab" data-tab="wishlist">⭐ Wishlist Scanner</div>
      <div class="nav-tab" data-tab="settings">⚙️ Settings</div>
    </div>

    <div id="dashboard" class="content active">
      <div class="metrics-grid">
        <div class="metric-card enhanced-card">
          <h3>🚀 Ships</h3>
          <div style="font-size: 2em; font-weight: bold;" id="ship-count">0</div>
          <div style="margin-top: 8px; font-size: 0.9em;">Total Fleet Assets</div>
        </div>
        <div class="metric-card enhanced-card">
          <h3>📦 Items</h3>
          <div style="font-size: 2em; font-weight: bold;" id="item-count">0</div>
          <div style="margin-top: 8px; font-size: 0.9em;">Inventory Count</div>
        </div>
        <div class="metric-card enhanced-card">
          <h3>💎 Fleet Value</h3>
          <div style="font-size: 2em; font-weight: bold;" id="fleet-value">0 aUEC</div>
          <div style="margin-top: 8px; font-size: 0.9em;">Estimated Worth</div>
        </div>
        <div class="metric-card enhanced-card">
          <h3>📊 Data Quality</h3>
          <div style="font-size: 2em; font-weight: bold;" id="data-quality">0%</div>
          <div style="margin-top: 8px; font-size: 0.9em;">Reliability Score</div>
        </div>
      </div>
      <div style="overflow-x: auto;">
        <table id="stats-table">
          <thead>
            <tr>
              <th>🖼️ Image</th>
              <th data-sort="name">📛 Name</th>
              <th data-sort="manufacturer">🏭 Manufacturer</th>
              <th data-sort="role">🎯 Role</th>
              <th data-sort="size">📏 Size</th>
              <th data-sort="hp">❤️ HP</th>
              <th data-sort="shield">🛡️ Shield</th>
              <th data-sort="cargo">📦 Cargo SCU</th>
              <th data-sort="owned_qty">🔢 Qty</th>
              <th data-sort="location">📍 Location</th>
              <th>⚙️ Loadout/Notes</th>
              <th data-sort="data_reliability_score">🎯 Data Reliability <span class="tooltip">?<span class="tooltiptext">Data reliability is based on how well multiple sources agree and how recent the data is. Green = Excellent, Yellow = Good, Red = Poor</span></span></th>
              <th>🛠️ Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="add" class="content">
      <div class="form-grid">
        <div class="form-section">
          <h3>🚀 Add Ship</h3>
          <input id="ship-name" placeholder="Ship Name" required>
          <input id="ship-manufacturer" placeholder="Manufacturer (e.g., Aegis Dynamics)">
          <select id="ship-role">
            <option value="">Select Role</option>
            <option>Military</option>
            <option>Civilian</option>
            <option>Industrial</option>
            <option>Miner</option>
            <option>Ground Vehicle</option>
            <option>Racing</option>
            <option>Exploration</option>
            <option>Other</option>
          </select>
          <input id="ship-size" placeholder="Size (Small/Medium/Large/Capital)">
          <input id="ship-qty" type="number" placeholder="Quantity" value="1" min="1">
          <input id="ship-location" placeholder="Location (e.g., Area18 Hangar)">
          <input id="ship-loadout" placeholder="Custom Loadout (optional)">
          <input id="ship-notes" placeholder="Additional Notes">
          <input id="ship-image" placeholder="Image URL (optional)">
          <button id="add-ship-btn">➕ Add Ship to Fleet</button>
        </div>
        <div class="form-section">
          <h3>📦 Add Item</h3>
          <input id="item-name" placeholder="Item Name" required>
          <select id="item-type">
            <option>weapon</option>
            <option>armor</option>
            <option>component</option>
            <option>commodity</option>
            <option>consumable</option>
            <option>tool</option>
            <option>other</option>
          </select>
          <input id="item-size" placeholder="Size (S1, S2, S3, etc.)">
          <input id="item-qty" type="number" placeholder="Quantity" value="1" min="1">
          <input id="item-location" placeholder="Storage Location">
          <input id="item-buy-price" type="number" placeholder="Buy Price (aUEC)" min="0">
          <input id="item-notes" placeholder="Additional Notes">
          <button id="add-item-btn">➕ Add Item to Inventory</button>
        </div>
      </div>
    </div>

    <div id="search" class="content">
      <div class="filter-group">
        <input id="search-query" placeholder="🔍 Search Name...">
        <select id="search-filter-type">
          <option value="">All Types</option>
          <option>ship</option>
          <option>weapon</option>
          <option>armor</option>
          <option>component</option>
          <option>commodity</option>
          <option>consumable</option>
          <option>tool</option>
          <option>other</option>
        </select>
        <input id="search-filter-manufacturer" placeholder="Manufacturer Filter">
        <select id="search-filter-role">
          <option value="">All Roles</option>
          <option>Military</option>
          <option>Civilian</option>
          <option>Industrial</option>
          <option>Miner</option>
          <option>Ground Vehicle</option>
          <option>Racing</option>
          <option>Exploration</option>
          <option>Other</option>
        </select>
        <select id="search-filter-size">
          <option value="">All Sizes</option>
          <option>Small</option>
          <option>Medium</option>
          <option>Large</option>
          <option>Capital</option>
        </select>
        <input id="search-filter-location" placeholder="Location Filter">
        <button id="perform-search-btn">🔍 Search Fleet</button>
        <button id="clear-search-btn">🗑️ Clear Filters</button>
      </div>
      <div style="overflow-x: auto;">
        <table id="search-table">
          <thead>
            <tr>
              <th>🖼️ Image</th>
              <th>📛 Name</th>
              <th>🏭 Type/Manufacturer</th>
              <th>🎯 Role</th>
              <th>📏 Size</th>
              <th>🔢 Qty</th>
              <th>📍 Location</th>
              <th>⚙️ Loadout/Notes</th>
              <th>🎯 Data Reliability</th>
              <th>🛠️ Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="trading" class="content">
      <div class="enhanced-card">
        <h3>💰 Commodity Trading Overview</h3>
        <p>Track your commodities and find profitable trading opportunities across the verse.</p>
      </div>
      <div style="overflow-x: auto;">
        <table id="trading-table">
          <thead>
            <tr>
              <th>📦 Commodity</th>
              <th>🔢 Quantity</th>
              <th>🏪 Best Sell Port</th>
              <th>💰 Price/SCU</th>
              <th>💎 Est. Profit</th>
              <th>⚠️ Alert</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="wishlist" class="content">
      <div class="enhanced-card">
        <h3>⭐ Add to Wishlist</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;">
          <input id="wishlist-name" placeholder="Item/Ship Name" required>
          <select id="wishlist-type">
            <option>ship</option>
            <option>item</option>
          </select>
          <input id="wishlist-target-price" type="number" placeholder="Target Price (aUEC)" min="0">
          <input id="wishlist-notes" placeholder="Notes">
          <button id="add-wishlist-btn">➕ Add to Wishlist</button>
        </div>
      </div>
      <div style="overflow-x: auto;">
        <table id="wishlist-table">
          <thead>
            <tr>
              <th>📛 Name</th>
              <th>📦 Type</th>
              <th>💰 Target Price</th>
              <th>📝 Notes</th>
              <th>🛠️ Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="settings" class="content">
      <div class="form-grid">
        <div class="form-section">
          <h3>🔑 API Configuration</h3>
          <input id="uex-key" placeholder="UEX API Key (optional)" type="password">
          <button id="save-uex-btn">💾 Save UEX Key</button>
          <div style="font-size: 0.8em; margin-top: 10px; color: #888;">
            UEX API key enables enhanced trading data. Get yours at uexcorp.space
          </div>
        </div>
        <div class="form-section">
          <h3>👤 User Settings</h3>
          <input id="user-handle-input" placeholder="Citizen Handle" maxlength="20">
          <button id="save-user-btn">💾 Save Handle</button>
          <div style="font-size: 0.8em; margin-top: 10px; color: #888;">
            Your Star Citizen handle for personalization
          </div>
        </div>
        <div class="form-section">
          <h3>🌐 API Health Status</h3>
          <div id="settings-api-health" style="margin-top:10px;"></div>
          <button id="test-apis-btn">🔧 Test All APIs</button>
        </div>
        <div class="form-section">
          <h3>🗃️ Data Management</h3>
          <button id="backup-data-btn">💾 Backup Data</button>
          <button id="clear-all-data-btn" style="border-color: #FF4500; color: #FF4500;">⚠️ Clear All Data</button>
          <div style="font-size: 0.8em; margin-top: 10px; color: #888;">
            Backup your data regularly. Clear all data will reset everything!
          </div>
        </div>
      </div>
    </div>

    <div id="detail" class="content">
      <div id="detail-header" class="header"></div>
      <div id="detail-info" class="detail-info"></div>
      <div style="margin-top: 20px;">
        <button id="update-ship-btn" class="update-button" style="display:none;">🔄 Update Ship Data</button>
        <button id="reset-ship-btn" class="reset-button" style="display:none;">↩️ Reset to Default</button>
        <button id="back-btn" class="back-button" onclick="goBackToDashboard()">← Back to Dashboard</button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>✏️ Edit Asset</h3>
      <div style="display: grid; gap: 10px; margin-top: 15px;">
        <input id="edit-name" placeholder="Name" disabled style="background: rgba(100,100,100,0.3);">
        <input id="edit-manufacturer" placeholder="Manufacturer/Type">
        <select id="edit-role">
          <option value="">Select Role</option>
          <option>Military</option>
          <option>Civilian</option>
          <option>Industrial</option>
          <option>Miner</option>
          <option>Ground Vehicle</option>
          <option>Racing</option>
          <option>Exploration</option>
          <option>Other</option>
        </select>
        <input id="edit-size" placeholder="Size">
        <input id="edit-qty" type="number" placeholder="Quantity" min="1">
        <input id="edit-location" placeholder="Location">
        <input id="edit-loadout" placeholder="Loadout (for ships)">
        <input id="edit-notes" placeholder="Notes">
        <input id="edit-buy-price" type="number" placeholder="Buy Price (for items)" min="0">
        <input id="edit-image" placeholder="Image URL">
        <select id="edit-type" style="display:none;">
          <option>weapon</option>
          <option>armor</option>
          <option>component</option>
          <option>commodity</option>
          <option>consumable</option>
          <option>tool</option>
          <option>other</option>
        </select>
        <button id="save-edit">💾 Save Changes</button>
      </div>
    </div>
  </div>

  <script>
  // ---------------- STAR CITIZEN FLEET MANAGER v2.4.0 ----------------
  // Enhanced with online version fetching, improved UI, better error handling

  // Globals
  let currentDetailItem = null;
  let currentDetailType = null;
  let editingItemKey = null;
  let editingItemKind = null;
  let currentSCVersion = 'Unknown';
  let lastVersionCheck = null;
  const IMAGE_PLACEHOLDER = 'https://via.placeholder.com/200x100/001122/00FFFF?text=No+Image+Available';
  const MAX_ACTIVITY = 50;

  // Dexie DB
  const db = new Dexie('SCFleetManager');
  db.version(7).stores({
    ships: 'name, manufacturer, role, size, value, owned_qty, location, loadout, notes, last_sync, data_reliability_score, image_url, hp, shield, cargo, hardpoints_json, _loadout_source, enriched_version',
    items: '++id, name, type, size, owned_qty, value, location, acquired_date, buy_price, data_reliability_score, notes, image_url',
    wishlist: 'name, type, target_price, notes',
    audit_log: '++id, timestamp, source, item_name, changes, verified',
    settings: 'key, value',
    history: '++id, timestamp, total_value'
  });

  // Enhanced API sources with better endpoints
  const API_SOURCES = {
    scwiki: { 
      name: 'Star Citizen Wiki', 
      base: 'https://api.star-citizen.wiki/v2', 
      ok: null,
      priority: 1,
      endpoints: {
        version: '/version',
        ship_stats: '/stats/latest/ship/',
        test: '/version'
      }
    },
    fleetyards: { 
      name: 'FleetYards', 
      base: 'https://api.fleetyards.net/v1', 
      ok: null,
      priority: 2,
      endpoints: {
        version: '/version',
        models: '/models',
        test: '/models?per_page=1'
      }
    },
    scapi: { 
      name: 'StarCitizen-API', 
      base: 'https://api.starcitizen-api.com', 
      ok: null,
      priority: 3,
      endpoints: {
        ships: '/ships/',
        test: '/ships/gladius'
      }
    },
    uex: { 
      name: 'UEX Corporation', 
      base: 'https://uexcorp.space/api/2.0', 
      ok: null,
      priority: 4,
      endpoints: {
        commodities: '/commodities_prices',
        test: '/commodities_prices?name=Food'
      }
    }
  };

  // Utility: Enhanced activity logging with timestamps and categories
  function logActivity(message, category = 'INFO') {
    try {
      const box = document.getElementById('activity-log');
      if (!box) return;
      
      // Skip the header when counting
      const entries = Array.from(box.children).filter(child => !child.style.fontWeight);
      
      const div = document.createElement('div');
      const ts = new Date().toLocaleTimeString();
      const icon = category === 'ERROR' ? '❌' : category === 'SUCCESS' ? '✅' : category === 'WARNING' ? '⚠️' : 'ℹ️';
      div.innerHTML = `<span style="color: #888;">${ts}</span> ${icon} ${message}`;
      
      // Insert after the header
      const header = box.querySelector('div[style*="font-weight: bold"]');
      if (header && header.nextSibling) {
        box.insertBefore(div, header.nextSibling);
      } else {
        box.appendChild(div);
      }
      
      // Trim excess entries (excluding header)
      while (entries.length >= MAX_ACTIVITY) {
        const oldestEntry = entries.shift();
        if (oldestEntry && oldestEntry.parentNode) {
          oldestEntry.parentNode.removeChild(oldestEntry);
        }
      }
    } catch (e) {
      console.warn('logActivity error', e);
    }
  }

  // Enhanced API status rendering with better indicators
  function renderApiStatus() {
    const box = document.getElementById('api-status');
    if (!box) return;
    
    // Clear but keep header
    const header = box.querySelector('div[style*="font-weight: bold"]');
    box.innerHTML = '';
    if (header) box.appendChild(header.cloneNode(true));
    
    const sortedApis = Object.keys(API_SOURCES).sort((a, b) => 
      API_SOURCES[a].priority - API_SOURCES[b].priority
    );
    
    for (const key of sortedApis) {
      const s = API_SOURCES[key];
      const div = document.createElement('div');
      const indicator = document.createElement('span');
      indicator.className = 'status-indicator ' + 
        (s.ok === true ? 'status-ok' : s.ok === false ? 'status-fail' : 'status-pending');
      div.appendChild(indicator);
      div.appendChild(document.createTextNode(`${s.name}: ${s.ok === true ? 'Online' : s.ok === false ? 'Offline' : 'Testing...'}`));
      div.className = s.ok === true ? 'api-ok' : (s.ok === false ? 'api-fail' : 'api-pending');
      box.appendChild(div);
    }
    
    // Mirror in settings
    const settingsBox = document.getElementById('settings-api-health');
    if (settingsBox) {
      settingsBox.innerHTML = '';
      for (const key of sortedApis) {
        const s = API_SOURCES[key];
        const d = document.createElement('div');
        d.innerHTML = `<span class="status-indicator ${s.ok === true ? 'status-ok' : s.ok === false ? 'status-fail' : 'status-pending'}"></span>${s.name}: ${s.ok === true ? 'Online' : s.ok === false ? 'Offline' : 'Testing...'}`;
        d.style.color = s.ok === true ? '#00FF88' : (s.ok === false ? '#FF4500' : '#FFFF66');
        d.style.marginBottom = '8px';
        settingsBox.appendChild(d);
      }
    }
  }

  // Enhanced fetch with better timeout and retry logic
  function fetchWithTimeout(resource, options = {}) {
    const { timeout = 10000 } = options;
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    return fetch(resource, { ...options, signal: controller.signal })
      .finally(() => clearTimeout(id));
  }

  // Robust JSON fetch with exponential backoff
  async function fetchJsonRetry(url, opts = {}, attempts = 3) {
    let lastErr = null;
    for (let i = 0; i < attempts; i++) {
      try {
        const res = await fetchWithTimeout(url, { ...opts, timeout: 8000 + i * 2000 });
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        const txt = await res.text();
        if (!txt.trim()) throw new Error('Empty response');
        try {
          return JSON.parse(txt);
        } catch (e) {
          throw new Error('Invalid JSON response');
        }
      } catch (err) {
        lastErr = err;
        if (i < attempts - 1) {
          const delay = Math.min(1000 * Math.pow(2, i), 5000);
          await new Promise(r => setTimeout(r, delay));
        }
      }
    }
    throw lastErr;
  }

  // Enhanced API health check with parallel testing
  async function checkApiHealth() {
    logActivity('Starting comprehensive API health check...');
    renderApiStatus(); // Show pending states
    
    const healthPromises = Object.keys(API_SOURCES).map(async (key) => {
      const s = API_SOURCES[key];
      try {
        let testUrl = s.base + (s.endpoints.test || '');
        const res = await fetchWithTimeout(testUrl, { 
          method: 'GET', 
          mode: 'cors',
          headers: { 'Accept': 'application/json' }
        }, { timeout: 5000 });
        s.ok = res.ok;
        return { key, success: res.ok };
      } catch (e) {
        s.ok = false;
        return { key, success: false, error: e.message };
      }
    });

    const results = await Promise.allSettled(healthPromises);
    const successful = results.filter(r => r.status === 'fulfilled' && r.value.success).length;
    const total = results.length;
    
    renderApiStatus();
    logActivity(`API health check complete: ${successful}/${total} APIs online`, 
      successful > total/2 ? 'SUCCESS' : 'WARNING');
  }

  // Enhanced SC version fetching with multiple sources and caching
  async function fetchSCVersion() {
    logActivity('Fetching latest Star Citizen version...');
    const versionSources = [
      {
        name: 'Star Citizen Wiki',
        url: 'https://api.star-citizen.wiki/v2/version',
        parser: (data) => data.version || data.live_version || data.current_version
      },
      {
        name: 'FleetYards',
        url: 'https://api.fleetyards.net/v1/version',
        parser: (data) => data.version || data.game_version
      },
      {
        name: 'StarCitizen-API',
        url: 'https://api.starcitizen-api.com/version',
        parser: (data) => data.version || data.live
      }
    ];

    for (const source of versionSources) {
      try {
        logActivity(`Trying ${source.name} for version info...`);
        const data = await fetchJsonRetry(source.url, {}, 2);
        const version = source.parser(data);
        
        if (version && version !== 'Unknown') {
          currentSCVersion = version;
          lastVersionCheck = new Date();
          
          // Update UI
          document.getElementById('sc-version-text').textContent = `${currentSCVersion}`;
          document.getElementById('version-last-update').textContent = 
            `Updated: ${lastVersionCheck.toLocaleTimeString()}`;
          
          // Mark API as working
          const apiKey = source.name.toLowerCase().includes('wiki') ? 'scwiki' : 
                        source.name.toLowerCase().includes('fleetyards') ? 'fleetyards' : 'scapi';
          if (API_SOURCES[apiKey]) {
            API_SOURCES[apiKey].ok = true;
          }
          
          renderApiStatus();
          logActivity(`SC version ${currentSCVersion} fetched from ${source.name}`, 'SUCCESS');
          
          // Store in localStorage for offline use
          localStorage.setItem('scVersion', currentSCVersion);
          localStorage.setItem('scVersionTimestamp', Date.now().toString());
          
          return;
        }
      } catch (e) {
        logActivity(`${source.name} version fetch failed: ${e.message}`, 'WARNING');
        continue;
      }
    }
    
    // Try localStorage cache
    const cachedVersion = localStorage.getItem('scVersion');
    const cachedTimestamp = localStorage.getItem('scVersionTimestamp');
    
    if (cachedVersion && cachedTimestamp) {
      const cacheAge = Date.now() - parseInt(cachedTimestamp);
      const cacheHours = Math.floor(cacheAge / (1000 * 60 * 60));
      
      if (cacheAge < 24 * 60 * 60 * 1000) { // Less than 24 hours old
        currentSCVersion = cachedVersion;
        document.getElementById('sc-version-text').textContent = `${currentSCVersion} (cached)`;
        document.getElementById('version-last-update').textContent = 
          `Cached: ${cacheHours}h ago`;
        logActivity(`Using cached SC version: ${currentSCVersion}`, 'INFO');
        return;
      }
    }
    
    // Ultimate fallback
    currentSCVersion = '4.3.1 (fallback)';
    document.getElementById('sc-version-text').textContent = currentSCVersion;
    document.getElementById('version-last-update').textContent = 'Failed to fetch';
    logActivity('All version sources failed, using fallback', 'ERROR');
  }

  // Manual version refresh function
  window.refreshSCVersion = async function() {
    logActivity('Manual version refresh requested...');
    // Clear cache first
    localStorage.removeItem('scVersion');
    localStorage.removeItem('scVersionTimestamp');
    await fetchSCVersion();
  };

  // Slugify helper with better normalization
  function slugify(name) {
    if (!name) return '';
    return encodeURIComponent(String(name).trim().toLowerCase()
      .replace(/[^\w\s-]/g, '') // Remove special chars
      .replace(/\s+/g, '-') // Spaces to hyphens
      .replace(/--+/g, '-') // Multiple hyphens to single
      .replace(/^-|-$/g, '')); // Remove leading/trailing hyphens
  }

  // Enhanced ship info fetching with better error handling
  async function getFullShipInfo(shipName) {
    const slug = slugify(shipName);
    logActivity(`Enriching data for ${shipName}...`);
    
    // Try Star Citizen Wiki first (most comprehensive)
    try {
      const url = `https://api.star-citizen.wiki/v2/stats/latest/ship/${slug}`;
      const data = await fetchJsonRetry(url, {}, 2);
      if (data) {
        API_SOURCES.scwiki.ok = true;
        const img = (data.media && data.media[0] && data.media[0].source_url) || 
                   data.image || IMAGE_PLACEHOLDER;
        logActivity(`Enriched ${shipName} from SC Wiki`, 'SUCCESS');
        return {
          source: 'SC Wiki',
          name: data.name || shipName,
          manufacturer: data.manufacturer_name || data.manufacturer || null,
          role: data.classification || data.role || null,
          size: data.size || null,
          image_url: img,
          hp: data.hull_hit_points || data.hull || data.hitpoints || null,
          shield: data.shield_points || data.shields || null,
          cargo: data.cargo_capacity || data.cargo || null,
          hardpoints: data.hardpoints || null,
          value: data.price_in_game || data.price || null,
          raw: data
        };
      }
    } catch (e) {
      API_SOURCES.scwiki.ok = false;
      logActivity(`SC Wiki enrichment failed: ${e.message}`, 'WARNING');
    }

    // Try FleetYards
    try {
      const url = `https://api.fleetyards.net/v1/models?slug=${slug}`;
      const data = await fetchJsonRetry(url, {}, 2);
      if (data && data.length > 0) {
        API_SOURCES.fleetyards.ok = true;
        const ship = data[0];
        const img = ship?.media?.[0]?.source_url || IMAGE_PLACEHOLDER;
        logActivity(`Enriched ${shipName} from FleetYards`, 'SUCCESS');
        return {
          source: 'FleetYards',
          name: ship?.name || shipName,
          manufacturer: ship?.manufacturer?.name || ship?.manufacturer || null,
          role: ship?.classification || ship?.class || null,
          size: ship?.size || null,
          image_url: img,
          hp: null,
          shield: null,
          cargo: ship?.cargo || null,
          hardpoints: ship?.hardpoints || null,
          value: ship?.price || null,
          raw: ship
        };
      }
    } catch (e) {
      API_SOURCES.fleetyards.ok = false;
      logActivity(`FleetYards enrichment failed: ${e.message}`, 'WARNING');
    }

    // Try StarCitizen-API
    try {
      const url = `https://api.starcitizen-api.com/ships/${slug}`;
      const data = await fetchJsonRetry(url, {}, 2);
      if (data) {
        API_SOURCES.scapi.ok = true;
        const img = (data.media && data.media[0] && data.media[0].url) || IMAGE_PLACEHOLDER;
        logActivity(`Enriched ${shipName} from StarCitizen-API`, 'SUCCESS');
        return {
          source: 'StarCitizen-API',
          name: data.displayName || data.name || shipName,
          manufacturer: data.manufacturer || null,
          role: data.role || null,
          size: data.size || null,
          image_url: img,
          hp: data.hull || data.hp || null,
          shield: data.shields || null,
          cargo: data.cargo || null,
          hardpoints: data.hardpoints || null,
          value: data.price || null,
          raw: data
        };
      }
    } catch (e) {
      API_SOURCES.scapi.ok = false;
      logActivity(`StarCitizen-API enrichment failed: ${e.message}`, 'WARNING');
    }

    // Fallback enrichment
    renderApiStatus();
    logActivity(`Could not enrich ${shipName}; using fallback data`, 'WARNING');
    return {
      source: 'Fallback',
      name: shipName,
      manufacturer: null,
      role: null,
      size: null,
      image_url: IMAGE_PLACEHOLDER,
      hp: null,
      shield: null,
      cargo: null,
      hardpoints: null,
      value: null,
      raw: null
    };
  }

  // Enhanced image fetching with multiple attempts
  async function getImageForName(name, kind = 'ship') {
    if (!name) return IMAGE_PLACEHOLDER;
    
    const slug = slugify(name);
    
    // Try different endpoints based on type
    const endpoints = kind === 'ship' ? [
      `https://api.star-citizen.wiki/v2/stats/latest/ship/${slug}`,
      `https://api.fleetyards.net/v1/models?slug=${slug}`,
      `https://api.starcitizen-api.com/ships/${slug}`
    ] : [
      `https://api.star-citizen.wiki/v2/stats/latest/item/${slug}`,
      `https://api.fleetyards.net/v1/components?slug=${slug}`
    ];

    for (const endpoint of endpoints) {
      try {
        const data = await fetchJsonRetry(endpoint, {}, 1);
        if (data) {
          let img = null;
          if (Array.isArray(data) && data.length > 0) {
            img = data[0]?.media?.[0]?.source_url || data[0]?.image;
          } else {
            img = data.media?.[0]?.source_url || data.image;
          }
          if (img && img !== IMAGE_PLACEHOLDER) return img;
        }
      } catch (e) {
        continue;
      }
    }
    
    return IMAGE_PLACEHOLDER;
  }

  // Enhanced default ship data
  async function getDefaultShipData(shipName) {
    const defaults = {
      'Idris-M': { manufacturer: 'Aegis Dynamics', role: 'Military', size: 'Capital', value: 25000000 },
      'Idris-P': { manufacturer: 'Aegis Dynamics', role: 'Military', size: 'Capital', value: 15000000 },
      'Gladius': { manufacturer: 'Aegis Dynamics', role: 'Military', size: 'Small', value: 1617600 },
      'Hull-D': { manufacturer: 'MISC', role: 'Industrial', size: 'Large', value: 7435000 },
      'Cutlass Black': { manufacturer: 'Drake Interplanetary', role: 'Civilian', size: 'Medium', value: 1617600 },
      'Aurora MR': { manufacturer: 'Roberts Space Industries', role: 'Civilian', size: 'Small', value: 316800 },
      'Constellation Andromeda': { manufacturer: 'Roberts Space Industries', role: 'Civilian', size: 'Large', value: 5151360 },
      '300i': { manufacturer: 'Origin Jumpworks', role: 'Civilian', size: 'Small', value: 1020600 }
    };
    return defaults[shipName] || { 
      manufacturer: 'Unknown', 
      role: 'Other', 
      size: 'Medium', 
      value: 1000000 
    };
  }

  function getDefaultLoadout(shipName) {
    const defaults = {
      'Idris-M': 'Size 10 spinal railgun, 7x manned turrets, 2x torpedo tubes, point defense systems',
      'Idris-P': '6x manned turrets, 2x missile racks, hangar bay for fighters',
      'Gladius': '3x S3 weapon hardpoints, 2x S2 missile racks, standard factory configuration',
      'Hull-D': 'Minimal defensive systems, maximum cargo configuration',
      'Cutlass Black': '6x S3 weapon hardpoints, 2x S2 missile racks, utility mount',
      'Aurora MR': '2x S1 weapon hardpoints, basic civilian loadout',
      'Constellation Andromeda': '4x S4 gimbaled mounts, 2x S2 turrets, 52x S2 missiles',
      '300i': '1x S3 nose mount, luxury civilian configuration'
    };
    return defaults[shipName] || 'Factory standard configuration';
  }

  // Enhanced reliability scoring
  function getReliabilityClass(score) {
    const s = Number(score || 0);
    if (s >= 0.9) return 'reliability-green';
    if (s >= 0.7) return 'reliability-yellow';
    return 'reliability-red';
  }

  // Add Ship with enhanced validation
  document.getElementById('add-ship-btn').addEventListener('click', addShip);
  async function addShip() {
    const name = document.getElementById('ship-name').value?.trim();
    if (!name) { 
      alert('⚠️ Ship name is required'); 
      document.getElementById('ship-name').focus();
      return; 
    }
    
    // Check if ship already exists
    const existing = await db.ships.get(name);
    if (existing) {
      if (!confirm(`Ship "${name}" already exists. Update quantity instead?`)) return;
      await db.ships.update(name, { owned_qty: existing.owned_qty + 1 });
      logActivity(`Updated quantity for existing ship: ${name}`, 'SUCCESS');
      await updateDashboard();
      return;
    }
    
    logActivity(`Adding new ship: ${name}...`);
    
    const userLoadout = document.getElementById('ship-loadout').value?.trim();
    const imageUrlInput = document.getElementById('ship-image').value?.trim();
    const defaultData = await getDefaultShipData(name);
    
    // Enhanced enrichment
    let enriched = null;
    try {
      enriched = await getFullShipInfo(name);
    } catch (e) {
      logActivity(`Enrichment failed for ${name}: ${e.message}`, 'WARNING');
    }
    
    const imageUrl = imageUrlInput || 
                    (enriched?.image_url && enriched.image_url !== IMAGE_PLACEHOLDER ? enriched.image_url : null) ||
                    await getImageForName(name, 'ship') || 
                    IMAGE_PLACEHOLDER;
    
    const loadoutValue = userLoadout || getDefaultLoadout(name);
    const loadoutSource = userLoadout ? 'user' : 'default';
    
    await db.ships.put({
      name,
      manufacturer: document.getElementById('ship-manufacturer').value || 
                   enriched?.manufacturer || 
                   defaultData.manufacturer,
      role: document.getElementById('ship-role').value || 
            enriched?.role || 
            defaultData.role,
      size: document.getElementById('ship-size').value || 
            enriched?.size || 
            defaultData.size,
      value: enriched?.value || defaultData.value || 0,
      owned_qty: parseInt(document.getElementById('ship-qty').value) || 1,
      location: document.getElementById('ship-location').value || 'Unknown',
      loadout: loadoutValue,
      _loadout_source: loadoutSource,
      notes: document.getElementById('ship-notes').value || '',
      last_sync: Date.now(),
      data_reliability_score: enriched ? 1.0 : 0.5,
      image_url: imageUrl,
      hp: enriched?.hp || null,
      shield: enriched?.shield || null,
      cargo: enriched?.cargo || null,
      hardpoints_json: enriched?.hardpoints ? JSON.stringify(enriched.hardpoints) : null,
      enriched_version: currentSCVersion
    });
    
    await logAudit('Add Ship', name, { enriched: !!enriched, source: enriched?.source || 'Manual' });
    logActivity(`Successfully added ship: ${name}`, 'SUCCESS');
    
    // Clear form
    document.querySelectorAll('#add input, #add select').forEach(input => {
      if (input.type === 'number') input.value = input.id.includes('qty') ? '1' : '';
      else if (input.tagName === 'SELECT') input.selectedIndex = 0;
      else input.value = '';
    });
    
    await updateDashboard();
  }

  // Enhanced Add Item
  document.getElementById('add-item-btn').addEventListener('click', addItem);
  async function addItem() {
    const name = document.getElementById('item-name').value?.trim();
    if (!name) { 
      alert('⚠️ Item name is required'); 
      document.getElementById('item-name').focus();
      return; 
    }
    
    logActivity(`Adding new item: ${name}...`);
    
    const imageUrl = await getImageForName(name, 'item');
    const id = await db.items.add({
      name,
      type: document.getElementById('item-type').value || 'component',
      size: document.getElementById('item-size').value || '',
      owned_qty: parseInt(document.getElementById('item-qty').value) || 1,
      value: 0, // Will be updated by trading system
      location: document.getElementById('item-location').value || 'Unknown',
      acquired_date: new Date(),
      buy_price: parseFloat(document.getElementById('item-buy-price').value) || 0,
      data_reliability_score: 0.7,
      notes: document.getElementById('item-notes').value || '',
      image_url: imageUrl
    });
    
    await logAudit('Add Item', name, { id, type: document.getElementById('item-type').value });
    logActivity(`Successfully added item: ${name} (ID: ${id})`, 'SUCCESS');
    
    // Clear form
    document.querySelectorAll('#add input:not([type="number"]), #add select').forEach(input => {
      if (input.tagName === 'SELECT') input.selectedIndex = 0;
      else input.value = '';
    });
    document.querySelectorAll('#add input[type="number"]').forEach(input => {
      input.value = input.id.includes('qty') ? '1' : '';
    });
    
    await updateDashboard();
    await updateTrading();
  }

  // Enhanced audit logging
  async function logAudit(action, itemName, changes) {
    try {
      await db.audit_log.add({
        timestamp: new Date(),
        source: action,
        item_name: itemName,
        changes: JSON.stringify(changes),
        verified: true
      });
    } catch (e) {
      console.warn('Audit logging failed:', e);
    }
  }

  // Enhanced trading analysis
  async function updateTrading() {
    const tbody = document.querySelector('#trading-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    
    const items = await db.items.toArray();
    const commodities = items.filter(i => i.type === 'commodity' && i.owned_qty > 0);
    
    if (commodities.length === 0) {
      const tr = tbody.insertRow();
      tr.innerHTML = '<td colspan="6" style="text-align: center; color: #888;">No commodities in inventory. Add some commodities to see trading opportunities.</td>';
      return;
    }
    
    for (const commodity of commodities) {
      const buyPrice = commodity.buy_price || 0;
      let sellPrice = buyPrice * 1.15; // Default 15% markup
      let bestPort = 'Area18 Trade Center';
      let profitMargin = 'Low';
      
      // Try to get real market data from UEX if available
      try {
        const uexKey = localStorage.getItem('uexKey');
        const headers = uexKey ? { 'Authorization': `Bearer ${uexKey}` } : {};
        
        const response = await fetchWithTimeout(
          `https://uexcorp.space/api/2.0/commodities_prices?name=${encodeURIComponent(commodity.name)}`, 
          { headers }, 
          { timeout: 5000 }
        );
        
        if (response.ok) {
          const data = await response.json();
          if (data.sell_price) {
            sellPrice = data.sell_price;
            bestPort = data.best_location || bestPort;
            API_SOURCES.uex.ok = true;
          }
        }
      } catch (err) {
        API_SOURCES.uex.ok = false;
        // Use fallback calculation
        sellPrice = Math.round(buyPrice * (1.1 + Math.random() * 0.3)); // 10-40% markup
      }
      
      const totalProfit = Math.round((sellPrice - buyPrice) * commodity.owned_qty);
      const profitPerUnit = Math.round(sellPrice - buyPrice);
      
      // Determine alert level
      let alert = '';
      if (totalProfit > 10000) alert = '🚀 High Profit!';
      else if (totalProfit > 5000) alert = '💰 Good Profit';
      else if (totalProfit < 0) alert = '⚠️ Loss Risk';
      
      const tr = tbody.insertRow();
      tr.insertCell().textContent = commodity.name;
      tr.insertCell().textContent = commodity.owned_qty;
      tr.insertCell().textContent = bestPort;
      tr.insertCell().textContent = `${sellPrice.toLocaleString()} aUEC`;
      
      const profitCell = tr.insertCell();
      profitCell.textContent = `${totalProfit.toLocaleString()} aUEC (${profitPerUnit.toLocaleString()}/unit)`;
      profitCell.style.color = totalProfit > 0 ? '#00FF88' : '#FF4500';
      
      const alertCell = tr.insertCell();
      alertCell.textContent = alert;
      if (alert.includes('🚀')) alertCell.style.color = '#00FF88';
      else if (alert.includes('💰')) alertCell.style.color = '#FFFF66';
      else if (alert.includes('⚠️')) alertCell.style.color = '#FF4500';
    }
  }

  // Enhanced wishlist management
  document.getElementById('add-wishlist-btn').addEventListener('click', addToWishlist);
  
  async function updateWishlistTable() {
    const tbody = document.querySelector('#wishlist-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    
    const wishlist = await db.wishlist.toArray();
    
    if (wishlist.length === 0) {
      const tr = tbody.insertRow();
      tr.innerHTML = '<td colspan="5" style="text-align: center; color: #888;">No items in wishlist. Add ships or items you want to track.</td>';
      return;
    }
    
    for (const item of wishlist) {
      const tr = tbody.insertRow();
      tr.insertCell().textContent = item.name;
      tr.insertCell().textContent = item.type;
      
      const priceCell = tr.insertCell();
      priceCell.textContent = item.target_price ? `${item.target_price.toLocaleString()} aUEC` : 'Any Price';
      
      tr.insertCell().textContent = item.notes || '';
      
      const actionsCell = tr.insertCell();
      const removeBtn = document.createElement('button');
      removeBtn.textContent = '🗑️ Remove';
      removeBtn.style.background = 'rgba(255,69,0,0.2)';
      removeBtn.style.borderColor = '#FF4500';
      removeBtn.style.color = '#FF4500';
      removeBtn.addEventListener('click', () => removeWishlist(item.name));
      actionsCell.appendChild(removeBtn);
    }
  }
  
  async function addToWishlist() {
    const name = document.getElementById('wishlist-name').value?.trim();
    const type = document.getElementById('wishlist-type').value;
    const target = parseFloat(document.getElementById('wishlist-target-price').value) || 0;
    const notes = document.getElementById('wishlist-notes').value?.trim() || '';
    
    if (!name) { 
      alert('⚠️ Item/Ship name is required'); 
      document.getElementById('wishlist-name').focus();
      return; 
    }
    
    // Check if already in wishlist
    const existing = await db.wishlist.get(name);
    if (existing) {
      alert(`"${name}" is already in your wishlist.`);
      return;
    }
    
    await db.wishlist.put({ name, type, target_price: target, notes });
    logActivity(`Added to wishlist: ${name} (${type})`, 'SUCCESS');
    
    // Clear form
    document.getElementById('wishlist-name').value = '';
    document.getElementById('wishlist-target-price').value = '';
    document.getElementById('wishlist-notes').value = '';
    
    await updateWishlistTable();
  }
  
  async function removeWishlist(name) {
    if (!confirm(`Remove "${name}" from wishlist?`)) return;
    await db.wishlist.delete(name);
    logActivity(`Removed from wishlist: ${name}`, 'SUCCESS');
    await updateWishlistTable();
  }

  // Enhanced dashboard with better metrics
  async function updateDashboard() {
    const ships = await db.ships.toArray();
    const items = await db.items.toArray();
    
    // Update basic counts
    document.getElementById('ship-count').textContent = ships.length;
    document.getElementById('item-count').textContent = items.length;
    
    // Calculate fleet value
    const totalValue = ships.reduce((sum, ship) => sum + ((ship.value || 0) * (ship.owned_qty || 1)), 0);
    document.getElementById('fleet-value').textContent = `${totalValue.toLocaleString()} aUEC`;
    
    // Calculate average data quality
    const allAssets = [...ships, ...items];
    const avgReliability = allAssets.length > 0 ? 
      allAssets.reduce((sum, asset) => sum + (asset.data_reliability_score || 0), 0) / allAssets.length : 0;
    document.getElementById('data-quality').textContent = `${Math.round(avgReliability * 100)}%`;
    
    const tableBody = document.querySelector('#stats-table tbody');
    tableBody.innerHTML = '';

    // Add ships first
    for (const ship of ships.sort((a, b) => (a.name || '').localeCompare(b.name || ''))) {
      await addRowToTable(tableBody, ship, 'ship');
    }
    
    // Add items
    for (const item of items.sort((a, b) => (a.name || '').localeCompare(b.name || ''))) {
      await addRowToTable(tableBody, item, 'item');
    }
  }

  // Enhanced row creation with better error handling
  async function addRowToTable(tableBody, item, type) {
    try {
      const row = tableBody.insertRow();
      
      // Image cell
      const imageCell = row.insertCell();
      let displayImage = item.image_url || IMAGE_PLACEHOLDER;
      
      // Auto-enrich ships if needed
      if (type === 'ship') {
        const needsEnrich = !item.image_url || 
                           !item.hp || 
                           item.enriched_version !== currentSCVersion;
        
        if (needsEnrich) {
          try {
            const enriched = await getFullShipInfo(item.name);
            const updateObj = {
              manufacturer: enriched.manufacturer || item.manufacturer,
              role: enriched.role || item.role,
              size: enriched.size || item.size,
              image_url: enriched.image_url || item.image_url || IMAGE_PLACEHOLDER,
              hp: enriched.hp ?? item.hp,
              shield: enriched.shield ?? item.shield,
              cargo: enriched.cargo ?? item.cargo,
              hardpoints_json: enriched.hardpoints ? JSON.stringify(enriched.hardpoints) : item.hardpoints_json,
              value: enriched.value ?? item.value,
              last_sync: Date.now(),
              data_reliability_score: 1.0,
              enriched_version: currentSCVersion
            };
            
            // Preserve user loadout
            if (item._loadout_source !== 'user') {
              updateObj.loadout = item.loadout || getDefaultLoadout(item.name);
              updateObj._loadout_source = item._loadout_source || 'default';
            }
            
            await db.ships.update(item.name, updateObj);
            item = { ...item, ...updateObj };
            displayImage = item.image_url;
          } catch (e) {
            console.warn('Row enrichment failed:', e);
          }
        }
      }

      if (displayImage && displayImage !== IMAGE_PLACEHOLDER) {
        const img = document.createElement('img');
        img.src = displayImage;
        img.loading = 'lazy';
        img.classList.add('ship-image');
        img.alt = item.name || 'Asset image';
        img.addEventListener('error', () => {
          img.src = IMAGE_PLACEHOLDER;
        });
        imageCell.appendChild(img);
      } else {
        imageCell.innerHTML = '<div style="width:120px; height:60px; background:#333; display:flex; align-items:center; justify-content:center; font-size:0.8em; color:#666;">No Image</div>';
      }

      // Name cell with link
      const nameCell = row.insertCell();
      const nameLink = document.createElement('span');
      nameLink.classList.add('name-link');
      nameLink.textContent = item.name || 'Unnamed';
      nameLink.addEventListener('click', () => showDetail(item, type));
      nameCell.appendChild(nameLink);

      // Other cells
      row.insertCell().textContent = type === 'ship' ? (item.manufacturer || 'Unknown') : (item.type || 'Unknown');
      row.insertCell().textContent = item.role || '';
      row.insertCell().textContent = item.size || '';
      row.insertCell().textContent = type === 'ship' ? (item.hp != null ? item.hp.toLocaleString() : 'N/A') : '';
      row.insertCell().textContent = type === 'ship' ? (item.shield != null ? item.shield.toLocaleString() : 'N/A') : '';
      row.insertCell().textContent = type === 'ship' ? (item.cargo != null ? item.cargo.toLocaleString() : 'N/A') : '';
      row.insertCell().textContent = item.owned_qty || 0;
      row.insertCell().textContent = item.location || 'Unknown';
      
      const loadoutCell = row.insertCell();
      const loadoutText = type === 'ship' ? (item.loadout || item.notes || '') : (item.notes || '');
      loadoutCell.textContent = loadoutText.length > 50 ? loadoutText.substring(0, 47) + '...' : loadoutText;
      loadoutCell.title = loadoutText; // Show full text on hover
      
      const relCell = row.insertCell();
      const relScore = typeof item.data_reliability_score === 'number' ? item.data_reliability_score : 0;
      const relClass = getReliabilityClass(relScore);
      relCell.classList.add(relClass);
      relCell.textContent = `${Math.round(relScore * 100)}%`;

      const actionsCell = row.insertCell();
      const editBtn = document.createElement('button');
      editBtn.textContent = '✏️';
      editBtn.title = 'Edit';
      editBtn.style.marginRight = '5px';
      editBtn.addEventListener('click', () => {
        const key = type === 'ship' ? item.name : item.id;
        editItem(type, String(key));
      });
      
      const delBtn = document.createElement('button');
      delBtn.textContent = '🗑️';
      delBtn.title = 'Delete';
      delBtn.style.background = 'rgba(255,69,0,0.2)';
      delBtn.style.borderColor = '#FF4500';
      delBtn.style.color = '#FF4500';
      delBtn.addEventListener('click', () => {
        const key = type === 'ship' ? item.name : item.id;
        deleteItem(type, String(key));
      });
      
      actionsCell.appendChild(editBtn);
      actionsCell.appendChild(delBtn);
      
    } catch (e) {
      console.error('Failed to add row to table:', e);
      logActivity(`Failed to display ${type}: ${item.name || 'Unknown'}`, 'ERROR');
    }
  }

  // Enhanced detail view
  async function showDetail(item, type) {
    currentDetailItem = item;
    currentDetailType = type;
    
    // Switch to detail view
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    document.getElementById('detail').classList.add('active');
    
    document.getElementById('detail-header').innerHTML = 
      `${type === 'ship' ? '🚀' : '📦'} ${type.charAt(0).toUpperCase() + type.slice(1)}: ${item.name}`;
    
    const updateBtn = document.getElementById('update-ship-btn');
    const resetBtn = document.getElementById('reset-ship-btn');
    updateBtn.style.display = type === 'ship' ? 'inline-block' : 'none';
    resetBtn.style.display = type === 'ship' ? 'inline-block' : 'none';
    
    logActivity(`Opening detail view for ${item.name} (${type})`);

    // Enhanced enrichment for detail view
    if (type === 'ship') {
      try {
        const enriched = await getFullShipInfo(item.name);
        if (enriched.source !== 'Fallback') {
          const updateObj = {
            manufacturer: enriched.manufacturer || item.manufacturer,
            role: enriched.role || item.role,
            size: enriched.size || item.size,
            image_url: enriched.image_url || item.image_url || IMAGE_PLACEHOLDER,
            hp: enriched.hp ?? item.hp,
            shield: enriched.shield ?? item.shield,
            cargo: enriched.cargo ?? item.cargo,
            hardpoints_json: enriched.hardpoints ? JSON.stringify(enriched.hardpoints) : item.hardpoints_json,
            value: enriched.value ?? item.value,
            last_sync: Date.now(),
            data_reliability_score: 1.0,
            enriched_version: currentSCVersion
          };
          
          if (item._loadout_source !== 'user') {
            updateObj.loadout = item.loadout || getDefaultLoadout(item.name);
            updateObj._loadout_source = 'default';
          }
          
          await db.ships.update(item.name, updateObj);
          item = await db.ships.get(item.name);
          logActivity(`Enriched ${item.name} in detail view from ${enriched.source}`, 'SUCCESS');
        }
      } catch (e) {
        logActivity(`Detail enrichment failed for ${item.name}: ${e.message}`, 'WARNING');
      }
    }

    const detailInfo = document.getElementById('detail-info');
    detailInfo.innerHTML = '';
    
    const displayImage = item.image_url || IMAGE_PLACEHOLDER;
    
    detailInfo.innerHTML += `
      <div class="detail-card">
        <h4>🖼️ Image</h4>
        <img src="${displayImage}" style="width:100%; max-width:400px; height:auto; border-radius:4px;" 
             onerror="this.src='${IMAGE_PLACEHOLDER}'" alt="${item.name}">
      </div>
    `;

    if (type === 'ship') {
      detailInfo.innerHTML += `
        <div class="detail-card"><h4>🏭 Manufacturer</h4><p>${item.manufacturer || 'Unknown'}</p></div>
        <div class="detail-card"><h4>🎯 Role</h4><p>${item.role || 'Unknown'}</p></div>
        <div class="detail-card"><h4>📏 Size Class</h4><p>${item.size || 'Unknown'}</p></div>
        <div class="detail-card"><h4>❤️ Hull Points</h4><p>${item.hp != null ? item.hp.toLocaleString() : 'Unknown'}</p></div>
        <div class="detail-card"><h4>🛡️ Shield Points</h4><p>${item.shield != null ? item.shield.toLocaleString() : 'Unknown'}</p></div>
        <div class="detail-card"><h4>📦 Cargo Capacity</h4><p>${item.cargo != null ? `${item.cargo} SCU` : 'Unknown'}</p></div>
        <div class="detail-card"><h4>💎 Estimated Value</h4><p>${item.value ? `${item.value.toLocaleString()} aUEC` : 'Unknown'}</p></div>
        <div class="detail-card"><h4>🔢 Quantity Owned</h4><p>${item.owned_qty || 1}</p></div>
        <div class="detail-card"><h4>📍 Location</h4><p>${item.location || 'Unknown'}</p></div>
      `;
      
      if (item.hardpoints_json) {
        try {
          const hardpoints = JSON.parse(item.hardpoints_json);
          detailInfo.innerHTML += `
            <div class="detail-card" style="grid-column: span 2;">
              <h4>🔧 Hardpoints</h4>
              <pre style="white-space: pre-wrap; color:#00FFFF; font-size:0.9em; max-height:200px; overflow-y:auto;">${JSON.stringify(hardpoints, null, 2)}</pre>
            </div>
          `;
        } catch (e) {
          console.warn('Failed to parse hardpoints JSON:', e);
        }
      }
      
      detailInfo.innerHTML += `
        <div class="detail-card" style="grid-column: span 2;">
          <h4>⚙️ Loadout Configuration</h4>
          <p>${item.loadout || 'No loadout configured'}</p>
          <small style="color:#888;">${item._loadout_source === 'user' ? 'Custom loadout' : 'Default configuration'}</small>
        </div>
        <div class="detail-card">
          <h4>📝 Additional Notes</h4>
          <p>${item.notes || 'No additional notes'}</p>
        </div>
        <div class="detail-card">
          <h4>🎯 Data Reliability</h4>
          <p class="${getReliabilityClass(item.data_reliability_score ?? 0)}">${Math.round((item.data_reliability_score ?? 0) * 100)}%</p>
          <small style="color:#888;">Last updated: ${item.last_sync ? new Date(item.last_sync).toLocaleString() : 'Never'}</small>
        </div>
        <div class="detail-card">
          <h4>🌟 Version Sync</h4>
          <p>${item.enriched_version || 'Unknown'}</p>
          <small style="color:#888;">Current: ${currentSCVersion}</small>
        </div>
      `;
    } else {
      detailInfo.innerHTML += `
        <div class="detail-card"><h4>📛 Name</h4><p>${item.name}</p></div>
        <div class="detail-card"><h4>📦 Type</h4><p>${item.type || 'Unknown'}</p></div>
        <div class="detail-card"><h4>📏 Size</h4><p>${item.size || 'Unknown'}</p></div>
        <div class="detail-card"><h4>🔢 Quantity</h4><p>${item.owned_qty || 0}</p></div>
        <div class="detail-card"><h4>📍 Location</h4><p>${item.location || 'Unknown'}</p></div>
        <div class="detail-card"><h4>💰 Buy Price</h4><p>${item.buy_price != null ? `${item.buy_price.toLocaleString()} aUEC` : 'Unknown'}</p></div>
        <div class="detail-card"><h4>📅 Acquired Date</h4><p>${item.acquired_date ? new Date(item.acquired_date).toLocaleDateString() : 'Unknown'}</p></div>
        <div class="detail-card" style="grid-column: span 2;">
          <h4>📝 Notes</h4>
          <p>${item.notes || 'No notes'}</p>
        </div>
        <div class="detail-card">
          <h4>🎯 Data Reliability</h4>
          <p class="${getReliabilityClass(item.data_reliability_score ?? 0)}">${Math.round((item.data_reliability_score ?? 0) * 100)}%</p>
        </div>
      `;
    }
  }

  // Navigation back to dashboard
  function goBackToDashboard() {
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    document.getElementById('dashboard').classList.add('active');
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelector('.nav-tab[data-tab="dashboard"]').classList.add('active');
    currentDetailItem = null;
    currentDetailType = null;
    logActivity('Returned to dashboard');
  }

  // Edit and Delete functionality (enhanced error handling)
  async function editItem(type, idOrName) {
    const modal = document.getElementById('edit-modal');
    modal.style.display = 'block';
    editingItemKind = type;
    
    if (type === 'ship') {
      const ship = await db.ships.get(idOrName);
      if (!ship) { 
        alert('❌ Ship not found'); 
        return; 
      }
      editingItemKey = ship.name;
      document.getElementById('edit-name').value = ship.name;
      document.getElementById('edit-manufacturer').value = ship.manufacturer || '';
      document.getElementById('edit-role').value = ship.role || '';
      document.getElementById('edit-size').value = ship.size || '';
      document.getElementById('edit-qty').value = ship.owned_qty || 1;
      document.getElementById('edit-location').value = ship.location || '';
      document.getElementById('edit-loadout').value = ship.loadout || '';
      document.getElementById('edit-notes').value = ship.notes || '';
      document.getElementById('edit-image').value = ship.image_url || '';
      document.getElementById('edit-buy-price').value = '';
      document.getElementById('edit-type').style.display = 'none';
    } else {
      const itemId = Number(idOrName);
      const item = await db.items.get(itemId);
      if (!item) { 
        alert('❌ Item not found'); 
        return; 
      }
      editingItemKey = item.id;
      document.getElementById('edit-name').value = item.name;
      document.getElementById('edit-manufacturer').value = item.type || '';
      document.getElementById('edit-role').value = '';
      document.getElementById('edit-size').value = item.size || '';
      document.getElementById('edit-qty').value = item.owned_qty || 1;
      document.getElementById('edit-location').value = item.location || '';
      document.getElementById('edit-loadout').value = '';
      document.getElementById('edit-notes').value = item.notes || '';
      document.getElementById('edit-image').value = item.image_url || '';
      document.getElementById('edit-buy-price').value = item.buy_price || 0;
      document.getElementById('edit-type').style.display = 'block';
      document.getElementById('edit-type').value = item.type || 'component';
    }
  }

  async function deleteItem(type, idOrName) {
    const itemName = type === 'ship' ? idOrName : `Item ID ${idOrName}`;
    if (!confirm(`⚠️ Are you sure you want to delete "${itemName}"? This action cannot be undone.`)) return;
    
    try {
      if (type === 'ship') {
        await db.ships.delete(idOrName);
        logActivity(`Deleted ship: ${idOrName}`, 'SUCCESS');
      } else {
        const itemId = Number(idOrName);
        const item = await db.items.get(itemId);
        await db.items.delete(itemId);
        logActivity(`Deleted item: ${item?.name || itemId}`, 'SUCCESS');
      }
      
      await updateDashboard();
      if (type !== 'ship') await updateTrading();
      
      alert('✅ Item deleted successfully');
    } catch (e) {
      console.error('Delete failed:', e);
      logActivity(`Delete failed for ${itemName}: ${e.message}`, 'ERROR');
      alert('❌ Delete failed. Please try again.');
    }
  }

  // Enhanced save edit functionality
  document.getElementById('save-edit').addEventListener('click', async () => {
    if (!editingItemKind || editingItemKey == null) { 
      alert('❌ No item selected for editing'); 
      return; 
    }
    
    try {
      if (editingItemKind === 'ship') {
        const updates = {
          manufacturer: document.getElementById('edit-manufacturer').value || '',
          role: document.getElementById('edit-role').value || '',
          size: document.getElementById('edit-size').value || '',
          owned_qty: Math.max(1, parseInt(document.getElementById('edit-qty').value) || 1),
          location: document.getElementById('edit-location').value || '',
          notes: document.getElementById('edit-notes').value || '',
          image_url: document.getElementById('edit-image').value || IMAGE_PLACEHOLDER,
          last_sync: Date.now()
        };
        
        const newLoadout = document.getElementById('edit-loadout').value?.trim();
        if (newLoadout) {
          updates.loadout = newLoadout;
          updates._loadout_source = 'user';
        }
        
        await db.ships.update(editingItemKey, updates);
        logActivity(`Updated ship: ${editingItemKey}`, 'SUCCESS');
      } else {
        const itemId = Number(editingItemKey);
        const updates = {
          type: document.getElementById('edit-type').value || 'component',
          size: document.getElementById('edit-size').value || '',
          owned_qty: Math.max(1, parseInt(document.getElementById('edit-qty').value) || 1),
          location: document.getElementById('edit-location').value || '',
          notes: document.getElementById('edit-notes').value || '',
          buy_price: Math.max(0, parseFloat(document.getElementById('edit-buy-price').value) || 0),
          image_url: document.getElementById('edit-image').value || ''
        };
        
        await db.items.update(itemId, updates);
        logActivity(`Updated item ID: ${itemId}`, 'SUCCESS');
      }
      
      await updateDashboard();
      if (editingItemKind !== 'ship') await updateTrading();
      closeModal();
      alert('✅ Changes saved successfully!');
      
    } catch (e) {
      console.error('Save failed:', e);
      logActivity(`Save failed: ${e.message}`, 'ERROR');
      alert('❌ Failed to save changes. Please try again.');
    }
  });

  function closeModal() {
    document.getElementById('edit-modal').style.display = 'none';
    editingItemKey = null;
    editingItemKind = null;
  }

  // Modal close handlers
  document.querySelector('#edit-modal .close').addEventListener('click', closeModal);
  window.addEventListener('click', (e) => {
    if (e.target === document.getElementById('edit-modal')) closeModal();
  });

  // Enhanced search functionality
  document.getElementById('perform-search-btn').addEventListener('click', performSearch);
  document.getElementById('clear-search-btn').addEventListener('click', clearSearch);

  async function performSearch() {
    const query = document.getElementById('search-query').value?.toLowerCase().trim() || '';
    const typeFilter = document.getElementById('search-filter-type').value;
    const manufFilter = document.getElementById('search-filter-manufacturer').value?.toLowerCase().trim() || '';
    const roleFilter = document.getElementById('search-filter-role').value;
    const sizeFilter = document.getElementById('search-filter-size').value;
    const locationFilter = document.getElementById('search-filter-location').value?.toLowerCase().trim() || '';

    logActivity(`Performing search: "${query}" with filters`);

    const results = [];
    const ships = await db.ships.toArray();
    const items = await db.items.toArray();

    // Search ships
    ships.forEach(ship => {
      let match = true;
      if (query && !(ship.name || '').toLowerCase().includes(query)) match = false;
      if (manufFilter && !(ship.manufacturer || '').toLowerCase().includes(manufFilter)) match = false;
      if (roleFilter && ship.role !== roleFilter) match = false;
      if (sizeFilter && ship.size !== sizeFilter) match = false;
      if (locationFilter && !(ship.location || '').toLowerCase().includes(locationFilter)) match = false;
      if (typeFilter && typeFilter !== 'ship') match = false;
      if (match) results.push({ ...ship, __kind: 'ship' });
    });

    // Search items
    items.forEach(item => {
      let match = true;
      if (query && !(item.name || '').toLowerCase().includes(query)) match = false;
      if (typeFilter && typeFilter !== '' && typeFilter !== item.type) match = false;
      if (manufFilter && !(item.type || '').toLowerCase().includes(manufFilter)) match = false;
      if (roleFilter && item.role && item.role !== roleFilter) match = false;
      if (sizeFilter && item.size !== sizeFilter) match = false;
      if (locationFilter && !(item.location || '').toLowerCase().includes(locationFilter)) match = false;
      if (match) results.push({ ...item, __kind: 'item' });
    });

    // Populate results table
    const tbody = document.querySelector('#search-table tbody');
    tbody.innerHTML = '';
    
    if (results.length === 0) {
      const tr = tbody.insertRow();
      tr.innerHTML = '<td colspan="10" style="text-align: center; color: #888;">No results found. Try adjusting your search criteria.</td>';
    } else {
      for (const result of results) {
        await addSearchResultRow(tbody, result);
      }
    }

    // Switch to search tab
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    document.getElementById('search').classList.add('active');
    
    logActivity(`Search complete: ${results.length} results found`, 'SUCCESS');
  }

  async function addSearchResultRow(tbody, result) {
    const tr = tbody.insertRow();
    
    // Image
    const imgCell = tr.insertCell();
    const displayImage = result.image_url || IMAGE_PLACEHOLDER;
    if (displayImage && displayImage !== IMAGE_PLACEHOLDER) {
      const img = document.createElement('img');
      img.src = displayImage;
      img.classList.add('ship-image');
      img.loading = 'lazy';
      img.addEventListener('error', () => img.src = IMAGE_PLACEHOLDER);
      imgCell.appendChild(img);
    } else {
      imgCell.innerHTML = '<div style="width:120px; height:60px; background:#333; display:flex; align-items:center; justify-content:center; font-size:0.8em; color:#666;">No Image</div>';
    }
    
    // Name (clickable)
    const nameCell = tr.insertCell();
    const nameLink = document.createElement('span');
    nameLink.classList.add('name-link');
    nameLink.textContent = result.name;
    nameLink.addEventListener('click', () => showDetail(result, result.__kind === 'ship' ? 'ship' : 'item'));
    nameCell.appendChild(nameLink);
    
    tr.insertCell().textContent = result.__kind === 'ship' ? (result.manufacturer || 'Unknown') : (result.type || 'Unknown');
    tr.insertCell().textContent = result.role || '';
    tr.insertCell().textContent = result.size || '';
    tr.insertCell().textContent = result.owned_qty || 0;
    tr.insertCell().textContent = result.location || 'Unknown';
    
    const loadoutCell = tr.insertCell();
    const loadoutText = result.__kind === 'ship' ? (result.loadout || result.notes || '') : (result.notes || '');
    loadoutCell.textContent = loadoutText.length > 30 ? loadoutText.substring(0, 27) + '...' : loadoutText;
    loadoutCell.title = loadoutText;
    
    const reliabilityCell = tr.insertCell();
    const relScore = Math.round((result.data_reliability_score ?? 0) * 100);
    reliabilityCell.textContent = `${relScore}%`;
    reliabilityCell.classList.add(getReliabilityClass(result.data_reliability_score ?? 0));
    
    // Actions
    const actionsCell = tr.insertCell();
    const key = result.__kind === 'ship' ? result.name : result.id;
    
    const editBtn = document.createElement('button');
    editBtn.textContent = '✏️';
    editBtn.title = 'Edit';
    editBtn.style.marginRight = '5px';
    editBtn.addEventListener('click', () => editItem(result.__kind === 'ship' ? 'ship' : 'item', String(key)));
    
    const delBtn = document.createElement('button');
    delBtn.textContent = '🗑️';
    delBtn.title = 'Delete';
    delBtn.style.background = 'rgba(255,69,0,0.2)';
    delBtn.style.borderColor = '#FF4500';
    delBtn.style.color = '#FF4500';
    delBtn.addEventListener('click', () => deleteItem(result.__kind === 'ship' ? 'ship' : 'item', String(key)));
    
    actionsCell.appendChild(editBtn);
    actionsCell.appendChild(delBtn);
  }

  function clearSearch() {
    document.getElementById('search-query').value = '';
    document.getElementById('search-filter-type').value = '';
    document.getElementById('search-filter-manufacturer').value = '';
    document.getElementById('search-filter-role').value = '';
    document.getElementById('search-filter-size').value = '';
    document.getElementById('search-filter-location').value = '';
    
    const tbody = document.querySelector('#search-table tbody');
    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #888;">Enter search criteria and click Search to find assets.</td></tr>';
    
    logActivity('Search filters cleared');
  }

  // Enhanced sync functionality
  document.getElementById('sync-btn').addEventListener('click', () => syncData(true));
  async function syncData(force = false) {
    if (!navigator.onLine) {
      document.getElementById('offline-banner').style.display = 'block';
      logActivity('Sync aborted: device is offline', 'WARNING');
      return;
    }
    
    document.getElementById('offline-banner').style.display = 'none';
    document.getElementById('sync-status').style.display = 'block';
    
    try {
      logActivity('Starting comprehensive data sync...', 'INFO');
      
      const ships = await db.ships.toArray();
      let syncedCount = 0;
      let failedCount = 0;
      
      for (const ship of ships) {
        const needsSync = !ship.last_sync || 
                         (Date.now() - ship.last_sync > 24 * 60 * 60 * 1000) || 
                         (ship.enriched_version !== currentSCVersion) || 
                         force;
        
        if (needsSync) {
          try {
            logActivity(`Syncing ${ship.name}...`);
            const enriched = await getFullShipInfo(ship.name);
            
            if (enriched.source !== 'Fallback') {
              const updateObj = {
                manufacturer: enriched.manufacturer || ship.manufacturer,
                role: enriched.role || ship.role,
                size: enriched.size || ship.size,
                image_url: enriched.image_url || ship.image_url || IMAGE_PLACEHOLDER,
                hp: enriched.hp ?? ship.hp,
                shield: enriched.shield ?? ship.shield,
                cargo: enriched.cargo ?? ship.cargo,
                hardpoints_json: enriched.hardpoints ? JSON.stringify(enriched.hardpoints) : ship.hardpoints_json,
                value: enriched.value ?? ship.value,
                last_sync: Date.now(),
                data_reliability_score: 1.0,
                enriched_version: currentSCVersion
              };
              
              // Preserve user loadout
              if (ship._loadout_source !== 'user') {
                updateObj.loadout = ship.loadout || getDefaultLoadout(ship.name);
                updateObj._loadout_source = 'default';
              }
              
              await db.ships.update(ship.name, updateObj);
              syncedCount++;
              logActivity(`✅ Synced ${ship.name} from ${enriched.source}`);
            }
          } catch (e) {
            failedCount++;
            logActivity(`❌ Sync failed for ${ship.name}: ${e.message}`, 'WARNING');
          }
        }
      }
      
      // Update displays
      await updateDashboard();
      await updateTrading();
      await updateWishlistTable();
      
      const message = `Sync complete: ${syncedCount} updated, ${failedCount} failed`;
      logActivity(message, syncedCount > 0 ? 'SUCCESS' : 'INFO');
      
    } catch (e) {
      logActivity(`Sync failed: ${e.message}`, 'ERROR');
    } finally {
      document.getElementById('sync-status').style.display = 'none';
      await checkApiHealth(); // Update API status after sync
    }
  }

  // Auto-sync check for background updates
  async function autoSyncIfNeeded() {
    if (!navigator.onLine) return;
    
    const ships = await db.ships.toArray();
    const now = Date.now();
    
    for (const ship of ships) {
      const needsSync = !ship.last_sync || 
                       (now - ship.last_sync > 24 * 60 * 60 * 1000) || 
                       (ship.enriched_version !== currentSCVersion);
      
      if (needsSync) {
        logActivity('Auto-sync triggered for stale data');
        syncData(false).catch(e => logActivity(`Auto-sync failed: ${e.message}`, 'WARNING'));
        break;
      }
    }
  }

  // Enhanced default ships with better data
  async function addDefaultShips() {
    const count = await db.ships.count();
    if (count === 0) {
      logActivity('Adding default fleet ships...');
      
      const defaultShips = [
        { name: 'Idris-M', location: 'Area18 Hangar 3' },
        { name: 'Gladius', location: 'Area18 Hangar 1' },
        { name: 'Hull-D', location: 'Port Olisar Bay 2' }
      ];
      
      for (const defaultShip of defaultShips) {
        try {
          const defaultData = await getDefaultShipData(defaultShip.name);
          const enriched = await getFullShipInfo(defaultShip.name);
          
          await db.ships.put({
            name: defaultShip.name,
            manufacturer: enriched.manufacturer || defaultData.manufacturer,
            role: enriched.role || defaultData.role,
            size: enriched.size || defaultData.size,
            value: enriched.value || defaultData.value,
            owned_qty: 1,
            location: defaultShip.location,
            loadout: getDefaultLoadout(defaultShip.name),
            _loadout_source: 'default',
            notes: 'Default fleet ship',
            image_url: enriched.image_url || IMAGE_PLACEHOLDER,
            hp: enriched.hp || null,
            shield: enriched.shield || null,
            cargo: enriched.cargo || null,
            hardpoints_json: enriched.hardpoints ? JSON.stringify(enriched.hardpoints) : null,
            last_sync: Date.now(),
            data_reliability_score: enriched.source !== 'Fallback' ? 1.0 : 0.5,
            enriched_version: currentSCVersion
          });
          
          logActivity(`Added default ship: ${defaultShip.name}`, 'SUCCESS');
        } catch (e) {
          logActivity(`Failed to add default ship ${defaultShip.name}: ${e.message}`, 'WARNING');
        }
      }
    }
  }

  // Export/Import with better formatting
  document.getElementById('export-btn').addEventListener('click', async () => {
    try {
      const ships = await db.ships.toArray();
      const items = await db.items.toArray();
      const wishlist = await db.wishlist.toArray();
      const settings = {
        userHandle: localStorage.getItem('userHandle') || 'Anonymous',
        scVersion: currentSCVersion,
        lastVersionCheck: lastVersionCheck?.toISOString() || null
      };
      
      const exportData = {
        meta: {
          version: '2.4.0',
          exportedAt: new Date().toISOString(),
          sc_version: currentSCVersion,
          total_ships: ships.length,
          total_items: items.length,
          total_wishlist: wishlist.length
        },
        ships,
        items,
        wishlist,
        settings
      };
      
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sc_fleet_manager_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      
      logActivity(`Exported ${ships.length} ships, ${items.length} items, ${wishlist.length} wishlist items`, 'SUCCESS');
    } catch (e) {
      logActivity(`Export failed: ${e.message}`, 'ERROR');
      alert('❌ Export failed. Please try again.');
    }
  });

  document.getElementById('import-btn').addEventListener('click', () => {
    document.getElementById('import-file').click();
  });

  document.getElementById('import-file').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      logActivity(`Importing data from ${file.name}...`);
      const text = await file.text();
      const data = JSON.parse(text);
      
      let importedShips = 0, importedItems = 0, importedWishlist = 0;
      
      // Import ships
      if (data.ships && Array.isArray(data.ships)) {
        for (const ship of data.ships) {
          if (ship.name) {
            ship._loadout_source = ship._loadout_source || (ship.loadout ? 'user' : 'default');
            await db.ships.put(ship);
            importedShips++;
          }
        }
      }
      
      // Import items
      if (data.items && Array.isArray(data.items)) {
        for (const item of data.items) {
          if (item.name) {
            if (item.id) await db.items.put(item);
            else await db.items.add(item);
            importedItems++;
          }
        }
      }
      
      // Import wishlist
      if (data.wishlist && Array.isArray(data.wishlist)) {
        for (const wish of data.wishlist) {
          if (wish.name) {
            await db.wishlist.put(wish);
            importedWishlist++;
          }
        }
      }
      
      // Import settings if available
      if (data.settings) {
        if (data.settings.userHandle) {
          localStorage.setItem('userHandle', data.settings.userHandle);
          document.getElementById('user-handle').textContent = data.settings.userHandle;
        }
      }
      
      await updateDashboard();
      await updateTrading();
      await updateWishlistTable();
      
      const message = `Import complete: ${importedShips} ships, ${importedItems} items, ${importedWishlist} wishlist entries`;
      logActivity(message, 'SUCCESS');
      alert(`✅ ${message}`);
      
    } catch (err) {
      const errorMsg = `Import failed: ${err.message}`;
      logActivity(errorMsg, 'ERROR');
      alert(`❌ ${errorMsg}`);
    } finally {
      e.target.value = '';
    }
  });

  // Settings handlers with validation
  document.getElementById('save-uex-btn').addEventListener('click', () => {
    const key = document.getElementById('uex-key').value?.trim() || '';
    if (key && key.length < 10) {
      alert('⚠️ UEX API key seems too short. Please verify the key.');
      return;
    }
    localStorage.setItem('uexKey', key);
    logActivity(key ? 'UEX API key saved' : 'UEX API key removed', 'SUCCESS');
    alert(key ? '✅ UEX API key saved!' : '✅ UEX API key removed');
  });

  document.getElementById('save-user-btn').addEventListener('click', () => {
    const handle = document.getElementById('user-handle-input').value?.trim() || '';
    if (handle) {
      if (handle.length > 20) {
        alert('⚠️ Handle too long (max 20 characters)');
        return;
      }
      localStorage.setItem('userHandle', handle);
      document.getElementById('user-handle').textContent = handle;
      logActivity(`User handle updated: ${handle}`, 'SUCCESS');
      alert('✅ Citizen handle saved!');
    } else {
      alert('⚠️ Please enter a handle first');
    }
  });

  // Additional control buttons
  document.getElementById('refresh-version-btn').addEventListener('click', refreshSCVersion);
  document.getElementById('health-check-btn').addEventListener('click', checkApiHealth);
  document.getElementById('test-apis-btn').addEventListener('click', checkApiHealth);
  
  document.getElementById('clear-cache-btn').addEventListener('click', () => {
    if (confirm('⚠️ Clear all cached data? This will force fresh data fetching on next sync.')) {
      localStorage.removeItem('scVersion');
      localStorage.removeItem('scVersionTimestamp');
      logActivity('Cache cleared', 'SUCCESS');
      alert('✅ Cache cleared successfully');
    }
  });

  document.getElementById('backup-data-btn').addEventListener('click', () => {
    document.getElementById('export-btn').click();
  });

  document.getElementById('clear-all-data-btn').addEventListener('click', async () => {
    const confirmation = prompt('⚠️ DANGER: This will delete ALL your data! Type "DELETE ALL" to confirm:');
    if (confirmation === 'DELETE ALL') {
      try {
        await db.ships.clear();
        await db.items.clear();
        await db.wishlist.clear();
        await db.audit_log.clear();
        await db.history.clear();
        localStorage.clear();
        
        logActivity('All data cleared', 'WARNING');
        alert('✅ All data has been cleared. The page will reload.');
        location.reload();
      } catch (e) {
        logActivity(`Data clear failed: ${e.message}`, 'ERROR');
        alert('❌ Failed to clear data. Please try again.');
      }
    }
  });

  // Navigation tab handlers
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const targetTab = tab.getAttribute('data-tab');
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(targetTab).classList.add('active');
      
      logActivity(`Switched to ${targetTab} tab`);
    });
  });

  // Enhanced initialization
  async function init() {
    try {
      logActivity('🚀 Star Citizen Fleet Manager v2.4.0 initializing...', 'INFO');
      
      // Create enhanced starfield
      createStars();
      
      // Load user settings
      const savedHandle = localStorage.getItem('userHandle');
      if (savedHandle) {
        document.getElementById('user-handle').textContent = savedHandle;
      }
      
      // Load saved UEX key if exists
      const savedUexKey = localStorage.getItem('uexKey');
      if (savedUexKey) {
        document.getElementById('uex-key').value = savedUexKey;
      }
      
      // Initialize version and API checks
      await fetchSCVersion();
      checkApiHealth(); // Don't await - run in background
      
      // Set up database and default data
      await addDefaultShips();
      
      // Update all displays
      await updateDashboard();
      await updateWishlistTable();
      await updateTrading();
      
      // Background auto-sync check
      setTimeout(() => {
        autoSyncIfNeeded().catch(e => console.warn('Auto-sync failed:', e));
      }, 2000);
      
      // Set up offline detection
      if (!navigator.onLine) {
        document.getElementById('offline-banner').style.display = 'block';
      }
      
      window.addEventListener('online', () => {
        document.getElementById('offline-banner').style.display = 'none';
        logActivity('Connection restored - online mode', 'SUCCESS');
      });
      
      window.addEventListener('offline', () => {
        document.getElementById('offline-banner').style.display = 'block';
        logActivity('Connection lost - offline mode', 'WARNING');
      });
      
      // Request notification permission if available
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().catch(() => {});
      }
      
      logActivity('✅ Initialization complete - Fleet Manager ready!', 'SUCCESS');
      
    } catch (e) {
      logActivity(`❌ Initialization failed: ${e.message}`, 'ERROR');
      console.error('Initialization error:', e);
    }
  }

  // Enhanced starfield with animation
  function createStars() {
    const starfield = document.querySelector('.starfield');
    starfield.innerHTML = ''; // Clear existing stars
    
    for (let i = 0; i < 300; i++) {
      const star = document.createElement('div');
      star.classList.add('star');
      const size = Math.random() * 3 + 1;
      star.style.width = star.style.height = size + 'px';
      star.style.top = Math.random() * 100 + '%';
      star.style.left = Math.random() * 100 + '%';
      star.style.animationDelay = Math.random() * 3 + 's';
      star.style.animationDuration = (2 + Math.random() * 4) + 's';
      starfield.appendChild(star);
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  </script>
</body>
</html>