<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Star Citizen Fleet Manager v2.3.6</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dexie@3/dist/dexie.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Orbitron', Arial, sans-serif;
            background: radial-gradient(circle, #001022, #000000);
            color: #00FFFF;
            overflow-x: hidden;
            position: relative;
        }
        /* Starfield */
        .starfield {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
        }
        .holo-panel {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00FFFF;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
            border-radius: 8px;
            padding: 20px;
            margin: 20px auto;
            max-width: 1200px;
            backdrop-filter: blur(5px);
            animation: boot-up 1s ease-in-out;
            position: relative;
            z-index: 1;
        }
        @keyframes boot-up {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .header {
            text-align: center;
            text-shadow: 0 0 5px #00FFFF;
            font-size: 2em;
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .version-info {
            font-size: 0.9em;
            color: #00FF88;
            text-shadow: 0 0 3px #00FF88;
            text-align: right;
            line-height: 1.1;
        }
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        .nav-tab {
            padding: 10px 20px;
            margin: 0 5px;
            border: 2px solid #00FFFF;
            border-radius: 5px;
            cursor: pointer;
            transition: box-shadow 0.3s;
        }
        .nav-tab:hover {
            box-shadow: 0 0 15px #00FFFF;
        }
        .nav-tab.active {
            background: rgba(0, 255, 255, 0.2);
            border-bottom: 4px solid #FF4500;
        }
        .content {
            display: none;
        }
        .content.active {
            display: block;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .metric-card {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00FFFF;
            padding: 15px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        .alert {
            color: #FF4500;
            text-shadow: 0 0 5px #FF4500;
        }
        input, select, button {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00FFFF;
            color: #00FFFF;
            padding: 5px;
            margin: 5px;
            font-family: 'Orbitron', Arial, sans-serif;
        }
        button:hover {
            box-shadow: 0 0 10px #00FFFF;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #00FFFF;
            padding: 8px;
            text-align: left;
        }
        th {
            background: rgba(0, 255, 255, 0.1);
            cursor: pointer;
        }
        .reliability-green { color: #00FF88; }
        .reliability-yellow { color: #FFFF66; }
        .reliability-red { color: #FF4500; }
        #offline-banner {
            background: rgba(255, 69, 0, 0.8);
            color: white;
            text-align: center;
            padding: 10px;
            display: none;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .ship-image {
            width: 100px;
            height: auto;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: rgba(0,0,0,0.8);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #00FFFF;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 0 15px #00FFFF;
        }
        .close {
            color: #00FFFF;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #FF4500;
            text-decoration: none;
            cursor: pointer;
        }
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0,0,0,0.8);
            color: #00FFFF;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .detail-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .detail-card {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00FFFF;
            padding: 15px;
            border-radius: 5px;
        }
        .back-button, .update-button, .reset-button {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #FF4500;
            color: #FF4500;
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Orbitron', Arial, sans-serif;
            margin-right: 10px;
        }
        .back-button:hover, .update-button:hover, .reset-button:hover {
            box-shadow: 0 0 10px #FF4500;
        }
        .name-link {
            color: #00FFFF;
            text-decoration: underline;
            cursor: pointer;
        }
        .name-link:hover {
            color: #FF4500;
        }
        .sync-status {
            color: #00FFFF;
            font-size: 0.9em;
            display: none;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="starfield"></div>
    <div id="offline-banner" class="alert">Offline Mode - Using Cached Data</div>
    <div class="holo-panel">
        <div class="header-container">
            <div class="header" id="app-header"><small>UEE Citizen Console - Citizen: <span id="user-handle">Anonymous</span></small></div>
            <!-- Updated version-info structure to include the label "Star Citizen Version" above the actual fetched version -->
            <div class="version-info" id="sc-version">
                <div style="font-weight:bold;">Star Citizen Version</div>
                <div id="sc-version-text">SC Alpha 4.3.1</div>
            </div>
        </div>
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard">Dashboard HUD</div>
            <div class="nav-tab" data-tab="add">Add Asset</div>
            <div class="nav-tab" data-tab="search">Search Fleet</div>
            <div class="nav-tab" data-tab="trading">Trade Routes</div>
            <div class="nav-tab" data-tab="wishlist">Wishlist Scanner</div>
            <div class="nav-tab" data-tab="settings">Settings</div>
        </div>
        <button id="sync-btn">Sync with Verse</button>
        <div id="sync-status" class="sync-status">Syncing data...</div>
        <button id="export-btn">Export Hangar Data</button>
        <button id="import-btn">Import JSON</button>
        <input type="file" id="import-file" style="display: none;">
        <div id="dashboard" class="content active">
            <div class="metrics-grid">
                <div class="metric-card">Ships: <span id="ship-count">0</span></div>
                <div class="metric-card">Items: <span id="item-count">0</span></div>
            </div>
            <table id="stats-table">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th data-sort="name">Name</th>
                        <th data-sort="manufacturer">Manufacturer</th>
                        <th data-sort="role">Role</th>
                        <th data-sort="size">Size</th>
                        <th data-sort="owned_qty">Qty</th>
                        <th data-sort="location">Location</th>
                        <th>Loadout/Notes</th>
                        <th data-sort="data_reliability_score">Data Reliability <span class="tooltip">?<span class="tooltiptext">Data reliability score indicates value accuracy from multiple sources. Green: High (variance <10%), Yellow: Medium (10-15%), Red: Low (>15%).</span></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="add" class="content">
            <div class="form-grid">
                <div>
                    <h3>Add Ship</h3>
                    <input id="ship-name" placeholder="Name">
                    <input id="ship-manufacturer" placeholder="Manufacturer">
                    <select id="ship-role">
                        <option value="">Select Role</option>
                        <option>Military</option>
                        <option>Civilian</option>
                        <option>Industrial</option>
                        <option>Miner</option>
                        <option>Ground Vehicle</option>
                        <option>Other</option>
                    </select>
                    <input id="ship-size" placeholder="Size (Small/Medium/Large/Capital)">
                    <input id="ship-qty" type="number" placeholder="Quantity" value="1">
                    <input id="ship-location" placeholder="Location">
                    <input id="ship-loadout" placeholder="Loadout">
                    <input id="ship-notes" placeholder="Notes">
                    <input id="ship-image" placeholder="Image URL (optional)">
                    <button onclick="addShip()">Add Ship</button>
                </div>
                <div>
                    <h3>Add Item</h3>
                    <input id="item-name" placeholder="Name">
                    <select id="item-type">
                        <option>weapon</option>
                        <option>armor</option>
                        <option>component</option>
                        <option>commodity</option>
                    </select>
                    <input id="item-size" placeholder="Size">
                    <input id="item-qty" type="number" placeholder="Quantity" value="1">
                    <input id="item-location" placeholder="Location">
                    <input id="item-buy-price" type="number" placeholder="Buy Price (aUEC/SCU)">
                    <input id="item-notes" placeholder="Notes">
                    <button onclick="addItem()">Add Item</button>
                </div>
            </div>
        </div>
        <div id="search" class="content">
            <div class="filter-group">
                <input id="search-query" placeholder="Search Name...">
                <select id="search-filter-type">
                    <option value="">All Types</option>
                    <option>ship</option>
                    <option>weapon</option>
                    <option>armor</option>
                    <option>component</option>
                    <option>commodity</option>
                </select>
                <input id="search-filter-manufacturer" placeholder="Manufacturer Filter">
                <select id="search-filter-role">
                    <option value="">All Roles</option>
                    <option>Military</option>
                    <option>Civilian</option>
                    <option>Industrial</option>
                    <option>Miner</option>
                    <option>Ground Vehicle</option>
                    <option>Other</option>
                </select>
                <select id="search-filter-size">
                    <option value="">All Sizes</option>
                    <option>Small</option>
                    <option>Medium</option>
                    <option>Large</option>
                    <option>Capital</option>
                </select>
                <input id="search-filter-location" placeholder="Location Filter">
                <button onclick="performSearch()">Search</button>
            </div>
            <table id="search-table">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Manufacturer/Type</th>
                        <th>Role</th>
                        <th>Size</th>
                        <th>Qty</th>
                        <th>Location</th>
                        <th>Loadout/Notes</th>
                        <th>Data Reliability</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="trading" class="content">
            <table id="trading-table">
                <thead>
                    <tr>
                        <th>Commodity</th>
                        <th>Qty</th>
                        <th>Best Port</th>
                        <th>Sell/SCU</th>
                        <th>Profit</th>
                        <th>Alert</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="wishlist" class="content">
            <h3>Add to Wishlist</h3>
            <input id="wishlist-name" placeholder="Name">
            <select id="wishlist-type">
                <option>ship</option>
                <option>item</option>
            </select>
            <input id="wishlist-target-price" type="number" placeholder="Target Price">
            <input id="wishlist-notes" placeholder="Notes">
            <button onclick="addToWishlist()">Add</button>
            <table id="wishlist-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Target Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="settings" class="content">
            <h3>Settings</h3>
            <input id="uex-key" placeholder="UEX API Key">
            <button onclick="saveUexKey()">Save UEX Key</button>
            <input id="user-handle-input" placeholder="User Handle">
            <button onclick="saveUserHandle()">Save Handle</button>
        </div>
        <!-- Detail View -->
        <div id="detail" class="content">
            <div id="detail-header" class="header"></div>
            <div id="detail-info" class="detail-info"></div>
            <button id="update-ship-btn" class="update-button" style="display:none;" onclick="forceUpdateShipData()">Update Ship Data</button>
            <button id="reset-ship-btn" class="reset-button" style="display:none;" onclick="resetShipToDefault()">Reset to Default</button>
            <button id="back-btn" class="back-button" onclick="goBackToDashboard()">Back to Dashboard</button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Edit Asset</h3>
            <input id="edit-name" placeholder="Name" disabled>
            <input id="edit-manufacturer" placeholder="Manufacturer/Type">
            <select id="edit-role">
                <option value="">Select Role</option>
                <option>Military</option>
                <option>Civilian</option>
                <option>Industrial</option>
                <option>Miner</option>
                <option>Ground Vehicle</option>
                <option>Other</option>
            </select>
            <input id="edit-size" placeholder="Size">
            <input id="edit-qty" type="number" placeholder="Quantity">
            <input id="edit-location" placeholder="Location">
            <input id="edit-loadout" placeholder="Loadout (for ships)">
            <input id="edit-notes" placeholder="Notes">
            <input id="edit-buy-price" type="number" placeholder="Buy Price (for items)">
            <input id="edit-image" placeholder="Image URL">
            <select id="edit-type" style="display:none;">
                <option>weapon</option>
                <option>armor</option>
                <option>component</option>
                <option>commodity</option>
            </select>
            <button id="save-edit">Save Changes</button>
        </div>
    </div>

    <script>
        // Global variables for navigation state
        let currentDetailItem = null;
        let currentDetailType = null;
        let editingItemKey = null; // for modal: ship name or item id
        let editingItemKind = null; // 'ship' or 'item'
        let currentSCVersion = 'Alpha 4.3.1'; // Fallback

        // DB Setup
        const db = new Dexie('SCFleetManager');
        db.version(5).stores({
            ships: 'name, manufacturer, role, size, value, owned_qty, location, loadout, notes, last_sync, data_reliability_score, image_url',
            items: '++id, name, type, size, owned_qty, value, location, acquired_date, buy_price, data_reliability_score, notes',
            wishlist: 'name, type, target_price, notes',
            audit_log: '++id, timestamp, source, item_name, changes, verified',
            settings: 'key, value',
            history: '++id, timestamp, total_value'
        });

        // Data sources
        const sources = [
            { name: 'Star Citizen Wiki', url: 'https://api.star-citizen.wiki/v2/vehicles?query=', field: 'price_in_game' },
            { name: 'FleetYards API', url: 'https://api.fleetyards.net/v1/models?slug=', field: 'price' },
            { name: 'UEX API', url: 'https://uexcorp.space/api/2.0/commodities_prices?name=', field: 'sell_price' }
        ];

        let uexKey = localStorage.getItem('uexKey') || '';

        // Fetch default ship data from FleetYards
        async function getDefaultShipData(shipName) {
            try {
                const response = await fetch(`https://api.fleetyards.net/v1/models?slug=${encodeURIComponent(shipName.toLowerCase().replace(/\s/g, '-'))}`);
                if (response.ok) {
                    const data = await response.json();
                    const ship = Array.isArray(data) ? data[0] : data;
                    return {
                        manufacturer: ship.manufacturer?.name || 'Unknown',
                        role: ship.classification || 'Other',
                        size: ship.size || 'Medium'
                    };
                }
            } catch (err) {
                console.warn(`Error fetching default data for ${shipName}:`, err);
            }
            // Fallback mock data
            const defaults = {
                'Idris-M': { manufacturer: 'Aegis Dynamics', role: 'Military', size: 'Capital' },
                'Gladius': { manufacturer: 'Aegis Dynamics', role: 'Military', size: 'Small' },
                'Hull-D': { manufacturer: 'MISC', role: 'Industrial', size: 'Large' }
            };
            return defaults[shipName] || { manufacturer: 'Unknown', role: 'Other', size: 'Medium' };
        }

        // Fetch default image from FleetYards
        async function getDefaultImage(shipName) {
            try {
                const response = await fetch(`https://api.fleetyards.net/v1/models?slug=${encodeURIComponent(shipName.toLowerCase().replace(/\s/g, '-'))}`);
                if (response.ok) {
                    const data = await response.json();
                    const ship = Array.isArray(data) ? data[0] : data;
                    return ship.media?.[0]?.source_url || 'https://via.placeholder.com/200x100?text=Ship+Image';
                }
            } catch (err) {
                console.warn(`Error fetching image for ${shipName}:`, err);
            }
            // Fallback mock data
            const defaultImages = {
                'Idris-M': 'https://media.robertsspaceindustries.com/4k3j8m2v8b5nq/feature.jpg',
                'Gladius': 'https://media.robertsspaceindustries.com/9f3k2m1v8b5nq/feature.jpg',
                'Hull-D': 'https://media.robertsspaceindustries.com/7g3k4m2v8b5nq/feature.jpg'
            };
            return defaultImages[shipName] || 'https://via.placeholder.com/200x100?text=Ship+Image';
        }

        // Mock default loadout (no reliable API for detailed loadouts)
        function getDefaultLoadout(shipName) {
            const defaults = {
                'Idris-M': 'Size 10 spinal gun, 7 manned turrets (2x S5), 2 remote turrets (2x S4), missile launchers',
                'Gladius': '3x S3 gimbaled laser repeaters, 4x S2 missile racks',
                'Hull-D': '2x S4 remote turrets, cargo-focused configuration'
            };
            return defaults[shipName] || 'Factory standard loadout (details not available)';
        }

        // Mock hardpoint data with Star Citizen Tools fallback
        async function getShipHardpoints(shipName) {
            try {
                const response = await fetch(`https://api.starcitizen.tools/v2/vehicles?name=${encodeURIComponent(shipName)}`);
                if (response.ok) {
                    const data = await response.json();
                    const ship = Array.isArray(data) ? data[0] : data;
                    return {
                        weapons: ship.hardpoints?.weapons?.map(h => `${h.quantity}x S${h.size} ${h.type}`) || ['Unknown hardpoints'],
                        missiles: ship.hardpoints?.missiles?.map(m => `${m.quantity}x S${m.size} missile`) || [],
                        components: ship.hardpoints?.components?.map(c => c.type) || ['Standard components']
                    };
                }
            } catch (err) {
                console.warn(`Error fetching hardpoints for ${shipName}:`, err);
            }
            // Fallback mock data
            const hardpoints = {
                'Idris-M': {
                    weapons: ['1x S10 spinal gun', '7x manned turrets (2x S5)', '2x remote turrets (2x S4)'],
                    missiles: ['4x S6 missile launchers'],
                    components: ['Capital shield generator', 'Military-grade power plant']
                },
                'Gladius': {
                    weapons: ['3x S3 gimbaled hardpoints'],
                    missiles: ['4x S2 missile racks'],
                    components: ['Small shield generator', 'Military-grade cooler']
                },
                'Hull-D': {
                    weapons: ['2x S4 remote turrets'],
                    missiles: [],
                    components: ['Large cargo modules', 'Industrial-grade power plant']
                }
            };
            return hardpoints[shipName] || {
                weapons: ['Unknown hardpoints'],
                missiles: [],
                components: ['Standard components']
            };
        }

        // Loadout suggestions based on role, size, and hardpoints
        function getLoadoutSuggestion(ship, type, hardpoints) {
            const role = (ship.role || '').toLowerCase();
            const size = (ship.size || '').toLowerCase();
            let base = `For ${ship.name} (${role || 'unknown'} role, ${size || 'unknown'} size): `;
            const weaponSlots = (hardpoints && hardpoints.weapons) ? hardpoints.weapons.join(', ') : 'Unknown weapons';
            if (type === 'max_dmg') {
                if (role.includes('military')) {
                    return base + `Max Damage: Equip ${weaponSlots} with laser repeaters for high DPS, overclock weapons, add ballistic cannons for shield penetration.`;
                }
                return base + `Max Damage: Fit ${weaponSlots} with high-output weapons for offensive power.`;
            } else if (type === 'balanced') {
                return base + `Balanced: Equip ${weaponSlots} with mix of repeaters and cannons, add missile racks, balance power/cooling.`;
            } else if (type === 'stealth') {
                return base + `Stealth: Use ballistics in ${weaponSlots} to reduce EM/IR, low-emission components, avoid high-power lasers.`;
            }
            return 'Select a suggestion type.';
        }

        // Fetch current Star Citizen version
        async function fetchSCVersion() {
            try {
                const response = await fetch('https://api.star-citizen.wiki/v2/version');
                if (response.ok) {
                    const data = await response.json();
                    currentSCVersion = data.version || currentSCVersion;
                } else {
                    console.warn('Version fetch failed, using fallback');
                }
            } catch (err) {
                console.warn('Error fetching SC version:', err);
            }
            // Update the new text node we made in the HTML
            const el = document.getElementById('sc-version-text');
            if (el) el.textContent = `SC ${currentSCVersion}`;
        }

        // Verify data with version-specific checks
        async function verifyData(itemName, itemType, forceUpdate = false, version = currentSCVersion) {
            try {
                const results = [];
                for (const src of sources) {
                    try {
                        let baseUrl = src.url;
                        // Special handling for FleetYards slug vs generic query
                        let urlToFetch = baseUrl + encodeURIComponent(itemName);
                        // For FleetYards the slug expects lower and hyphens; handle when obvious
                        if (baseUrl.includes('fleetyards')) {
                            urlToFetch = `${baseUrl}${encodeURIComponent(itemName.toLowerCase().replace(/\s/g, '-'))}`;
                        }
                        // For UEX include key if present
                        if (src.name === 'UEX API' && itemType !== 'ship' && uexKey) {
                            urlToFetch += `&api_key=${uexKey}`;
                        }

                        const response = await fetch(urlToFetch);
                        if (response.ok) {
                            const data = await response.json();
                            let match = null;
                            if (Array.isArray(data)) match = data[0];
                            else if (data.data && Array.isArray(data.data)) match = data.data[0];
                            else if (data.result && Array.isArray(data.result)) match = data.result[0];
                            else if (typeof data === 'object' && Object.keys(data).length && data[0]) match = data[0];
                            else match = data;

                            const rawVal = match ? (match[src.field] || match.price_in_game || match.price || match.sell_price || 0) : 0;
                            const val = (typeof rawVal === 'number') ? rawVal : (parseFloat(rawVal) || 0);
                            results.push({ source: src.name, value: val });
                        } else {
                            console.warn(`Fetch failed for ${src.name}: ${response.status}`);
                        }
                    } catch (err) {
                        console.warn(`Error fetching ${src.name}:`, err);
                    }
                }
                if (results.length === 0) {
                    return { value: 1000, reliability: 0.5, sources: ['Fallback'] };
                }
                const values = results.map(r => r.value).filter(v => v > 0);
                if (values.length < 2) return { value: values[0] || 0, reliability: 0.5, sources: results.map(r => r.source) };
                const avg = values.reduce((a, b) => a + b, 0) / values.length;
                const maxDiff = Math.max(...values.map(v => Math.abs(v - avg)));
                const variance = avg === 0 ? 0 : maxDiff / avg;
                const reliability = variance < 0.1 ? 1 : variance < 0.15 ? 0.8 : 0.6;
                return { value: Math.round(avg), reliability, sources: results.map(r => r.source) };
            } catch (error) {
                console.error('Verification error:', error);
                return { value: 0, reliability: 0.3, sources: [] };
            }
        }

        // Force update ship data
        async function forceUpdateShipData() {
            if (!currentDetailItem || currentDetailType !== 'ship') {
                alert('No ship selected for update');
                return;
            }
            const ship = currentDetailItem;
            const verified = await verifyData(ship.name, 'ship', true, currentSCVersion);
            const defaultData = await getDefaultShipData(ship.name);
            const defaultImage = await getDefaultImage(ship.name);
            const updates = {
                manufacturer: ship.manufacturer || defaultData.manufacturer,
                role: ship.role || defaultData.role,
                size: ship.size || defaultData.size,
                value: verified.value || ship.value || 1000,
                data_reliability_score: verified.reliability || ship.data_reliability_score || 0.5,
                loadout: ship.loadout || getDefaultLoadout(ship.name),
                image_url: ship.image_url || defaultImage,
                last_sync: Date.now()
            };
            if (ship.value && verified.value && Math.abs(verified.value - ship.value) / ship.value > 0.15) {
                if (!confirm(`Update ${ship.name} value from ${ship.value.toLocaleString()} to ${verified.value.toLocaleString()} aUEC?`)) {
                    updates.value = ship.value;
                    updates.data_reliability_score = ship.data_reliability_score;
                }
            }
            try {
                await db.ships.update(ship.name, updates);
                currentDetailItem = { ...ship, ...updates };
                await showDetail(currentDetailItem, 'ship');
                await updateDashboard();
                alert(`Updated data for ${ship.name}`);
            } catch (e) {
                console.error(e);
                alert('Update failed');
            }
        }

        // Reset ship to default
        async function resetShipToDefault() {
            if (!currentDetailItem || currentDetailType !== 'ship') {
                alert('No ship selected for reset');
                return;
            }
            if (!confirm(`Reset ${currentDetailItem.name} to default values for SC ${currentSCVersion}? This will overwrite all custom data.`)) {
                return;
            }
            const shipName = currentDetailItem.name;
            const defaultData = await getDefaultShipData(shipName);
            const verified = await verifyData(shipName, 'ship', true, currentSCVersion);
            const defaultLoadout = getDefaultLoadout(shipName);
            const defaultImage = await getDefaultImage(shipName);
            const updates = {
                manufacturer: defaultData.manufacturer,
                role: defaultData.role,
                size: defaultData.size,
                value: verified.value || 1000,
                owned_qty: 1,
                location: '',
                loadout: defaultLoadout,
                notes: '',
                last_sync: Date.now(),
                data_reliability_score: verified.reliability || 0.5,
                image_url: defaultImage
            };
            try {
                await db.ships.update(shipName, updates);
                currentDetailItem = { ...currentDetailItem, ...updates };
                await showDetail(currentDetailItem, 'ship');
                await updateDashboard();
                await logAudit('Reset Ship', shipName, updates);
                alert(`Reset ${shipName} to defaults`);
            } catch (e) {
                console.error(e);
                alert('Reset failed');
            }
        }

        // Auto-sync if needed
        async function autoSyncIfNeeded() {
            const ships = await db.ships.toArray();
            const now = Date.now();
            const staleThreshold = 24 * 60 * 60 * 1000; // 24 hours
            let needsUpdate = false;
            for (const ship of ships) {
                if (!ship.last_sync || (now - ship.last_sync > staleThreshold)) {
                    needsUpdate = true;
                    break;
                }
            }
            if (needsUpdate) {
                document.getElementById('sync-status').style.display = 'block';
                await syncData(true);
                document.getElementById('sync-status').style.display = 'none';
            }
        }

        async function addShip() {
            const name = document.getElementById('ship-name').value?.trim();
            if (!name) { alert('Ship name required'); return; }
            const imageUrlInput = document.getElementById('ship-image').value?.trim();
            const imageUrl = imageUrlInput || await getDefaultImage(name);
            const defaultData = await getDefaultShipData(name);
            const verified = await verifyData(name, 'ship', true, currentSCVersion);
            await db.ships.put({
                name,
                manufacturer: document.getElementById('ship-manufacturer').value || defaultData.manufacturer,
                role: document.getElementById('ship-role').value || defaultData.role,
                size: document.getElementById('ship-size').value || defaultData.size,
                value: verified.value || 0,
                owned_qty: parseInt(document.getElementById('ship-qty').value) || 1,
                location: document.getElementById('ship-location').value || '',
                loadout: document.getElementById('ship-loadout').value || getDefaultLoadout(name),
                notes: document.getElementById('ship-notes').value || '',
                last_sync: Date.now(),
                data_reliability_score: verified.reliability || 0,
                image_url: imageUrl
            });
            await logAudit('Add Ship', name, verified);
            await updateDashboard();
            alert(`Added ship: ${name}`);
        }

        async function addItem() {
            const name = document.getElementById('item-name').value?.trim();
            if (!name) { alert('Item name required'); return; }
            const verified = await verifyData(name, 'item', true, currentSCVersion);
            const id = await db.items.add({
                name,
                type: document.getElementById('item-type').value || 'component',
                size: document.getElementById('item-size').value || '',
                owned_qty: parseInt(document.getElementById('item-qty').value) || 1,
                value: verified.value || 0,
                location: document.getElementById('item-location').value || '',
                acquired_date: new Date(),
                buy_price: parseFloat(document.getElementById('item-buy-price').value) || 0,
                data_reliability_score: verified.reliability || 0,
                notes: document.getElementById('item-notes').value || ''
            });
            await logAudit('Add Item', name, verified);
            await updateDashboard();
            await updateTrading();
            alert(`Added item: ${name} (id ${id})`);
        }

        async function logAudit(action, itemName, changes) {
            await db.audit_log.add({
                timestamp: new Date(),
                source: action,
                item_name: itemName,
                changes: JSON.stringify(changes),
                verified: true
            });
        }

        // Enhanced syncData
        async function syncData(force = false) {
            if (!navigator.onLine) {
                document.getElementById('offline-banner').style.display = 'block';
                return;
            }
            document.getElementById('offline-banner').style.display = 'none';
            document.getElementById('sync-status').style.display = 'block';
            const ships = await db.ships.toArray();
            for (const ship of ships) {
                const verified = await verifyData(ship.name, 'ship', force, currentSCVersion);
                const defaultData = await getDefaultShipData(ship.name);
                if (!ship.value) {
                    await db.ships.update(ship.name, { 
                        value: verified.value || ship.value, 
                        data_reliability_score: verified.reliability || ship.data_reliability_score, 
                        last_sync: Date.now(),
                        image_url: ship.image_url || await getDefaultImage(ship.name),
                        manufacturer: ship.manufacturer || defaultData.manufacturer,
                        role: ship.role || defaultData.role,
                        size: ship.size || defaultData.size,
                        loadout: ship.loadout || getDefaultLoadout(ship.name)
                    });
                    continue;
                }
                const variance = ship.value ? Math.abs(verified.value - ship.value) / ship.value : 0;
                if (variance > 0.15 || force) {
                    if (!force && variance > 0.15 && !confirm(`Update ${ship.name} value from ${ship.value.toLocaleString()} to ${verified.value.toLocaleString()} aUEC? (Variance: ${(variance*100).toFixed(1)}%)`)) {
                        continue;
                    }
                    await db.ships.update(ship.name, {
                        value: verified.value,
                        data_reliability_score: verified.reliability,
                        last_sync: Date.now(),
                        image_url: ship.image_url || await getDefaultImage(ship.name),
                        manufacturer: ship.manufacturer || defaultData.manufacturer,
                        role: ship.role || defaultData.role,
                        size: ship.size || defaultData.size,
                        loadout: ship.loadout || getDefaultLoadout(ship.name)
                    });
                }
            }
            const items = await db.items.toArray();
            for (const item of items) {
                const verified = await verifyData(item.name, 'item', force, currentSCVersion);
                const variance = item.value ? Math.abs(verified.value - item.value) / item.value : 0;
                if (variance > 0.15 || force) {
                    if (!force && variance > 0.15 && !confirm(`Update ${item.name} value from ${item.value.toLocaleString()} to ${verified.value.toLocaleString()} aUEC?`)) {
                        continue;
                    }
                    await db.items.update(item.id, {
                        value: verified.value,
                        data_reliability_score: verified.reliability
                    });
                }
            }
            await updateDashboard();
            await updateTrading();
            await checkWishlistAlerts();
            document.getElementById('sync-status').style.display = 'none';
        }

        // Update dashboard - now awaits async row rendering
        async function updateDashboard() {
            const ships = await db.ships.toArray();
            const items = await db.items.toArray();

            document.getElementById('ship-count').textContent = ships.length;
            document.getElementById('item-count').textContent = items.length;

            const tableBody = document.querySelector('#stats-table tbody');
            tableBody.innerHTML = '';
            // render ships and items sequentially to keep order predictable
            for (const s of ships) {
                await addRowToTable(tableBody, s, 'ship');
            }
            for (const i of items) {
                await addRowToTable(tableBody, i, 'item');
            }
        }

        // addRowToTable converted to async and uses safe DOM button wiring
        async function addRowToTable(tableBody, item, type) {
            const row = tableBody.insertRow();
            const imageCell = row.insertCell();
            let displayImage = '';
            try {
                if (type === 'ship') {
                    displayImage = item.image_url || await getDefaultImage(item.name);
                } else {
                    displayImage = item.image_url || '';
                }
            } catch (e) {
                displayImage = 'https://via.placeholder.com/200x100?text=Ship+Image';
            }
            if (displayImage) {
                const img = document.createElement('img');
                img.src = displayImage;
                img.classList.add('ship-image');
                imageCell.appendChild(img);
            } else {
                imageCell.textContent = '';
            }

            const nameCell = row.insertCell();
            const nameLink = document.createElement('span');
            nameLink.classList.add('name-link');
            nameLink.textContent = item.name || (type === 'ship' ? item.name : (item.name || 'Item'));
            nameLink.addEventListener('click', () => showDetail(item, type));
            nameCell.appendChild(nameLink);

            row.insertCell().textContent = type === 'ship' ? (item.manufacturer || '') : (item.type || '');
            row.insertCell().textContent = item.role || '';
            row.insertCell().textContent = item.size || '';
            row.insertCell().textContent = item.owned_qty || 0;
            row.insertCell().textContent = item.location || '';
            row.insertCell().textContent = type === 'ship' ? (item.loadout || item.notes || '') : (item.notes || '');
            const relCell = row.insertCell();
            const relClass = getReliabilityClass(item.data_reliability_score ?? 0);
            relCell.classList.add(relClass);
            relCell.textContent = (typeof item.data_reliability_score === 'number') ? item.data_reliability_score : (item.data_reliability_score ?? 'N/A');

            const actionsCell = row.insertCell();
            // Create Edit button
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.addEventListener('click', () => {
                const key = type === 'ship' ? item.name : item.id;
                editItem(type, String(key));
            });
            // Create Delete button
            const delBtn = document.createElement('button');
            delBtn.textContent = 'Delete';
            delBtn.addEventListener('click', () => {
                const key = type === 'ship' ? item.name : item.id;
                deleteItem(type, String(key));
            });
            actionsCell.appendChild(editBtn);
            actionsCell.appendChild(document.createTextNode(' '));
            actionsCell.appendChild(delBtn);
        }

        function getReliabilityClass(score) {
            const s = Number(score || 0);
            if (s >= 1) return 'reliability-green';
            if (s >= 0.8) return 'reliability-yellow';
            return 'reliability-red';
        }

        // Detail View Functions
        async function showDetail(item, type) {
            currentDetailItem = item;
            currentDetailType = type;
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById('detail').classList.add('active');
            document.getElementById('detail-header').innerHTML = `${type.charAt(0).toUpperCase() + type.slice(1)}: ${item.name}`;
            const updateBtn = document.getElementById('update-ship-btn');
            const resetBtn = document.getElementById('reset-ship-btn');
            updateBtn.style.display = type === 'ship' ? 'inline-block' : 'none';
            resetBtn.style.display = type === 'ship' ? 'inline-block' : 'none';
            const detailInfo = document.getElementById('detail-info');
            let loadoutHtml = '';
            let hardpointsHtml = '';
            let hardpoints = null;
            if (type === 'ship') {
                let currentLoadout = item.loadout || getDefaultLoadout(item.name);
                if (!item.loadout) {
                    await db.ships.update(item.name, { loadout: currentLoadout });
                    item.loadout = currentLoadout;
                }
                hardpoints = await getShipHardpoints(item.name);
                hardpointsHtml = `
                    <div class="detail-card">
                        <h4>Hardpoints</h4>
                        <p>Weapons: ${hardpoints.weapons.join(', ') || 'N/A'}</p>
                        <p>Missiles: ${hardpoints.missiles.length ? hardpoints.missiles.join(', ') : 'None'}</p>
                        <p>Components: ${hardpoints.components.join(', ') || 'N/A'}</p>
                    </div>
                `;
                loadoutHtml = `
                    <div class="detail-card">
                        <h4>Loadout</h4>
                        <p>${item.loadout ? 'Current: ' + item.loadout : 'Default: ' + currentLoadout}</p>
                    </div>
                    <div class="detail-card">
                        <h4>Loadout Suggestions</h4>
                        <select id="suggestion-type">
                            <option value="">Select Type</option>
                            <option value="max_dmg">Max Damage</option>
                            <option value="balanced">Balanced</option>
                            <option value="stealth">Stealth</option>
                        </select>
                        <div id="suggestion-text"></div>
                        <button id="apply-suggestion" style="display:none;">Apply Suggestion</button>
                    </div>
                `;
            }
            const displayImage = type === 'ship' ? (item.image_url || await getDefaultImage(item.name)) : item.image_url || 'No Image';
            detailInfo.innerHTML = `
                <div class="detail-card">
                    <h4>Image</h4>
                    ${displayImage && displayImage !== 'No Image' ? `<img src="${displayImage}" style="width: 200px; height: auto;">` : 'No Image'}
                </div>
                <div class="detail-card">
                    <h4>Manufacturer/Type</h4>
                    <p>${type === 'ship' ? (item.manufacturer || 'N/A') : (item.type || 'N/A')}</p>
                </div>
                <div class="detail-card">
                    <h4>Role</h4>
                    <p>${item.role || 'N/A'}</p>
                </div>
                <div class="detail-card">
                    <h4>Size</h4>
                    <p>${item.size || 'N/A'}</p>
                </div>
                <div class="detail-card">
                    <h4>Quantity</h4>
                    <p>${item.owned_qty || 0}</p>
                </div>
                <div class="detail-card">
                    <h4>Location</h4>
                    <p>${item.location || 'N/A'}</p>
                </div>
                ${hardpointsHtml}
                ${loadoutHtml}
                <div class="detail-card">
                    <h4>Additional Notes</h4>
                    <p>${item.notes || 'N/A'}</p>
                </div>
                <div class="detail-card">
                    <h4>Data Reliability Score</h4>
                    <p class="${getReliabilityClass(item.data_reliability_score ?? 0)}">${item.data_reliability_score ?? 'N/A'}</p>
                </div>
                ${type === 'item' && item.buy_price ? `<div class="detail-card"><h4>Buy Price</h4><p>${item.buy_price} aUEC/SCU</p></div>` : ''}
                ${type === 'ship' ? `<div class="detail-card"><h4>Last Sync</h4><p>${item.last_sync ? new Date(item.last_sync).toLocaleString() : 'Never'}</p></div>` : ''}
            `;
            if (type === 'ship') {
                const suggestionType = document.getElementById('suggestion-type');
                const suggestionText = document.getElementById('suggestion-text');
                const applyBtn = document.getElementById('apply-suggestion');
                suggestionType.addEventListener('change', () => {
                    const selectedType = suggestionType.value;
                    if (selectedType) {
                        const suggestion = getLoadoutSuggestion(item, selectedType, hardpoints);
                        suggestionText.textContent = suggestion;
                        applyBtn.style.display = 'block';
                    } else {
                        suggestionText.textContent = '';
                        applyBtn.style.display = 'none';
                    }
                });
                applyBtn.addEventListener('click', async () => {
                    const selectedType = suggestionType.value;
                    if (selectedType) {
                        const suggestion = getLoadoutSuggestion(item, selectedType, hardpoints);
                        await db.ships.update(item.name, { loadout: suggestion });
                        item.loadout = suggestion;
                        await showDetail(item, type);
                        alert('Suggestion applied to loadout');
                    }
                });
            }
        }

        function goBackToDashboard() {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById('dashboard').classList.add('active');
            document.querySelector('.nav-tab[data-tab="dashboard"]').classList.add('active');
            currentDetailItem = null;
            currentDetailType = null;
        }

        // Edit & Delete
        async function editItem(type, idOrName) {
            const modal = document.getElementById('edit-modal');
            modal.style.display = 'block';
            editingItemKind = type;
            if (type === 'ship') {
                const ship = await db.ships.get(idOrName);
                if (!ship) { alert('Ship not found'); return; }
                editingItemKey = ship.name;
                document.getElementById('edit-name').value = ship.name;
                document.getElementById('edit-manufacturer').value = ship.manufacturer || '';
                document.getElementById('edit-role').value = ship.role || '';
                document.getElementById('edit-size').value = ship.size || '';
                document.getElementById('edit-qty').value = ship.owned_qty || 1;
                document.getElementById('edit-location').value = ship.location || '';
                document.getElementById('edit-loadout').value = ship.loadout || '';
                document.getElementById('edit-notes').value = ship.notes || '';
                document.getElementById('edit-image').value = ship.image_url || await getDefaultImage(ship.name);
                document.getElementById('edit-buy-price').value = '';
                document.getElementById('edit-type').style.display = 'none';
            } else {
                const itemId = Number(idOrName);
                const item = await db.items.get(itemId);
                if (!item) { alert('Item not found'); return; }
                editingItemKey = item.id;
                document.getElementById('edit-name').value = item.name;
                document.getElementById('edit-manufacturer').value = item.type || '';
                document.getElementById('edit-role').value = '';
                document.getElementById('edit-size').value = item.size || '';
                document.getElementById('edit-qty').value = item.owned_qty || 1;
                document.getElementById('edit-location').value = item.location || '';
                document.getElementById('edit-loadout').value = '';
                document.getElementById('edit-notes').value = item.notes || '';
                document.getElementById('edit-image').value = item.image_url || '';
                document.getElementById('edit-buy-price').value = item.buy_price || 0;
                document.getElementById('edit-type').style.display = 'block';
                document.getElementById('edit-type').value = item.type || 'component';
            }
        }

        async function deleteItem(type, idOrName) {
            if (!confirm('Delete this entry?')) return;
            if (type === 'ship') {
                try {
                    await db.ships.delete(idOrName);
                    await updateDashboard();
                    alert('Ship deleted');
                } catch (e) {
                    console.error(e);
                    alert('Delete failed');
                }
            } else {
                const itemId = Number(idOrName);
                try {
                    await db.items.delete(itemId);
                    await updateDashboard();
                    await updateTrading();
                    alert('Item deleted');
                } catch (e) {
                    console.error(e);
                    alert('Delete failed');
                }
            }
        }

        // Save modal edits
        document.getElementById('save-edit').addEventListener('click', async () => {
            if (!editingItemKind || editingItemKey == null) { alert('No edit target'); return; }
            if (editingItemKind === 'ship') {
                const updates = {
                    manufacturer: document.getElementById('edit-manufacturer').value || '',
                    role: document.getElementById('edit-role').value || '',
                    size: document.getElementById('edit-size').value || '',
                    owned_qty: parseInt(document.getElementById('edit-qty').value) || 1,
                    location: document.getElementById('edit-location').value || '',
                    loadout: document.getElementById('edit-loadout').value || '',
                    notes: document.getElementById('edit-notes').value || '',
                    image_url: document.getElementById('edit-image').value || await getDefaultImage(editingItemKey)
                };
                try {
                    await db.ships.update(editingItemKey, updates);
                    await updateDashboard();
                    closeModal();
                } catch (e) {
                    console.error(e);
                    alert('Update failed');
                }
            } else {
                const itemId = Number(editingItemKey);
                const updates = {
                    type: document.getElementById('edit-type').value || 'component',
                    size: document.getElementById('edit-size').value || '',
                    owned_qty: parseInt(document.getElementById('edit-qty').value) || 1,
                    location: document.getElementById('edit-location').value || '',
                    notes: document.getElementById('edit-notes').value || '',
                    buy_price: parseFloat(document.getElementById('edit-buy-price').value) || 0,
                    image_url: document.getElementById('edit-image').value || ''
                };
                try {
                    await db.items.update(itemId, updates);
                    await updateDashboard();
                    await updateTrading();
                    closeModal();
                } catch (e) {
                    console.error(e);
                    alert('Update failed');
                }
            }
        });

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
            editingItemKey = null;
            editingItemKind = null;
        }

        // Search
        async function performSearch() {
            const q = (document.getElementById('search-query').value || '').toLowerCase();
            const typeFilter = document.getElementById('search-filter-type').value;
            const manuf = (document.getElementById('search-filter-manufacturer').value || '').toLowerCase();
            const role = document.getElementById('search-filter-role').value;
            const size = document.getElementById('search-filter-size').value;
            const location = (document.getElementById('search-filter-location').value || '').toLowerCase();

            const results = [];
            const ships = await db.ships.toArray();
            const items = await db.items.toArray();

            ships.forEach(s => {
                let match = true;
                if (q && !s.name.toLowerCase().includes(q)) match = false;
                if (manuf && !(s.manufacturer || '').toLowerCase().includes(manuf)) match = false;
                if (role && s.role !== role) match = false;
                if (size && s.size !== size) match = false;
                if (location && !(s.location || '').toLowerCase().includes(location)) match = false;
                if (typeFilter && typeFilter !== 'ship') match = false;
                if (match) results.push({ ...s, __kind: 'ship' });
            });

            items.forEach(i => {
                let match = true;
                if (q && !i.name.toLowerCase().includes(q)) match = false;
                if (typeFilter && typeFilter !== '' && typeFilter !== i.type && typeFilter !== 'item') match = false;
                if (manuf && !(i.type || '').toLowerCase().includes(manuf)) match = false;
                if (role && i.role && i.role !== role) match = false;
                if (size && i.size !== size) match = false;
                if (location && !(i.location || '').toLowerCase().includes(location)) match = false;
                if (match) results.push({ ...i, __kind: 'item' });
            });

            const tbody = document.querySelector('#search-table tbody');
            tbody.innerHTML = '';
            for (const r of results) {
                const tr = tbody.insertRow();
                const imgCell = tr.insertCell();
                const displayImage = r.__kind === 'ship' ? (r.image_url || await getDefaultImage(r.name)) : r.image_url || '';
                if (displayImage) {
                    const img = document.createElement('img');
                    img.src = displayImage;
                    img.classList.add('ship-image');
                    imgCell.appendChild(img);
                }
                const nameCell = tr.insertCell(); 
                nameCell.textContent = r.name;
                tr.insertCell().textContent = r.__kind === 'ship' ? (r.manufacturer || '') : (r.type || '');
                tr.insertCell().textContent = r.role || '';
                tr.insertCell().textContent = r.size || '';
                tr.insertCell().textContent = r.owned_qty || 0;
                tr.insertCell().textContent = r.location || '';
                tr.insertCell().textContent = r.__kind === 'ship' ? (r.loadout || r.notes || '') : (r.notes || '');
                const rel = tr.insertCell(); 
                rel.classList.add(getReliabilityClass(r.data_reliability_score ?? 0)); 
                rel.textContent = r.data_reliability_score ?? '';
                const actions = tr.insertCell();
                const key = r.__kind === 'ship' ? r.name : r.id;
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', () => editItem(r.__kind === 'ship' ? 'ship' : 'item', String(key)));
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete';
                delBtn.addEventListener('click', () => deleteItem(r.__kind === 'ship' ? 'ship' : 'item', String(key)));
                actions.appendChild(editBtn);
                actions.appendChild(document.createTextNode(' '));
                actions.appendChild(delBtn);
            }

            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById('search').classList.add('active');
        }

        // Trading (using UEX for commodities)
        async function updateTrading() {
            const tbody = document.querySelector('#trading-table tbody');
            tbody.innerHTML = '';
            const items = await db.items.toArray();
            const commodities = items.filter(i => i.type === 'commodity' && i.owned_qty > 0);
            for (const c of commodities) {
                const buy = c.buy_price || c.value || 0;
                let sell = buy;
                try {
                    const response = await fetch(`https://uexcorp.space/api/2.0/commodities_prices?name=${encodeURIComponent(c.name)}${uexKey ? `&api_key=${uexKey}` : ''}`);
                    if (response.ok) {
                        const data = await response.json();
                        sell = data.sell_price || Math.round(buy * 1.2);
                    }
                } catch (err) {
                    console.warn(`Error fetching UEX price for ${c.name}:`, err);
                    sell = Math.round(buy * 1.2);
                }
                const profit = Math.round((sell - buy) * (c.owned_qty || 1));
                const tr = tbody.insertRow();
                tr.insertCell().textContent = c.name;
                tr.insertCell().textContent = c.owned_qty || 0;
                tr.insertCell().textContent = 'New Babbage';
                tr.insertCell().textContent = sell.toLocaleString();
                tr.insertCell().textContent = profit.toLocaleString();
                tr.insertCell().textContent = profit > 2000 ? '⚠️' : '';
            }
        }

        // Wishlist
        async function updateWishlistTable() {
            const tbody = document.querySelector('#wishlist-table tbody');
            tbody.innerHTML = '';
            const list = await db.wishlist.toArray();
            list.forEach(w => {
                const tr = tbody.insertRow();
                tr.insertCell().textContent = w.name;
                tr.insertCell().textContent = w.type;
                tr.insertCell().textContent = w.target_price;
                const actions = tr.insertCell();
                const btn = document.createElement('button');
                btn.textContent = 'Remove';
                btn.addEventListener('click', () => removeWishlist(w.name));
                actions.appendChild(btn);
            });
        }

        async function addToWishlist() {
            const name = (document.getElementById('wishlist-name').value || '').trim();
            const type = document.getElementById('wishlist-type').value;
            const target = parseFloat(document.getElementById('wishlist-target-price').value) || 0;
            const notes = document.getElementById('wishlist-notes').value || '';
            if (!name) { alert('Wishlist name required'); return; }
            await db.wishlist.put({ name, type, target_price: target, notes });
            await updateWishlistTable();
            alert('Added to wishlist');
        }

        async function removeWishlist(name) {
            if (!confirm('Remove from wishlist?')) return;
            await db.wishlist.delete(name);
            await updateWishlistTable();
        }

        // Wishlist alerts
        async function checkWishlistAlerts() {
            const wishlist = await db.wishlist.toArray();
            for (const w of wishlist) {
                if (w.type === 'ship') {
                    const ship = await db.ships.get(w.name);
                    if (ship && ship.value && ship.value <= w.target_price) {
                        notify(`Wishlist: ${w.name} reached target price (${ship.value} aUEC)`);
                    }
                } else {
                    const item = (await db.items.where('name').equalsIgnoreCase(w.name).first());
                    if (item && item.value && item.value <= w.target_price) {
                        notify(`Wishlist: ${w.name} reached target price (${item.value} aUEC)`);
                    }
                }
            }
        }

        function notify(msg) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(msg);
            } else {
                console.log('Notify:', msg);
            }
        }

        // Settings
        function saveUexKey() {
            const key = document.getElementById('uex-key').value || '';
            localStorage.setItem('uexKey', key);
            uexKey = key;
            alert('UEX key saved locally (client-side).');
        }

        function saveUserHandle() {
            const h = document.getElementById('user-handle-input').value || '';
            if (h) {
                localStorage.setItem('userHandle', h);
                document.getElementById('user-handle').textContent = h;
                alert('Handle saved');
            } else {
                alert('Enter a handle first');
            }
        }

        // Export/Import (JSON)
        document.getElementById('export-btn').addEventListener('click', async () => {
            const ships = await db.ships.toArray();
            const items = await db.items.toArray();
            const wishlist = await db.wishlist.toArray();
            const exportObj = { ships, items, wishlist, exportedAt: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sc_fleet_export.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });

        document.getElementById('import-btn').addEventListener('click', () => {
            document.getElementById('import-file').click();
        });

        document.getElementById('import-file').addEventListener('change', async (e) => {
            const f = e.target.files[0];
            if (!f) return;
            try {
                const text = await f.text();
                const data = JSON.parse(text);
                if (data.ships && Array.isArray(data.ships)) {
                    for (const s of data.ships) {
                        if (s.name) {
                            s.image_url = s.image_url || await getDefaultImage(s.name);
                            s.loadout = s.loadout || getDefaultLoadout(s.name);
                            const defaultData = await getDefaultShipData(s.name);
                            s.manufacturer = s.manufacturer || defaultData.manufacturer;
                            s.role = s.role || defaultData.role;
                            s.size = s.size || defaultData.size;
                            await db.ships.put(s);
                        }
                    }
                }
                if (data.items && Array.isArray(data.items)) {
                    for (const it of data.items) {
                        if (it.id) {
                            await db.items.put(it);
                        } else {
                            await db.items.add(it);
                        }
                    }
                }
                if (data.wishlist && Array.isArray(data.wishlist)) {
                    for (const w of data.wishlist) await db.wishlist.put(w);
                }
                await updateDashboard();
                await updateTrading();
                await updateWishlistTable();
                alert('Import complete');
            } catch (err) {
                console.error(err);
                alert('Import failed: invalid JSON');
            } finally {
                e.target.value = '';
            }
        });

        // Modal close
        document.querySelector('#edit-modal .close').addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target === document.getElementById('edit-modal')) closeModal();
        });

        // Default ships add (if DB empty)
        async function addDefaultShips() {
            const shipCount = await db.ships.count();
            if (shipCount === 0) {
                const defaults = [
                    {
                        name: 'Idris-M',
                        manufacturer: 'Aegis Dynamics',
                        role: 'Military',
                        size: 'Capital',
                        value: 25000000,
                        owned_qty: 1,
                        location: 'Area18',
                        loadout: 'Size 10 spinal gun, 7 manned turrets (2x S5), 2 remote turrets (2x S4), missile launchers',
                        notes: 'UEE military frigate for patrols and interdiction. Length: 243m, Crew: 8-28, Cargo: 1326 SCU.',
                        image_url: await getDefaultImage('Idris-M')
                    },
                    {
                        name: 'Gladius',
                        manufacturer: 'Aegis Dynamics',
                        role: 'Military',
                        size: 'Small',
                        value: 2381400,
                        owned_qty: 1,
                        location: 'Area18',
                        loadout: '3x S3 gimbaled laser repeaters, 4x S2 missile racks',
                        notes: 'Fast dogfighter. Length: 21m, SCM: 226 m/s, Max: 1193 m/s, Crew: 1.',
                        image_url: await getDefaultImage('Gladius')
                    },
                    {
                        name: 'Hull-D',
                        manufacturer: 'MISC',
                        role: 'Industrial',
                        size: 'Large',
                        value: 4500000,
                        owned_qty: 1,
                        location: 'Area18',
                        loadout: '2x S4 remote turrets, cargo-focused configuration',
                        notes: 'Cargo hauler. Length: 209m, Cargo: 20736 SCU, Crew: 1-5.',
                        image_url: await getDefaultImage('Hull-D')
                    }
                ];
                for (const ship of defaults) {
                    const verified = await verifyData(ship.name, 'ship', true, currentSCVersion);
                    ship.value = verified.value || ship.value;
                    ship.data_reliability_score = verified.reliability || 0.5;
                    ship.last_sync = Date.now();
                    await db.ships.put(ship);
                }
            }
        }

        // Navigation tabs
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const t = tab.getAttribute('data-tab');
                document.querySelectorAll('.nav-tab').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(t).classList.add('active');
            });
        });

        // Sync button
        document.getElementById('sync-btn').onclick = () => syncData(true);

        // Init
        async function init() {
            createStars();
            await fetchSCVersion();
            // Updated header uses the document title (which we bumped to v2.3.6 earlier)
            document.getElementById('app-header').innerHTML = document.title + '<br><small>UEE Citizen Console - Citizen: <span id="user-handle">' + (localStorage.getItem('userHandle') || 'Anonymous') + '</span></small>';
            await addDefaultShips();
            await autoSyncIfNeeded();
            await updateDashboard();
            await updateWishlistTable();
            await updateTrading();
            if (!navigator.onLine) document.getElementById('offline-banner').style.display = 'block';
            if ('Notification' in window) Notification.requestPermission().catch(()=>{});
        }

        function createStars() {
            const starfield = document.querySelector('.starfield');
            for (let i = 0; i < 200; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                star.style.width = star.style.height = Math.random() * 2 + 'px';
                star.style.top = Math.random() * 100 + '%';
                star.style.left = Math.random() * 100 + '%';
                starfield.appendChild(star);
            }
        }

        // Start
        init();
    </script>
</body>
</html>
