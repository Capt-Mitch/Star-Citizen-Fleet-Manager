<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Star Citizen Fleet Manager v2.3.7</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dexie@3/dist/dexie.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Orbitron', Arial, sans-serif;
            background: radial-gradient(circle, #001022, #000000);
            color: #00FFFF;
            overflow-x: hidden;
            position: relative;
        }
        /* Starfield */
        .starfield {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
        }
        .holo-panel {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00FFFF;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
            border-radius: 8px;
            padding: 20px;
            margin: 20px auto;
            max-width: 1200px;
            backdrop-filter: blur(5px);
            animation: boot-up 1s ease-in-out;
            position: relative;
            z-index: 1;
        }
        @keyframes boot-up {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .header {
            text-align: center;
            text-shadow: 0 0 5px #00FFFF;
            font-size: 2em;
        }
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .version-info {
            font-size: 0.9em;
            color: #00FF88;
            text-shadow: 0 0 3px #00FF88;
            text-align: right;
            line-height: 1.1;
        }
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        .nav-tab {
            padding: 10px 20px;
            margin: 0 5px;
            border: 2px solid #00FFFF;
            border-radius: 5px;
            cursor: pointer;
            transition: box-shadow 0.3s;
        }
        .nav-tab:hover {
            box-shadow: 0 0 15px #00FFFF;
        }
        .nav-tab.active {
            background: rgba(0, 255, 255, 0.2);
            border-bottom: 4px solid #FF4500;
        }
        .content {
            display: none;
        }
        .content.active {
            display: block;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .metric-card {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00FFFF;
            padding: 15px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        .alert {
            color: #FF4500;
            text-shadow: 0 0 5px #FF4500;
        }
        input, select, button {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00FFFF;
            color: #00FFFF;
            padding: 5px;
            margin: 5px;
            font-family: 'Orbitron', Arial, sans-serif;
        }
        button:hover {
            box-shadow: 0 0 10px #00FFFF;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #00FFFF;
            padding: 8px;
            text-align: left;
        }
        th {
            background: rgba(0, 255, 255, 0.1);
            cursor: pointer;
        }
        .reliability-green { color: #00FF88; }
        .reliability-yellow { color: #FFFF66; }
        .reliability-red { color: #FF4500; }
        #offline-banner {
            background: rgba(255, 69, 0, 0.8);
            color: white;
            text-align: center;
            padding: 10px;
            display: none;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .ship-image {
            width: 100px;
            height: auto;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: rgba(0,0,0,0.8);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #00FFFF;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 0 15px #00FFFF;
        }
        .close {
            color: #00FFFF;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #FF4500;
            text-decoration: none;
            cursor: pointer;
        }
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0,0,0,0.8);
            color: #00FFFF;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .detail-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .detail-card {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00FFFF;
            padding: 15px;
            border-radius: 5px;
        }
        .back-button, .update-button, .reset-button {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #FF4500;
            color: #FF4500;
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Orbitron', Arial, sans-serif;
            margin-right: 10px;
        }
        .back-button:hover, .update-button:hover, .reset-button:hover {
            box-shadow: 0 0 10px #FF4500;
        }
        .name-link {
            color: #00FFFF;
            text-decoration: underline;
            cursor: pointer;
        }
        .name-link:hover {
            color: #FF4500;
        }
        .sync-status {
            color: #00FFFF;
            font-size: 0.9em;
            display: none;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="starfield"></div>
    <div id="offline-banner" class="alert">Offline Mode - Using Cached Data</div>
    <div class="holo-panel">
        <div class="header-container">
            <div class="header" id="app-header"><small>UEE Citizen Console - Citizen: <span id="user-handle">Anonymous</span></small></div>
            <div class="version-info" id="sc-version">
                <div style="font-weight:bold;">Star Citizen Version</div>
                <div id="sc-version-text">SC Unknown</div>
            </div>
        </div>
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard">Dashboard HUD</div>
            <div class="nav-tab" data-tab="add">Add Asset</div>
            <div class="nav-tab" data-tab="search">Search Fleet</div>
            <div class="nav-tab" data-tab="trading">Trade Routes</div>
            <div class="nav-tab" data-tab="wishlist">Wishlist Scanner</div>
            <div class="nav-tab" data-tab="settings">Settings</div>
        </div>
        <button id="sync-btn">Sync with Verse</button>
        <div id="sync-status" class="sync-status">Syncing data...</div>
        <button id="export-btn">Export Hangar Data</button>
        <button id="import-btn">Import JSON</button>
        <input type="file" id="import-file" style="display: none;">
        <div id="dashboard" class="content active">
            <div class="metrics-grid">
                <div class="metric-card">Ships: <span id="ship-count">0</span></div>
                <div class="metric-card">Items: <span id="item-count">0</span></div>
            </div>
            <table id="stats-table">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th data-sort="name">Name</th>
                        <th data-sort="manufacturer">Manufacturer</th>
                        <th data-sort="role">Role</th>
                        <th data-sort="size">Size</th>
                        <th data-sort="hp">HP</th>
                        <th data-sort="shield">Shield</th>
                        <th data-sort="cargo">Cargo SCU</th>
                        <th data-sort="owned_qty">Qty</th>
                        <th data-sort="location">Location</th>
                        <th>Loadout/Notes</th>
                        <th data-sort="data_reliability_score">Data Reliability <span class="tooltip">?<span class="tooltiptext">Data reliability is from how well multiple sources agree and how recent the data is.</span></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="add" class="content">
            <div class="form-grid">
                <div>
                    <h3>Add Ship</h3>
                    <input id="ship-name" placeholder="Name">
                    <input id="ship-manufacturer" placeholder="Manufacturer">
                    <select id="ship-role">
                        <option value="">Select Role</option>
                        <option>Military</option>
                        <option>Civilian</option>
                        <option>Industrial</option>
                        <option>Miner</option>
                        <option>Ground Vehicle</option>
                        <option>Other</option>
                    </select>
                    <input id="ship-size" placeholder="Size (Small/Medium/Large/Capital)">
                    <input id="ship-qty" type="number" placeholder="Quantity" value="1">
                    <input id="ship-location" placeholder="Location">
                    <input id="ship-loadout" placeholder="Loadout">
                    <input id="ship-notes" placeholder="Notes">
                    <input id="ship-image" placeholder="Image URL (optional)">
                    <button onclick="addShip()">Add Ship</button>
                </div>
                <div>
                    <h3>Add Item</h3>
                    <input id="item-name" placeholder="Name">
                    <select id="item-type">
                        <option>weapon</option>
                        <option>armor</option>
                        <option>component</option>
                        <option>commodity</option>
                    </select>
                    <input id="item-size" placeholder="Size">
                    <input id="item-qty" type="number" placeholder="Quantity" value="1">
                    <input id="item-location" placeholder="Location">
                    <input id="item-buy-price" type="number" placeholder="Buy Price (aUEC/SCU)">
                    <input id="item-notes" placeholder="Notes">
                    <button onclick="addItem()">Add Item</button>
                </div>
            </div>
        </div>

        <div id="search" class="content">
            <div class="filter-group">
                <input id="search-query" placeholder="Search Name...">
                <select id="search-filter-type">
                    <option value="">All Types</option>
                    <option>ship</option>
                    <option>weapon</option>
                    <option>armor</option>
                    <option>component</option>
                    <option>commodity</option>
                </select>
                <input id="search-filter-manufacturer" placeholder="Manufacturer Filter">
                <select id="search-filter-role">
                    <option value="">All Roles</option>
                    <option>Military</option>
                    <option>Civilian</option>
                    <option>Industrial</option>
                    <option>Miner</option>
                    <option>Ground Vehicle</option>
                    <option>Other</option>
                </select>
                <select id="search-filter-size">
                    <option value="">All Sizes</option>
                    <option>Small</option>
                    <option>Medium</option>
                    <option>Large</option>
                    <option>Capital</option>
                </select>
                <input id="search-filter-location" placeholder="Location Filter">
                <button onclick="performSearch()">Search</button>
            </div>
            <table id="search-table">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Manufacturer/Type</th>
                        <th>Role</th>
                        <th>Size</th>
                        <th>Qty</th>
                        <th>Location</th>
                        <th>Loadout/Notes</th>
                        <th>Data Reliability</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="trading" class="content">
            <table id="trading-table">
                <thead>
                    <tr>
                        <th>Commodity</th>
                        <th>Qty</th>
                        <th>Best Port</th>
                        <th>Sell/SCU</th>
                        <th>Profit</th>
                        <th>Alert</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="wishlist" class="content">
            <h3>Add to Wishlist</h3>
            <input id="wishlist-name" placeholder="Name">
            <select id="wishlist-type">
                <option>ship</option>
                <option>item</option>
            </select>
            <input id="wishlist-target-price" type="number" placeholder="Target Price">
            <input id="wishlist-notes" placeholder="Notes">
            <button onclick="addToWishlist()">Add</button>
            <table id="wishlist-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Target Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="settings" class="content">
            <h3>Settings</h3>
            <input id="uex-key" placeholder="UEX API Key">
            <button onclick="saveUexKey()">Save UEX Key</button>
            <input id="user-handle-input" placeholder="User Handle">
            <button onclick="saveUserHandle()">Save Handle</button>
        </div>

        <div id="detail" class="content">
            <div id="detail-header" class="header"></div>
            <div id="detail-info" class="detail-info"></div>
            <button id="update-ship-btn" class="update-button" style="display:none;" onclick="syncData(true)">Update Ship Data</button>
            <button id="reset-ship-btn" class="reset-button" style="display:none;" onclick="alert('Reset is available in the edit modal')">Reset to Default</button>
            <button id="back-btn" class="back-button" onclick="goBackToDashboard()">Back to Dashboard</button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Edit Asset</h3>
            <input id="edit-name" placeholder="Name" disabled>
            <input id="edit-manufacturer" placeholder="Manufacturer/Type">
            <select id="edit-role">
                <option value="">Select Role</option>
                <option>Military</option>
                <option>Civilian</option>
                <option>Industrial</option>
                <option>Miner</option>
                <option>Ground Vehicle</option>
                <option>Other</option>
            </select>
            <input id="edit-size" placeholder="Size">
            <input id="edit-qty" type="number" placeholder="Quantity">
            <input id="edit-location" placeholder="Location">
            <input id="edit-loadout" placeholder="Loadout (for ships)">
            <input id="edit-notes" placeholder="Notes">
            <input id="edit-buy-price" type="number" placeholder="Buy Price (for items)">
            <input id="edit-image" placeholder="Image URL">
            <select id="edit-type" style="display:none;">
                <option>weapon</option>
                <option>armor</option>
                <option>component</option>
                <option>commodity</option>
            </select>
            <button id="save-edit">Save Changes</button>
        </div>
    </div>

    <script>
        // ------------------ Star Citizen Fleet Manager - Enhanced Script ------------------
        // Version: 2.3.6 (script)
        // Enhanced image & data fetching, caching, safe sync, and user-preserved loadouts.

        let currentDetailItem = null;
        let currentDetailType = null;
        let editingItemKey = null;
        let editingItemKind = null;
        let currentSCVersion = 'Unknown';

        // Dexie DB Setup - retain existing stores and add fields for enriched data
        const db = new Dexie('SCFleetManager');
        db.version(6).stores({
            ships: 'name, manufacturer, role, size, value, owned_qty, location, loadout, notes, last_sync, data_reliability_score, image_url, hp, shield, cargo, hardpoints_json, _loadout_source',
            items: '++id, name, type, size, owned_qty, value, location, acquired_date, buy_price, data_reliability_score, notes, image_url',
            wishlist: 'name, type, target_price, notes',
            audit_log: '++id, timestamp, source, item_name, changes, verified',
            settings: 'key, value',
            history: '++id, timestamp, total_value'
        });

        // Data sources and reachability tracking
        const API_SOURCES = {
            scwiki: { name: 'Star Citizen Wiki', base: 'https://api.star-citizen.wiki/v2', ok: null },
            fleetyards: { name: 'FleetYards', base: 'https://api.fleetyards.net/v1', ok: null },
            scapi: { name: 'StarCitizen-API', base: 'https://api.starcitizen-api.com', ok: null },
            uex: { name: 'UEX', base: 'https://uexcorp.space/api/2.0', ok: null }
        };

        // Local config
        const ENRICHMENT_STALE_MS = 24 * 60 * 60 * 1000; // 24 hours
        const IMAGE_PLACEHOLDER = 'https://via.placeholder.com/200x100?text=No+Image';
        const MAX_FETCH_RETRIES = 2;
        const FETCH_TIMEOUT_MS = 8000;

        // Utility: fetch with timeout
        async function fetchWithTimeout(url, opts = {}, timeout = FETCH_TIMEOUT_MS) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                const res = await fetch(url, { signal: controller.signal, ...opts });
                clearTimeout(id);
                return res;
            } catch (err) {
                clearTimeout(id);
                throw err;
            }
        }

        // Utility: robust fetch with retries and simple backoff
        async function fetchJsonRetry(url, opts = {}, attempts = MAX_FETCH_RETRIES) {
            let lastErr = null;
            for (let i = 0; i < attempts; i++) {
                try {
                    const r = await fetchWithTimeout(url, opts);
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    // Try parse JSON
                    const txt = await r.text();
                    try {
                        return JSON.parse(txt);
                    } catch (e) {
                        // Some APIs return non-json; bubble
                        throw new Error('Invalid JSON');
                    }
                } catch (err) {
                    lastErr = err;
                    // simple backoff
                    await new Promise(res => setTimeout(res, 300 + i * 300));
                }
            }
            throw lastErr;
        }

        // Health-check small endpoints (non-blocking)
        async function checkApiHealth() {
            for (const key of Object.keys(API_SOURCES)) {
                const s = API_SOURCES[key];
                try {
                    // choose a cheap endpoint
                    let testUrl = s.base;
                    if (key === 'scwiki') testUrl = `${s.base}/version`;
                    if (key === 'fleetyards') testUrl = `${s.base}/models?slug=gladius`;
                    if (key === 'scapi') testUrl = `${s.base}/ships/gladius`;
                    if (key === 'uex') testUrl = `${s.base}/commodities_prices?name=Food`;
                    const res = await fetchWithTimeout(testUrl, {}, 3000);
                    s.ok = res.ok;
                } catch (e) {
                    s.ok = false;
                }
            }
            console.info('API health:', API_SOURCES);
        }

        // SC version fetch (updates UI)
        async function fetchSCVersion() {
            try {
                const data = await fetchJsonRetry('https://api.star-citizen.wiki/v2/version', {}, 1);
                if (data && data.version) currentSCVersion = data.version;
            } catch (e) {
                console.warn('Could not fetch SC version, using cached/fallback', e);
            }
            const el = document.getElementById('sc-version-text');
            if (el) el.textContent = `SC ${currentSCVersion}`;
            // trigger health check but do not block init
            checkApiHealth().catch(()=>{});
        }

        // Slug helper
        function slugify(name) {
            return encodeURIComponent(String(name).toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g,''));
        }

        // Primary: fetch detailed ship info (images, hardpoints, stats) using multiple sources
        async function getFullShipInfo(shipName) {
            const slug = slugify(shipName);
            // Try SC Wiki stats endpoint
            try {
                const url = `https://api.star-citizen.wiki/v2/stats/latest/ship/${slug}`;
                const data = await fetchJsonRetry(url, {}, 2);
                if (data) {
                    // Normalizing keys across sources
                    const img = (data.media && data.media[0] && data.media[0].source_url) || data.image || null;
                    return {
                        source: 'SCWiki',
                        name: data.name || shipName,
                        manufacturer: data.manufacturer_name || data.manufacturer || null,
                        role: data.classification || data.role || null,
                        size: data.size || null,
                        image_url: img,
                        hp: data.hull_hit_points || data.hull || data.hitpoints || null,
                        shield: data.shield_points || data.shield || null,
                        cargo: data.cargo_capacity || data.cargo || null,
                        hardpoints: data.hardpoints || null,
                        raw: data
                    };
                }
            } catch (e) {
                console.debug('SCWiki stats failed for', shipName, e);
            }

            // Try FleetYards models endpoint (media often available)
            try {
                const url = `https://api.fleetyards.net/v1/models?slug=${slug}`;
                const data = await fetchJsonRetry(url, {}, 2);
                if (data) {
                    // sometimes returns array
                    const first = Array.isArray(data) ? data[0] : data;
                    const img = first?.media?.[0]?.source_url || first?.media?.[0]?.url || first?.image || null;
                    return {
                        source: 'FleetYards',
                        name: first?.name || shipName,
                        manufacturer: first?.manufacturer?.name || first?.manufacturer || null,
                        role: first?.classification || first?.class || null,
                        size: first?.size || null,
                        image_url: img,
                        hp: null,
                        shield: null,
                        cargo: first?.cargo || null,
                        hardpoints: first?.hardpoints || null,
                        raw: first
                    };
                }
            } catch (e) {
                console.debug('FleetYards failed for', shipName, e);
            }

            // Try StarCitizen-API
            try {
                const url = `https://api.starcitizen-api.com/ships/${slug}`;
                const data = await fetchJsonRetry(url, {}, 2);
                if (data) {
                    const img = (data.media && data.media[0] && data.media[0].url) || data.image || null;
                    return {
                        source: 'StarCitizen-API',
                        name: data.displayName || data.name || shipName,
                        manufacturer: data.manufacturer || null,
                        role: data.role || null,
                        size: data.size || null,
                        image_url: img,
                        hp: data.hull || data.hp || null,
                        shield: data.shields || null,
                        cargo: data.cargo || data.cargo_capacity || null,
                        hardpoints: data.hardpoints || null,
                        raw: data
                    };
                }
            } catch (e) {
                console.debug('StarCitizen-API failed for', shipName, e);
            }

            // As last resort, try a generic search on FleetYards for ship name (less reliable)
            try {
                const url = `https://api.fleetyards.net/v1/models?search=${encodeURIComponent(shipName)}`;
                const data = await fetchJsonRetry(url, {}, 1);
                if (data && data.length) {
                    const first = data[0];
                    const img = first?.media?.[0]?.source_url || first?.image || null;
                    return {
                        source: 'FleetYards-Search',
                        name: first?.name || shipName,
                        manufacturer: first?.manufacturer?.name || first?.manufacturer || null,
                        role: first?.classification || null,
                        size: first?.size || null,
                        image_url: img,
                        hp: null,
                        shield: null,
                        cargo: first?.cargo || null,
                        hardpoints: first?.hardpoints || null,
                        raw: first
                    };
                }
            } catch (e) {
                console.debug('FleetYards search failed', e);
            }

            // Fallback: minimal info with placeholder image
            return {
                source: 'Fallback',
                name: shipName,
                manufacturer: null,
                role: null,
                size: null,
                image_url: IMAGE_PLACEHOLDER,
                hp: null,
                shield: null,
                cargo: null,
                hardpoints: null,
                raw: null
            };
        }

        // Safely get image for ship or item (checks DB first)
        async function getImageForName(name, kind = 'ship') {
            if (!name) return IMAGE_PLACEHOLDER;
            try {
                if (kind === 'ship') {
                    const s = await db.ships.get(name);
                    if (s && s.image_url) return s.image_url;
                    // Try enrichment but do not block too long
                    const info = await getFullShipInfo(name);
                    if (info && info.image_url) {
                        await db.ships.update(name, { image_url: info.image_url || IMAGE_PLACEHOLDER });
                        return info.image_url;
                    }
                } else {
                    // items: attempt a FleetYards search for component or use placeholder
                    try {
                        const slug = slugify(name);
                        const url = `https://api.fleetyards.net/v1/models?search=${encodeURIComponent(name)}`;
                        const data = await fetchJsonRetry(url, {}, 1);
                        if (data && data.length && (data[0].media && data[0].media[0])) {
                            const urlImg = data[0].media[0].source_url || data[0].media[0].url;
                            return urlImg || IMAGE_PLACEHOLDER;
                        }
                    } catch (e) {
                        // ignore
                    }
                }
            } catch (e) {
                console.warn('getImageForName error', e);
            }
            return IMAGE_PLACEHOLDER;
        }

        // Get default ship data (fallback) - kept but simplified
        async function getDefaultShipData(shipName) {
            const defaults = {
                'Idris-M': { manufacturer: 'Aegis Dynamics', role: 'Military', size: 'Capital' },
                'Gladius': { manufacturer: 'Aegis Dynamics', role: 'Military', size: 'Small' },
                'Hull-D': { manufacturer: 'MISC', role: 'Industrial', size: 'Large' }
            };
            return defaults[shipName] || { manufacturer: 'Unknown', role: 'Other', size: 'Medium' };
        }

        // Get default loadout (fallback) - only used if ship has no user-provided loadout
        function getDefaultLoadout(shipName) {
            const defaults = {
                'Idris-M': 'Size 10 spinal gun, 7 manned turrets, missile launchers',
                'Gladius': '3x S3 repeaters, missiles',
                'Hull-D': 'Cargo-focused configuration'
            };
            return defaults[shipName] || 'Factory standard loadout';
        }

        // Get hardpoints (fallback) - now tries to use full info if available
        async function getShipHardpoints(shipName) {
            const s = await db.ships.get(shipName);
            if (s && s.hardpoints_json) {
                try { return JSON.parse(s.hardpoints_json); } catch(e){}
            }
            // Try to enrich
            try {
                const info = await getFullShipInfo(shipName);
                if (info && info.hardpoints) return info.hardpoints;
            } catch(e){}
            // Fallback
            const h = {
                weapons: ['Unknown hardpoints'],
                missiles: [],
                components: ['Standard components']
            };
            const mapping = {
                'Idris-M': {
                    weapons: ['1x S10 spinal gun', '7x manned turrets'],
                    missiles: ['4x S6 missile launchers'],
                    components: ['Capital shield generator']
                }
            };
            return mapping[shipName] || h;
        }

        // verifyData remains but improved to use getFullShipInfo where appropriate
        async function verifyData(itemName, itemType, forceUpdate = false, version = currentSCVersion) {
            try {
                if (itemType === 'ship') {
                    // attempt to fetch full ship info and derive a value if available from sources
                    const info = await getFullShipInfo(itemName);
                    // try to extract any price-like fields from known raw sources
                    let val = 0;
                    if (info && info.raw) {
                        const r = info.raw;
                        val = r.price_in_game || r.price || r.cost || 0;
                    }
                    // fallback heuristic
                    val = val || 1000;
                    return { value: Math.round(val), reliability: 1, sources: [info.source || 'unknown'] };
                } else {
                    // For items, attempt UEX first
                    try {
                        const res = await fetchWithTimeout(`https://uexcorp.space/api/2.0/commodities_prices?name=${encodeURIComponent(itemName)}`, {}, 4000);
                        if (res.ok) {
                            const j = await res.json();
                            const sell = j.sell_price || j.price || 0;
                            return { value: Math.round(sell), reliability: 0.9, sources: ['UEX'] };
                        }
                    } catch(e){}
                    // fallback
                    return { value: 0, reliability: 0.5, sources: [] };
                }
            } catch (e) {
                console.error('verifyData error', e);
                return { value: 0, reliability: 0.3, sources: [] };
            }
        }

        // ---------------- UI & CRUD functions (keep base behaviour, improve where needed) ----------------

        // Add Ship
        async function addShip() {
            const name = document.getElementById('ship-name').value?.trim();
            if (!name) { alert('Ship name required'); return; }
            const userLoadout = document.getElementById('ship-loadout').value?.trim();
            const imageUrlInput = document.getElementById('ship-image').value?.trim();
            const defaultData = await getDefaultShipData(name);
            const verified = await verifyData(name, 'ship', true, currentSCVersion);
            const imageUrl = imageUrlInput || (await getImageForName(name, 'ship')) || IMAGE_PLACEHOLDER;
            const loadoutValue = userLoadout || getDefaultLoadout(name);
            const loadoutSource = userLoadout ? 'user' : 'default';
            await db.ships.put({
                name,
                manufacturer: document.getElementById('ship-manufacturer').value || defaultData.manufacturer,
                role: document.getElementById('ship-role').value || defaultData.role,
                size: document.getElementById('ship-size').value || defaultData.size,
                value: verified.value || 0,
                owned_qty: parseInt(document.getElementById('ship-qty').value) || 1,
                location: document.getElementById('ship-location').value || '',
                loadout: loadoutValue,
                _loadout_source: loadoutSource,
                notes: document.getElementById('ship-notes').value || '',
                last_sync: Date.now(),
                data_reliability_score: verified.reliability || 0,
                image_url: imageUrl
            });
            await logAudit('Add Ship', name, verified);
            await updateDashboard();
            alert(`Added ship: ${name}`);
        }

        // Add Item
        async function addItem() {
            const name = document.getElementById('item-name').value?.trim();
            if (!name) { alert('Item name required'); return; }
            const verified = await verifyData(name, 'item', true, currentSCVersion);
            const imageUrl = await getImageForName(name, 'item');
            const id = await db.items.add({
                name,
                type: document.getElementById('item-type').value || 'component',
                size: document.getElementById('item-size').value || '',
                owned_qty: parseInt(document.getElementById('item-qty').value) || 1,
                value: verified.value || 0,
                location: document.getElementById('item-location').value || '',
                acquired_date: new Date(),
                buy_price: parseFloat(document.getElementById('item-buy-price').value) || 0,
                data_reliability_score: verified.reliability || 0,
                notes: document.getElementById('item-notes').value || '',
                image_url: imageUrl
            });
            await logAudit('Add Item', name, verified);
            await updateDashboard();
            await updateTrading();
            alert(`Added item: ${name} (id ${id})`);
        }

        // Audit log
        async function logAudit(action, itemName, changes) {
            try {
                await db.audit_log.add({
                    timestamp: new Date(),
                    source: action,
                    item_name: itemName,
                    changes: JSON.stringify(changes),
                    verified: true
                });
            } catch(e) { console.warn('logAudit failed', e); }
        }

        // Update Trading (keeps existing logic but uses cached image etc)
        async function updateTrading() {
            const tbody = document.querySelector('#trading-table tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            const items = await db.items.toArray();
            const commodities = items.filter(i => i.type === 'commodity' && i.owned_qty > 0);
            for (const c of commodities) {
                const buy = c.buy_price || c.value || 0;
                let sell = buy;
                try {
                    const response = await fetchWithTimeout(`https://uexcorp.space/api/2.0/commodities_prices?name=${encodeURIComponent(c.name)}`, {}, 5000);
                    if (response.ok) {
                        const data = await response.json();
                        sell = data.sell_price || Math.round(buy * 1.2);
                    }
                } catch (err) {
                    sell = Math.round(buy * 1.2);
                }
                const profit = Math.round((sell - buy) * (c.owned_qty || 1));
                const tr = tbody.insertRow();
                tr.insertCell().textContent = c.name;
                tr.insertCell().textContent = c.owned_qty || 0;
                tr.insertCell().textContent = 'New Babbage';
                tr.insertCell().textContent = sell.toLocaleString();
                tr.insertCell().textContent = profit.toLocaleString();
                tr.insertCell().textContent = profit > 2000 ? '⚠️' : '';
            }
        }

        // Wishlist functions
        async function updateWishlistTable() {
            const tbody = document.querySelector('#wishlist-table tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            const list = await db.wishlist.toArray();
            for (const w of list) {
                const tr = tbody.insertRow();
                tr.insertCell().textContent = w.name;
                tr.insertCell().textContent = w.type;
                tr.insertCell().textContent = w.target_price;
                const actions = tr.insertCell();
                const btn = document.createElement('button');
                btn.textContent = 'Remove';
                btn.addEventListener('click', () => removeWishlist(w.name));
                actions.appendChild(btn);
            }
        }

        async function addToWishlist() {
            const name = (document.getElementById('wishlist-name').value || '').trim();
            const type = document.getElementById('wishlist-type').value;
            const target = parseFloat(document.getElementById('wishlist-target-price').value) || 0;
            const notes = document.getElementById('wishlist-notes').value || '';
            if (!name) { alert('Wishlist name required'); return; }
            await db.wishlist.put({ name, type, target_price: target, notes });
            await updateWishlistTable();
            alert('Added to wishlist');
        }

        async function removeWishlist(name) {
            if (!confirm('Remove from wishlist?')) return;
            await db.wishlist.delete(name);
            await updateWishlistTable();
        }

        // Notifications
        function notify(msg) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(msg);
            } else {
                console.log('Notify:', msg);
            }
        }

        // Reliability class
        function getReliabilityClass(score) {
            const s = Number(score || 0);
            if (s >= 1) return 'reliability-green';
            if (s >= 0.8) return 'reliability-yellow';
            return 'reliability-red';
        }

        // ------------------ Dashboard & Rendering ------------------

        async function updateDashboard() {
            const ships = await db.ships.toArray();
            const items = await db.items.toArray();
            document.getElementById('ship-count').textContent = ships.length;
            document.getElementById('item-count').textContent = items.length;
            const tableBody = document.querySelector('#stats-table tbody');
            tableBody.innerHTML = '';
            // Render ships first
            for (const s of ships) {
                await addRowToTable(tableBody, s, 'ship');
            }
            // Then items
            for (const i of items) {
                await addRowToTable(tableBody, i, 'item');
            }
        }

        // Render a row (ship or item)
        async function addRowToTable(tableBody, item, type) {
            const row = tableBody.insertRow();
            const imageCell = row.insertCell();
            let displayImage = '';
            if (type === 'ship') {
                // ensure we have an image and enriched data cached
                try {
                    if (!item.image_url || !item.hp || !item.hardpoints_json) {
                        // enrich (but preserve user loadout)
                        const enriched = await getFullShipInfo(item.name);
                        const updateObj = {
                            manufacturer: enriched.manufacturer || item.manufacturer,
                            role: enriched.role || item.role,
                            size: enriched.size || item.size,
                            image_url: enriched.image_url || item.image_url || IMAGE_PLACEHOLDER,
                            hp: enriched.hp ?? item.hp,
                            shield: enriched.shield ?? item.shield,
                            cargo: enriched.cargo ?? item.cargo,
                            hardpoints_json: enriched.hardpoints ? JSON.stringify(enriched.hardpoints) : (item.hardpoints_json || null),
                            last_sync: Date.now(),
                            data_reliability_score: 1
                        };
                        // Loadout write: only if not user-provided
                        if (!item.loadout || item._loadout_source === 'default') {
                            updateObj.loadout = item.loadout || getDefaultLoadout(item.name);
                            updateObj._loadout_source = item._loadout_source || 'default';
                        }
                        await db.ships.update(item.name, updateObj);
                        item = { ...item, ...updateObj };
                    }
                } catch (e) {
                    console.warn('Enrich failed for', item.name, e);
                }
                displayImage = item.image_url || IMAGE_PLACEHOLDER;
            } else {
                displayImage = item.image_url || IMAGE_PLACEHOLDER;
            }

            if (displayImage) {
                const img = document.createElement('img');
                img.src = displayImage;
                img.loading = 'lazy';
                img.classList.add('ship-image');
                img.alt = item.name || '';
                img.addEventListener('error', () => { img.src = IMAGE_PLACEHOLDER; });
                imageCell.appendChild(img);
            } else {
                imageCell.textContent = '';
            }

            const nameCell = row.insertCell();
            const nameLink = document.createElement('span');
            nameLink.classList.add('name-link');
            nameLink.textContent = item.name || (type === 'ship' ? item.name : (item.name || 'Item'));
            nameLink.addEventListener('click', () => showDetail(item, type));
            nameCell.appendChild(nameLink);

            row.insertCell().textContent = type === 'ship' ? (item.manufacturer || '') : (item.type || '');
            row.insertCell().textContent = item.role || '';
            row.insertCell().textContent = item.size || '';
            row.insertCell().textContent = type === 'ship' ? (item.hp != null ? item.hp : 'N/A') : '';
            row.insertCell().textContent = type === 'ship' ? (item.shield != null ? item.shield : 'N/A') : '';
            row.insertCell().textContent = type === 'ship' ? (item.cargo != null ? item.cargo : 'N/A') : '';
            row.insertCell().textContent = item.owned_qty || 0;
            row.insertCell().textContent = item.location || '';
            row.insertCell().textContent = type === 'ship' ? (item.loadout || item.notes || '') : (item.notes || '');
            const relCell = row.insertCell();
            const relClass = getReliabilityClass(item.data_reliability_score ?? 0);
            relCell.classList.add(relClass);
            relCell.textContent = (typeof item.data_reliability_score === 'number') ? item.data_reliability_score : (item.data_reliability_score ?? 'N/A');

            const actionsCell = row.insertCell();
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.addEventListener('click', () => {
                const key = type === 'ship' ? item.name : item.id;
                editItem(type, String(key));
            });
            const delBtn = document.createElement('button');
            delBtn.textContent = 'Delete';
            delBtn.addEventListener('click', () => {
                const key = type === 'ship' ? item.name : item.id;
                deleteItem(type, String(key));
            });
            actionsCell.appendChild(editBtn);
            actionsCell.appendChild(document.createTextNode(' '));
            actionsCell.appendChild(delBtn);
        }

        // Show detail view
        async function showDetail(item, type) {
            currentDetailItem = item;
            currentDetailType = type;
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById('detail').classList.add('active');
            document.getElementById('detail-header').innerHTML = `${type.charAt(0).toUpperCase() + type.slice(1)}: ${item.name}`;
            const updateBtn = document.getElementById('update-ship-btn');
            const resetBtn = document.getElementById('reset-ship-btn');
            updateBtn.style.display = type === 'ship' ? 'inline-block' : 'none';
            resetBtn.style.display = type === 'ship' ? 'inline-block' : 'none';

            // Attempt a fresh enrichment for the detail view (non-destructive to user loadouts)
            let enriched = null;
            if (type === 'ship') {
                try {
                    enriched = await getFullShipInfo(item.name);
                    // update DB but preserve user loadout flag
                    const updateObj = {
                        manufacturer: enriched.manufacturer || item.manufacturer,
                        role: enriched.role || item.role,
                        size: enriched.size || item.size,
                        image_url: enriched.image_url || item.image_url || IMAGE_PLACEHOLDER,
                        hp: enriched.hp ?? item.hp,
                        shield: enriched.shield ?? item.shield,
                        cargo: enriched.cargo ?? item.cargo,
                        hardpoints_json: enriched.hardpoints ? JSON.stringify(enriched.hardpoints) : (item.hardpoints_json || null),
                        last_sync: Date.now(),
                        data_reliability_score: 1
                    };
                    // only replace loadout if ship._loadout_source !== 'user'
                    if (!item._loadout_source || item._loadout_source !== 'user') {
                        updateObj.loadout = item.loadout || getDefaultLoadout(item.name);
                        updateObj._loadout_source = item._loadout_source || 'default';
                    }
                    await db.ships.update(item.name, updateObj);
                    // read back item
                    item = await db.ships.get(item.name);
                } catch (e) {
                    console.warn('Detail enrichment failed', e);
                }
            }

            const detailInfo = document.getElementById('detail-info');
            detailInfo.innerHTML = '';
            const displayImage = (type === 'ship') ? (item.image_url || IMAGE_PLACEHOLDER) : (item.image_url || IMAGE_PLACEHOLDER);
            detailInfo.innerHTML += `
                <div class="detail-card">
                    <h4>Image</h4>
                    ${displayImage ? `<img src="${displayImage}" style="width:200px; height:auto;" onerror="this.src='${IMAGE_PLACEHOLDER}'">` : 'No Image'}
                </div>
            `;
            if (type === 'ship') {
                detailInfo.innerHTML += `
                    <div class="detail-card"><h4>Manufacturer</h4><p>${item.manufacturer || 'N/A'}</p></div>
                    <div class="detail-card"><h4>Role</h4><p>${item.role || 'N/A'}</p></div>
                    <div class="detail-card"><h4>Size</h4><p>${item.size || 'N/A'}</p></div>
                    <div class="detail-card"><h4>HP</h4><p>${item.hp != null ? item.hp : 'N/A'}</p></div>
                    <div class="detail-card"><h4>Shield</h4><p>${item.shield != null ? item.shield : 'N/A'}</p></div>
                    <div class="detail-card"><h4>Cargo Capacity (SCU)</h4><p>${item.cargo != null ? item.cargo : 'N/A'}</p></div>
                `;
                let hpjson = item.hardpoints_json ? JSON.parse(item.hardpoints_json) : null;
                if (hpjson) {
                    detailInfo.innerHTML += `
                        <div class="detail-card">
                            <h4>Hardpoints</h4>
                            <pre style="white-space: pre-wrap; color:#00FFFF;">${JSON.stringify(hpjson, null, 2)}</pre>
                        </div>
                    `;
                }
                detailInfo.innerHTML += `
                    <div class="detail-card"><h4>Loadout</h4><p>${item.loadout || 'N/A'}</p></div>
                    <div class="detail-card"><h4>Additional Notes</h4><p>${item.notes || 'N/A'}</p></div>
                    <div class="detail-card"><h4>Data Reliability Score</h4><p class="${getReliabilityClass(item.data_reliability_score ?? 0)}">${item.data_reliability_score ?? 'N/A'}</p></div>
                    <div class="detail-card"><h4>Last Sync</h4><p>${item.last_sync ? new Date(item.last_sync).toLocaleString() : 'Never'}</p></div>
                `;
            } else {
                detailInfo.innerHTML += `
                    <div class="detail-card"><h4>Name</h4><p>${item.name}</p></div>
                    <div class="detail-card"><h4>Type</h4><p>${item.type || ''}</p></div>
                    <div class="detail-card"><h4>Size</h4><p>${item.size || ''}</p></div>
                    <div class="detail-card"><h4>Quantity</h4><p>${item.owned_qty || 0}</p></div>
                    <div class="detail-card"><h4>Location</h4><p>${item.location || ''}</p></div>
                    <div class="detail-card"><h4>Buy Price</h4><p>${item.buy_price != null ? item.buy_price : 'N/A'}</p></div>
                    <div class="detail-card"><h4>Notes</h4><p>${item.notes || ''}</p></div>
                    <div class="detail-card"><h4>Data Reliability</h4><p class="${getReliabilityClass(item.data_reliability_score ?? 0)}">${item.data_reliability_score ?? 'N/A'}</p></div>
                `;
            }
        }

        // Go back to dashboard
        function goBackToDashboard() {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById('dashboard').classList.add('active');
            document.querySelector('.nav-tab[data-tab="dashboard"]').classList.add('active');
            currentDetailItem = null;
            currentDetailType = null;
        }

        // Edit & Delete
        async function editItem(type, idOrName) {
            const modal = document.getElementById('edit-modal');
            modal.style.display = 'block';
            editingItemKind = type;
            if (type === 'ship') {
                const ship = await db.ships.get(idOrName);
                if (!ship) { alert('Ship not found'); return; }
                editingItemKey = ship.name;
                document.getElementById('edit-name').value = ship.name;
                document.getElementById('edit-manufacturer').value = ship.manufacturer || '';
                document.getElementById('edit-role').value = ship.role || '';
                document.getElementById('edit-size').value = ship.size || '';
                document.getElementById('edit-qty').value = ship.owned_qty || 1;
                document.getElementById('edit-location').value = ship.location || '';
                document.getElementById('edit-loadout').value = ship.loadout || '';
                document.getElementById('edit-notes').value = ship.notes || '';
                document.getElementById('edit-image').value = ship.image_url || '';
                document.getElementById('edit-buy-price').value = '';
                document.getElementById('edit-type').style.display = 'none';
            } else {
                const itemId = Number(idOrName);
                const item = await db.items.get(itemId);
                if (!item) { alert('Item not found'); return; }
                editingItemKey = item.id;
                document.getElementById('edit-name').value = item.name;
                document.getElementById('edit-manufacturer').value = item.type || '';
                document.getElementById('edit-role').value = '';
                document.getElementById('edit-size').value = item.size || '';
                document.getElementById('edit-qty').value = item.owned_qty || 1;
                document.getElementById('edit-location').value = item.location || '';
                document.getElementById('edit-loadout').value = '';
                document.getElementById('edit-notes').value = item.notes || '';
                document.getElementById('edit-image').value = item.image_url || '';
                document.getElementById('edit-buy-price').value = item.buy_price || 0;
                document.getElementById('edit-type').style.display = 'block';
                document.getElementById('edit-type').value = item.type || 'component';
            }
        }

        async function deleteItem(type, idOrName) {
            if (!confirm('Delete this entry?')) return;
            if (type === 'ship') {
                try {
                    await db.ships.delete(idOrName);
                    await updateDashboard();
                    alert('Ship deleted');
                } catch (e) {
                    console.error(e);
                    alert('Delete failed');
                }
            } else {
                const itemId = Number(idOrName);
                try {
                    await db.items.delete(itemId);
                    await updateDashboard();
                    await updateTrading();
                    alert('Item deleted');
                } catch (e) {
                    console.error(e);
                    alert('Delete failed');
                }
            }
        }

        // Save modal edits
        document.getElementById('save-edit').addEventListener('click', async () => {
            if (!editingItemKind || editingItemKey == null) { alert('No edit target'); return; }
            if (editingItemKind === 'ship') {
                const updates = {
                    manufacturer: document.getElementById('edit-manufacturer').value || '',
                    role: document.getElementById('edit-role').value || '',
                    size: document.getElementById('edit-size').value || '',
                    owned_qty: parseInt(document.getElementById('edit-qty').value) || 1,
                    location: document.getElementById('edit-location').value || '',
                    notes: document.getElementById('edit-notes').value || '',
                    image_url: document.getElementById('edit-image').value || IMAGE_PLACEHOLDER
                };
                const newLoadout = document.getElementById('edit-loadout').value || '';
                if (newLoadout) {
                    updates.loadout = newLoadout;
                    updates._loadout_source = 'user';
                }
                try {
                    await db.ships.update(editingItemKey, updates);
                    await updateDashboard();
                    closeModal();
                } catch (e) {
                    console.error(e);
                    alert('Update failed');
                }
            } else {
                const itemId = Number(editingItemKey);
                const updates = {
                    type: document.getElementById('edit-type').value || 'component',
                    size: document.getElementById('edit-size').value || '',
                    owned_qty: parseInt(document.getElementById('edit-qty').value) || 1,
                    location: document.getElementById('edit-location').value || '',
                    notes: document.getElementById('edit-notes').value || '',
                    buy_price: parseFloat(document.getElementById('edit-buy-price').value) || 0,
                    image_url: document.getElementById('edit-image').value || ''
                };
                try {
                    await db.items.update(itemId, updates);
                    await updateDashboard();
                    await updateTrading();
                    closeModal();
                } catch (e) {
                    console.error(e);
                    alert('Update failed');
                }
            }
        });

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
            editingItemKey = null;
            editingItemKind = null;
        }

        // Search (keeps original behavior)
        async function performSearch() {
            const q = (document.getElementById('search-query').value || '').toLowerCase();
            const typeFilter = document.getElementById('search-filter-type').value;
            const manuf = (document.getElementById('search-filter-manufacturer').value || '').toLowerCase();
            const role = document.getElementById('search-filter-role').value;
            const size = document.getElementById('search-filter-size').value;
            const location = (document.getElementById('search-filter-location').value || '').toLowerCase();

            const results = [];
            const ships = await db.ships.toArray();
            const items = await db.items.toArray();

            ships.forEach(s => {
                let match = true;
                if (q && !s.name.toLowerCase().includes(q)) match = false;
                if (manuf && !(s.manufacturer || '').toLowerCase().includes(manuf)) match = false;
                if (role && s.role !== role) match = false;
                if (size && s.size !== size) match = false;
                if (location && !(s.location || '').toLowerCase().includes(location)) match = false;
                if (typeFilter && typeFilter !== 'ship') match = false;
                if (match) results.push({ ...s, __kind: 'ship' });
            });

            items.forEach(i => {
                let match = true;
                if (q && !i.name.toLowerCase().includes(q)) match = false;
                if (typeFilter && typeFilter !== '' && typeFilter !== i.type && typeFilter !== 'item') match = false;
                if (manuf && !(i.type || '').toLowerCase().includes(manuf)) match = false;
                if (role && i.role && i.role !== role) match = false;
                if (size && i.size !== size) match = false;
                if (location && !(i.location || '').toLowerCase().includes(location)) match = false;
                if (match) results.push({ ...i, __kind: 'item' });
            });

            const tbody = document.querySelector('#search-table tbody');
            tbody.innerHTML = '';
            for (const r of results) {
                const tr = tbody.insertRow();
                const imgCell = tr.insertCell();
                const displayImage = r.__kind === 'ship' ? (r.image_url || IMAGE_PLACEHOLDER) : (r.image_url || IMAGE_PLACEHOLDER);
                if (displayImage) {
                    const img = document.createElement('img');
                    img.src = displayImage;
                    img.classList.add('ship-image');
                    img.loading = 'lazy';
                    img.addEventListener('error', () => img.src = IMAGE_PLACEHOLDER);
                    imgCell.appendChild(img);
                }
                const nameCell = tr.insertCell(); 
                nameCell.textContent = r.name;
                tr.insertCell().textContent = r.__kind === 'ship' ? (r.manufacturer || '') : (r.type || '');
                tr.insertCell().textContent = r.role || '';
                tr.insertCell().textContent = r.size || '';
                tr.insertCell().textContent = r.owned_qty || 0;
                tr.insertCell().textContent = r.location || '';
                tr.insertCell().textContent = r.__kind === 'ship' ? (r.loadout || r.notes || '') : (r.notes || '');
                const rel = tr.insertCell(); 
                rel.classList.add(getReliabilityClass(r.data_reliability_score ?? 0)); 
                rel.textContent = r.data_reliability_score ?? '';
                const actions = tr.insertCell();
                const key = r.__kind === 'ship' ? r.name : r.id;
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', () => editItem(r.__kind === 'ship' ? 'ship' : 'item', String(key)));
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete';
                delBtn.addEventListener('click', () => deleteItem(r.__kind === 'ship' ? 'ship' : 'item', String(key)));
                actions.appendChild(editBtn);
                actions.appendChild(document.createTextNode(' '));
                actions.appendChild(delBtn);
            }

            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById('search').classList.add('active');
        }

        // Sync Data - respect user loadouts and cache enriched fields. If force==true user confirmed updates.
        async function syncData(force = false) {
            if (!navigator.onLine) {
                document.getElementById('offline-banner').style.display = 'block';
                return;
            }
            document.getElementById('offline-banner').style.display = 'none';
            document.getElementById('sync-status').style.display = 'block';
            try {
                const ships = await db.ships.toArray();
                for (const ship of ships) {
                    const needsEnrich = !ship.last_sync || (Date.now() - ship.last_sync > ENRICHMENT_STALE_MS) || ship.enriched_version !== currentSCVersion;
                    if (needsEnrich || force) {
                        try {
                            const enriched = await getFullShipInfo(ship.name);
                            const updateObj = {
                                manufacturer: enriched.manufacturer || ship.manufacturer,
                                role: enriched.role || ship.role,
                                size: enriched.size || ship.size,
                                image_url: enriched.image_url || ship.image_url || IMAGE_PLACEHOLDER,
                                hp: enriched.hp ?? ship.hp,
                                shield: enriched.shield ?? ship.shield,
                                cargo: enriched.cargo ?? ship.cargo,
                                hardpoints_json: enriched.hardpoints ? JSON.stringify(enriched.hardpoints) : ship.hardpoints_json,
                                last_sync: Date.now(),
                                data_reliability_score: 1,
                                enriched_version: currentSCVersion
                            };
                            // Only set loadout if ship has no loadout or loadout source is 'default'
                            if (!ship.loadout || ship._loadout_source === 'default') {
                                updateObj.loadout = ship.loadout || getDefaultLoadout(ship.name);
                                updateObj._loadout_source = 'default';
                            }
                            // If value changes drastically ask user (unless force)
                            if (ship.value && enriched.raw && (enriched.raw.price_in_game || enriched.raw.price)) {
                                const newVal = enriched.raw.price_in_game || enriched.raw.price;
                                const variance = Math.abs(newVal - ship.value) / (ship.value || 1);
                                if (variance > 0.2 && !force) {
                                    if (!confirm(`Update ${ship.name} value from ${ship.value.toLocaleString()} to ${Math.round(newVal).toLocaleString()} aUEC? (Variance ${(variance*100).toFixed(1)}%)`)) {
                                        updateObj.value = ship.value;
                                    } else {
                                        updateObj.value = Math.round(newVal);
                                    }
                                } else {
                                    updateObj.value = Math.round(newVal || ship.value || 0);
                                }
                            } else if (enriched.raw && (enriched.raw.price_in_game || enriched.raw.price)) {
                                updateObj.value = Math.round(enriched.raw.price_in_game || enriched.raw.price || ship.value || 0);
                            }
                            await db.ships.update(ship.name, updateObj);
                        } catch (e) {
                            console.warn('Failed to enrich ship during sync:', ship.name, e);
                        }
                    }
                }
                // Items sync
                const items = await db.items.toArray();
                for (const item of items) {
                    const verified = await verifyData(item.name, 'item', force, currentSCVersion);
                    const variance = item.value ? Math.abs(verified.value - item.value) / (item.value || 1) : 0;
                    if (variance > 0.2 || force) {
                        if (!force && variance > 0.2 && !confirm(`Update ${item.name} value from ${item.value} to ${verified.value}?`)) continue;
                        await db.items.update(item.id, { value: verified.value, data_reliability_score: verified.reliability });
                    }
                }
            } finally {
                document.getElementById('sync-status').style.display = 'none';
                await updateDashboard();
                await updateTrading();
                await updateWishlistTable();
            }
        }

        // Auto-sync if needed on init
        async function autoSyncIfNeeded() {
            const ships = await db.ships.toArray();
            const now = Date.now();
            for (const ship of ships) {
                if (!ship.last_sync || (now - ship.last_sync > ENRICHMENT_STALE_MS) || ship.enriched_version !== currentSCVersion) {
                    // perform background enrichment but not blocking init UI
                    syncData(false).catch(e => console.warn('Background sync failed', e));
                    break;
                }
            }
        }

        // Default ships insertion if DB empty
        async function addDefaultShips() {
            const shipCount = await db.ships.count();
            if (shipCount === 0) {
                const defaults = [
                    { name: 'Idris-M', owned_qty: 1, location: 'Area18', loadout: getDefaultLoadout('Idris-M'), notes: 'Default' },
                    { name: 'Gladius', owned_qty: 1, location: 'Area18', loadout: getDefaultLoadout('Gladius'), notes: 'Default' },
                    { name: 'Hull-D', owned_qty: 1, location: 'Area18', loadout: getDefaultLoadout('Hull-D'), notes: 'Default' }
                ];
                for (const ship of defaults) {
                    try {
                        const enriched = await getFullShipInfo(ship.name);
                        await db.ships.put({
                            name: ship.name,
                            manufacturer: enriched.manufacturer || ship.manufacturer,
                            role: enriched.role || ship.role || 'Unknown',
                            size: enriched.size || ship.size || 'Medium',
                            value: enriched.raw && (enriched.raw.price_in_game || enriched.raw.price) ? (enriched.raw.price_in_game || enriched.raw.price) : (ship.value || 0),
                            owned_qty: ship.owned_qty || 1,
                            location: ship.location,
                            loadout: ship.loadout,
                            _loadout_source: 'default',
                            notes: ship.notes || '',
                            image_url: enriched.image_url || IMAGE_PLACEHOLDER,
                            hp: enriched.hp || null,
                            shield: enriched.shield || null,
                            cargo: enriched.cargo || null,
                            hardpoints_json: enriched.hardpoints ? JSON.stringify(enriched.hardpoints) : null,
                            last_sync: Date.now(),
                            data_reliability_score: 1,
                            enriched_version: currentSCVersion
                        });
                    } catch (e) {
                        console.warn('Failed to add default ship', ship.name, e);
                        await db.ships.put({
                            name: ship.name,
                            manufacturer: ship.manufacturer || 'Unknown',
                            role: ship.role || 'Unknown',
                            size: ship.size || 'Medium',
                            value: ship.value || 0,
                            owned_qty: ship.owned_qty || 1,
                            location: ship.location || '',
                            loadout: ship.loadout || '',
                            _loadout_source: 'default',
                            notes: ship.notes || '',
                            image_url: IMAGE_PLACEHOLDER,
                            last_sync: Date.now(),
                            data_reliability_score: 0.5
                        });
                    }
                }
            }
        }

        // ---------------- Import / Export ----------------
        document.getElementById('export-btn').addEventListener('click', async () => {
            const ships = await db.ships.toArray();
            const items = await db.items.toArray();
            const wishlist = await db.wishlist.toArray();
            const exportObj = { ships, items, wishlist, exportedAt: new Date().toISOString(), sc_version: currentSCVersion };
            const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sc_fleet_export.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });

        document.getElementById('import-btn').addEventListener('click', () => {
            document.getElementById('import-file').click();
        });

        document.getElementById('import-file').addEventListener('change', async (e) => {
            const f = e.target.files[0];
            if (!f) return;
            try {
                const text = await f.text();
                const data = JSON.parse(text);
                if (data.ships && Array.isArray(data.ships)) {
                    for (const s of data.ships) {
                        if (s.name) {
                            // preserve any user loadout marker if present, otherwise assume imported loadout is user
                            s._loadout_source = s._loadout_source || (s.loadout ? 'user' : 'default');
                            await db.ships.put(s);
                        }
                    }
                }
                if (data.items && Array.isArray(data.items)) {
                    for (const it of data.items) {
                        if (it.id) await db.items.put(it);
                        else await db.items.add(it);
                    }
                }
                if (data.wishlist && Array.isArray(data.wishlist)) {
                    for (const w of data.wishlist) await db.wishlist.put(w);
                }
                await updateDashboard();
                await updateTrading();
                await updateWishlistTable();
                alert('Import complete');
            } catch (err) {
                console.error(err);
                alert('Import failed: invalid JSON');
            } finally {
                e.target.value = '';
            }
        });

        // Modal close wiring
        document.querySelector('#edit-modal .close').addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target === document.getElementById('edit-modal')) closeModal();
        });

        // Sync button
        document.getElementById('sync-btn').onclick = () => syncData(true);

        // Settings handlers
        function saveUexKey() {
            const key = document.getElementById('uex-key').value || '';
            localStorage.setItem('uexKey', key);
            alert('UEX key saved locally (client-side).');
        }
        function saveUserHandle() {
            const h = document.getElementById('user-handle-input').value || '';
            if (h) {
                localStorage.setItem('userHandle', h);
                document.getElementById('user-handle').textContent = h;
                alert('Handle saved');
            } else {
                alert('Enter a handle first');
            }
        }

        // ---------------- Init ----------------
        async function init() {
            createStars();
            await fetchSCVersion();
            document.getElementById('app-header').innerHTML = document.title + '<br><small>UEE Citizen Console - Citizen: <span id="user-handle">' + (localStorage.getItem('userHandle') || 'Anonymous') + '</span></small>';
            await addDefaultShips();
            await autoSyncIfNeeded();
            await updateDashboard();
            await updateWishlistTable();
            await updateTrading();
            if (!navigator.onLine) document.getElementById('offline-banner').style.display = 'block';
            if ('Notification' in window) Notification.requestPermission().catch(()=>{});
        }

        function createStars() {
            const starfield = document.querySelector('.starfield');
            for (let i = 0; i < 200; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                star.style.width = star.style.height = Math.random() * 2 + 'px';
                star.style.top = Math.random() * 100 + '%';
                star.style.left = Math.random() * 100 + '%';
                starfield.appendChild(star);
            }
        }

        // Navigation wiring (preserve original look)
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const t = tab.getAttribute('data-tab');
                document.querySelectorAll('.nav-tab').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(t).classList.add('active');
            });
        });

        // Start
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
