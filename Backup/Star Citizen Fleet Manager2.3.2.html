<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Star Citizen Fleet Manager v2.3.2 (Fixed)</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/dexie@3/dist/dexie.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Orbitron', Arial, sans-serif;
            background: radial-gradient(circle, #001022, #000000);
            color: #00FFFF;
            overflow-x: hidden;
            position: relative;
        }
        /* Starfield */
        .starfield {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
        }
        .holo-panel {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00FFFF;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.7);
            border-radius: 8px;
            padding: 20px;
            margin: 20px auto;
            max-width: 1200px;
            backdrop-filter: blur(5px);
            animation: boot-up 1s ease-in-out;
            position: relative;
            z-index: 1;
        }
        @keyframes boot-up {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .header {
            text-align: center;
            text-shadow: 0 0 5px #00FFFF;
            font-size: 2em;
        }
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        .nav-tab {
            padding: 10px 20px;
            margin: 0 5px;
            border: 2px solid #00FFFF;
            border-radius: 5px;
            cursor: pointer;
            transition: box-shadow 0.3s;
        }
        .nav-tab:hover {
            box-shadow: 0 0 15px #00FFFF;
        }
        .nav-tab.active {
            background: rgba(0, 255, 255, 0.2);
            border-bottom: 4px solid #FF4500;
        }
        .content {
            display: none;
        }
        .content.active {
            display: block;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .metric-card {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00FFFF;
            padding: 15px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        .alert {
            color: #FF4500;
            text-shadow: 0 0 5px #FF4500;
        }
        input, select, button {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00FFFF;
            color: #00FFFF;
            padding: 5px;
            margin: 5px;
            font-family: 'Orbitron', Arial, sans-serif;
        }
        button:hover {
            box-shadow: 0 0 10px #00FFFF;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #00FFFF;
            padding: 8px;
            text-align: left;
        }
        th {
            background: rgba(0, 255, 255, 0.1);
            cursor: pointer;
        }
        .confidence-green { color: #00FF88; }
        .confidence-yellow { color: #FFFF66; }
        .confidence-red { color: #FF4500; }
        #offline-banner {
            background: rgba(255, 69, 0, 0.8);
            color: white;
            text-align: center;
            padding: 10px;
            display: none;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .ship-image {
            width: 100px;
            height: auto;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: rgba(0,0,0,0.8);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #00FFFF;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 0 15px #00FFFF;
        }
        .close {
            color: #00FFFF;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #FF4500;
            text-decoration: none;
            cursor: pointer;
        }
        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0,0,0,0.8);
            color: #00FFFF;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .detail-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .detail-card {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00FFFF;
            padding: 15px;
            border-radius: 5px;
        }
        .back-button {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #FF4500;
            color: #FF4500;
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Orbitron', Arial, sans-serif;
        }
        .back-button:hover {
            box-shadow: 0 0 10px #FF4500;
        }
        .name-link {
            color: #00FFFF;
            text-decoration: underline;
            cursor: pointer;
        }
        .name-link:hover {
            color: #FF4500;
        }
        .sync-status {
            color: #00FFFF;
            font-size: 0.9em;
            display: none;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="starfield"></div>
    <div id="offline-banner" class="alert">Offline Mode - Using Cached Data</div>
    <div class="holo-panel">
        <div class="header" id="app-header"><small>UEE Citizen Console - Citizen: <span id="user-handle">Anonymous</span></small></div>
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard">Dashboard HUD</div>
            <div class="nav-tab" data-tab="add">Add Asset</div>
            <div class="nav-tab" data-tab="search">Search Fleet</div>
            <div class="nav-tab" data-tab="trading">Trade Routes</div>
            <div class="nav-tab" data-tab="wishlist">Wishlist Scanner</div>
            <div class="nav-tab" data-tab="settings">Settings</div>
        </div>
        <button id="sync-btn">Sync with Verse</button>
        <div id="sync-status" class="sync-status">Syncing data...</div>
        <button id="export-btn">Export Hangar Data</button>
        <button id="import-btn">Import JSON</button>
        <input type="file" id="import-file" style="display: none;">
        <div id="dashboard" class="content active">
            <div class="metrics-grid">
                <div class="metric-card">Ships: <span id="ship-count">0</span></div>
                <div class="metric-card">Items: <span id="item-count">0</span></div>
            </div>
            <table id="stats-table">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th data-sort="name">Name</th>
                        <th data-sort="manufacturer">Manufacturer</th>
                        <th data-sort="role">Role</th>
                        <th data-sort="size">Size</th>
                        <th data-sort="owned_qty">Qty</th>
                        <th data-sort="location">Location</th>
                        <th>Loadout/Notes</th>
                        <th data-sort="confidence_score">Confidence <span class="tooltip">?<span class="tooltiptext">Confidence score indicates data accuracy from multiple sources. Green: High (variance <10%), Yellow: Medium (10-15%), Red: Low (>15%).</span></span></th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="add" class="content">
            <div class="form-grid">
                <div>
                    <h3>Add Ship</h3>
                    <input id="ship-name" placeholder="Name">
                    <input id="ship-manufacturer" placeholder="Manufacturer">
                    <select id="ship-role">
                        <option value="">Select Role</option>
                        <option>Military</option>
                        <option>Civilian</option>
                        <option>Industrial</option>
                        <option>Miner</option>
                        <option>Ground Vehicle</option>
                        <option>Other</option>
                    </select>
                    <input id="ship-size" placeholder="Size (Small/Medium/Large/Capital)">
                    <input id="ship-qty" type="number" placeholder="Quantity" value="1">
                    <input id="ship-location" placeholder="Location">
                    <input id="ship-loadout" placeholder="Loadout">
                    <input id="ship-notes" placeholder="Notes">
                    <input id="ship-image" placeholder="Image URL (optional)">
                    <button onclick="addShip()">Add Ship</button>
                </div>
                <div>
                    <h3>Add Item</h3>
                    <input id="item-name" placeholder="Name">
                    <select id="item-type">
                        <option>weapon</option>
                        <option>armor</option>
                        <option>component</option>
                        <option>commodity</option>
                    </select>
                    <input id="item-size" placeholder="Size">
                    <input id="item-qty" type="number" placeholder="Quantity" value="1">
                    <input id="item-location" placeholder="Location">
                    <input id="item-buy-price" type="number" placeholder="Buy Price (aUEC/SCU)">
                    <input id="item-notes" placeholder="Notes">
                    <button onclick="addItem()">Add Item</button>
                </div>
            </div>
        </div>
        <div id="search" class="content">
            <div class="filter-group">
                <input id="search-query" placeholder="Search Name...">
                <select id="search-filter-type">
                    <option value="">All Types</option>
                    <option>ship</option>
                    <option>weapon</option>
                    <option>armor</option>
                    <option>component</option>
                    <option>commodity</option>
                </select>
                <input id="search-filter-manufacturer" placeholder="Manufacturer Filter">
                <select id="search-filter-role">
                    <option value="">All Roles</option>
                    <option>Military</option>
                    <option>Civilian</option>
                    <option>Industrial</option>
                    <option>Miner</option>
                    <option>Ground Vehicle</option>
                    <option>Other</option>
                </select>
                <select id="search-filter-size">
                    <option value="">All Sizes</option>
                    <option>Small</option>
                    <option>Medium</option>
                    <option>Large</option>
                    <option>Capital</option>
                </select>
                <input id="search-filter-location" placeholder="Location Filter">
                <button onclick="performSearch()">Search</button>
            </div>
            <table id="search-table">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Manufacturer/Type</th>
                        <th>Role</th>
                        <th>Size</th>
                        <th>Qty</th>
                        <th>Location</th>
                        <th>Loadout/Notes</th>
                        <th>Confidence</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="trading" class="content">
            <table id="trading-table">
                <thead>
                    <tr>
                        <th>Commodity</th>
                        <th>Qty</th>
                        <th>Best Port</th>
                        <th>Sell/SCU</th>
                        <th>Profit</th>
                        <th>Alert</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="wishlist" class="content">
            <h3>Add to Wishlist</h3>
            <input id="wishlist-name" placeholder="Name">
            <select id="wishlist-type">
                <option>ship</option>
                <option>item</option>
            </select>
            <input id="wishlist-target-price" type="number" placeholder="Target Price">
            <input id="wishlist-notes" placeholder="Notes">
            <button onclick="addToWishlist()">Add</button>
            <table id="wishlist-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Target Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="settings" class="content">
            <h3>Settings</h3>
            <input id="uex-key" placeholder="UEX API Key">
            <button onclick="saveUexKey()">Save UEX Key</button>
            <input id="user-handle-input" placeholder="User Handle">
            <button onclick="saveUserHandle()">Save Handle</button>
        </div>
        <!-- Detail View -->
        <div id="detail" class="content">
            <div id="detail-header" class="header"></div>
            <div id="detail-info" class="detail-info"></div>
            <button id="back-btn" class="back-button" onclick="goBackToDashboard()">Back to Dashboard</button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Edit Asset</h3>
            <input id="edit-name" placeholder="Name" disabled>
            <input id="edit-manufacturer" placeholder="Manufacturer/Type">
            <select id="edit-role">
                <option value="">Select Role</option>
                <option>Military</option>
                <option>Civilian</option>
                <option>Industrial</option>
                <option>Miner</option>
                <option>Ground Vehicle</option>
                <option>Other</option>
            </select>
            <input id="edit-size" placeholder="Size">
            <input id="edit-qty" type="number" placeholder="Quantity">
            <input id="edit-location" placeholder="Location">
            <input id="edit-loadout" placeholder="Loadout (for ships)">
            <input id="edit-notes" placeholder="Notes">
            <input id="edit-buy-price" type="number" placeholder="Buy Price (for items)">
            <input id="edit-image" placeholder="Image URL">
            <select id="edit-type" style="display:none;">
                <option>weapon</option>
                <option>armor</option>
                <option>component</option>
                <option>commodity</option>
            </select>
            <button id="save-edit">Save Changes</button>
        </div>
    </div>

    <script>
        // Global variables for navigation state
        let currentDetailItem = null;
        let currentDetailType = null;
        let editingItemKey = null; // for modal: ship name or item id
        let editingItemKind = null; // 'ship' or 'item'

        // DB Setup
        const db = new Dexie('SCFleetManager');
        db.version(4).stores({
            ships: 'name, manufacturer, role, size, value, owned_qty, location, loadout, notes, last_sync, confidence_score, image_url',
            items: '++id, name, type, size, owned_qty, value, location, acquired_date, buy_price, confidence_score, notes',
            wishlist: 'name, type, target_price, notes',
            audit_log: '++id, timestamp, source, item_name, changes, verified',
            settings: 'key, value',
            history: '++id, timestamp, total_value'
        });

        // Data source stubs (adjust endpoints to real ones when ready)
        const sources = [
            { name: 'SC Wiki API', url: 'https://api.starcitizen.wiki/v1/vehicles?search=', field: 'price_in_game' },
            { name: 'FleetYards API', url: 'https://api.fleetyards.net/vehicles?search=', field: 'price' }
        ];

        let uexKey = localStorage.getItem('uexKey') || '';

        // verifyData - tolerant stubbed fetch (will work if APIs match or fallback)
        async function verifyData(itemName, itemType, forceUpdate = false) {
            try {
                const results = [];
                for (const src of sources) {
                    try {
                        const response = await fetch(`${src.url}${encodeURIComponent(itemName)}`);
                        if (response.ok) {
                            const data = await response.json();
                            // Try common shapes
                            let match = null;
                            if (Array.isArray(data)) match = data[0];
                            else if (data.data && Array.isArray(data.data)) match = data.data[0];
                            else if (data.result && Array.isArray(data.result)) match = data.result[0];
                            else if (typeof data === 'object' && Object.keys(data).length && data[0]) match = data[0];

                            const val = match ? (match[src.field] || match.price_in_game || match.price || match.price_uec || 0) : 0;
                            results.push({ source: src.name, value: typeof val === 'number' ? val : parseFloat(val) || 0 });
                        } else {
                            console.warn(`Fetch failed for ${src.name}: ${response.status}`);
                        }
                    } catch (err) {
                        console.warn(`Error fetching ${src.name}:`, err);
                    }
                }
                if (results.length === 0) {
                    // fallback: small deterministic mock so new items get numeric value
                    return { value: 1000, confidence: 0.5, sources: ['Fallback'] };
                }
                const values = results.map(r => r.value).filter(v => v > 0);
                if (values.length < 2) return { value: values[0] || 0, confidence: 0.5, sources: results.map(r => r.source) };
                const avg = values.reduce((a, b) => a + b, 0) / values.length;
                const maxDiff = Math.max(...values.map(v => Math.abs(v - avg)));
                const variance = avg === 0 ? 0 : maxDiff / avg;
                const confidence = variance < 0.1 ? 1 : variance < 0.15 ? 0.8 : 0.6;
                return { value: Math.round(avg), confidence, sources: results.map(r => r.source) };
            } catch (error) {
                console.error('Verification error:', error);
                return { value: 0, confidence: 0.3, sources: [] };
            }
        }

        // autoSyncIfNeeded - fixed (no undefined vars)
        async function autoSyncIfNeeded() {
            const ships = await db.ships.toArray();
            const now = Date.now();
            const staleThreshold = 24 * 60 * 60 * 1000; // 24 hours
            let needsUpdate = false;
            for (const ship of ships) {
                if (!ship.last_sync || (now - ship.last_sync > staleThreshold)) {
                    needsUpdate = true;
                    break;
                }
            }
            if (needsUpdate) {
                document.getElementById('sync-status').style.display = 'block';
                await syncData(true); // Force update
                document.getElementById('sync-status').style.display = 'none';
            }
        }

        async function addShip() {
            const name = document.getElementById('ship-name').value?.trim();
            if (!name) { alert('Ship name required'); return; }
            const verified = await verifyData(name, 'ship', true);
            await db.ships.put({
                name,
                manufacturer: document.getElementById('ship-manufacturer').value || '',
                role: document.getElementById('ship-role').value || '',
                size: document.getElementById('ship-size').value || '',
                value: verified.value || 0,
                owned_qty: parseInt(document.getElementById('ship-qty').value) || 1,
                location: document.getElementById('ship-location').value || '',
                loadout: document.getElementById('ship-loadout').value || '',
                notes: document.getElementById('ship-notes').value || '',
                last_sync: Date.now(),
                confidence_score: verified.confidence || 0,
                image_url: document.getElementById('ship-image').value || ''
            });
            await logAudit('Add Ship', name, verified);
            updateDashboard();
            alert(`Added ship: ${name}`);
        }

        async function addItem() {
            const name = document.getElementById('item-name').value?.trim();
            if (!name) { alert('Item name required'); return; }
            const verified = await verifyData(name, 'item', true);
            const id = await db.items.add({
                name,
                type: document.getElementById('item-type').value || 'component',
                size: document.getElementById('item-size').value || '',
                owned_qty: parseInt(document.getElementById('item-qty').value) || 1,
                value: verified.value || 0,
                location: document.getElementById('item-location').value || '',
                acquired_date: new Date(),
                buy_price: parseFloat(document.getElementById('item-buy-price').value) || 0,
                confidence_score: verified.confidence || 0,
                notes: document.getElementById('item-notes').value || ''
            });
            await logAudit('Add Item', name, verified);
            updateDashboard();
            updateTrading();
            alert(`Added item: ${name} (id ${id})`);
        }

        async function logAudit(action, itemName, changes) {
            await db.audit_log.add({
                timestamp: new Date(),
                source: action,
                item_name: itemName,
                changes: JSON.stringify(changes),
                verified: true
            });
        }

        // Enhanced syncData (safe checks)
        async function syncData(force = false) {
            if (!navigator.onLine) {
                document.getElementById('offline-banner').style.display = 'block';
                return;
            }
            document.getElementById('offline-banner').style.display = 'none';
            document.getElementById('sync-status').style.display = 'block';
            const ships = await db.ships.toArray();
            for (const ship of ships) {
                const verified = await verifyData(ship.name, 'ship', force);
                if (!ship.value) {
                    await db.ships.update(ship.name, { value: verified.value || ship.value, confidence_score: verified.confidence || ship.confidence_score, last_sync: Date.now() });
                    continue;
                }
                const variance = ship.value ? Math.abs(verified.value - ship.value) / ship.value : 0;
                if (variance > 0.15 || force) {
                    if (!force && variance > 0.15 && !confirm(`Update ${ship.name} value from ${ship.value.toLocaleString()} to ${verified.value.toLocaleString()} aUEC? (Variance: ${(variance*100).toFixed(1)}%)`)) {
                        continue;
                    }
                    await db.ships.update(ship.name, {
                        value: verified.value,
                        confidence_score: verified.confidence,
                        last_sync: Date.now()
                    });
                }
            }
            const items = await db.items.toArray();
            for (const item of items) {
                const verified = await verifyData(item.name, 'item', force);
                const variance = item.value ? Math.abs(verified.value - item.value) / item.value : 0;
                if (variance > 0.15 || force) {
                    if (!force && variance > 0.15 && !confirm(`Update ${item.name} value from ${item.value.toLocaleString()} to ${verified.value.toLocaleString()} aUEC?`)) {
                        continue;
                    }
                    await db.items.update(item.id, {
                        value: verified.value,
                        confidence_score: verified.confidence
                    });
                }
            }
            updateDashboard();
            updateTrading();
            checkWishlistAlerts();
            document.getElementById('sync-status').style.display = 'none';
        }

        async function updateDashboard() {
            const ships = await db.ships.toArray();
            const items = await db.items.toArray();

            document.getElementById('ship-count').textContent = ships.length;
            document.getElementById('item-count').textContent = items.length;

            const tableBody = document.querySelector('#stats-table tbody');
            tableBody.innerHTML = '';
            ships.forEach(s => addRowToTable(tableBody, s, 'ship'));
            items.forEach(i => addRowToTable(tableBody, i, 'item'));
        }

        function addRowToTable(tableBody, item, type) {
            const row = tableBody.insertRow();
            const imageCell = row.insertCell();
            if (item.image_url) {
                const img = document.createElement('img');
                img.src = item.image_url;
                img.classList.add('ship-image');
                imageCell.appendChild(img);
            } else {
                imageCell.textContent = '';
            }
            const nameCell = row.insertCell();
            const nameLink = document.createElement('span');
            nameLink.classList.add('name-link');
            nameLink.textContent = item.name;
            nameLink.onclick = () => showDetail(item, type);
            nameCell.appendChild(nameLink);
            row.insertCell().textContent = type === 'ship' ? (item.manufacturer || '') : (item.type || '');
            row.insertCell().textContent = item.role || '';
            row.insertCell().textContent = item.size || '';
            row.insertCell().textContent = item.owned_qty || 0;
            row.insertCell().textContent = item.location || '';
            row.insertCell().textContent = type === 'ship' ? (item.loadout || item.notes || '') : (item.notes || '');
            const confCell = row.insertCell();
            const confClass = getConfidenceClass(item.confidence_score ?? 0);
            confCell.classList.add(confClass);
            confCell.textContent = typeof item.confidence_score === 'number' ? item.confidence_score : (item.confidence_score ?? 'N/A');
            const actionsCell = row.insertCell();
            const idOrName = type === 'ship' ? item.name : item.id;
            actionsCell.innerHTML = `<button onclick="editItem('${type}', '${idOrName}')">Edit</button> <button onclick="deleteItem('${type}', '${idOrName}')">Delete</button>`;
        }

        function getConfidenceClass(score) {
            const s = Number(score || 0);
            if (s >= 1) return 'confidence-green';
            if (s >= 0.8) return 'confidence-yellow';
            return 'confidence-red';
        }

        // Detail View Functions
        async function showDetail(item, type) {
            currentDetailItem = item;
            currentDetailType = type;
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById('detail').classList.add('active');
            document.getElementById('detail-header').innerHTML = `${type.charAt(0).toUpperCase() + type.slice(1)}: ${item.name}`;
            const detailInfo = document.getElementById('detail-info');
            detailInfo.innerHTML = `
                <div class="detail-card">
                    <h4>Image</h4>
                    ${item.image_url ? `<img src="${item.image_url}" style="width: 200px; height: auto;">` : 'No Image'}
                </div>
                <div class="detail-card">
                    <h4>Manufacturer/Type</h4>
                    <p>${type === 'ship' ? (item.manufacturer || 'N/A') : (item.type || 'N/A')}</p>
                </div>
                <div class="detail-card">
                    <h4>Role</h4>
                    <p>${item.role || 'N/A'}</p>
                </div>
                <div class="detail-card">
                    <h4>Size</h4>
                    <p>${item.size || 'N/A'}</p>
                </div>
                <div class="detail-card">
                    <h4>Quantity</h4>
                    <p>${item.owned_qty || 0}</p>
                </div>
                <div class="detail-card">
                    <h4>Location</h4>
                    <p>${item.location || 'N/A'}</p>
                </div>
                <div class="detail-card">
                    <h4>Loadout/Notes</h4>
                    <p>${type === 'ship' ? (item.loadout || item.notes || 'N/A') : (item.notes || 'N/A')}</p>
                </div>
                <div class="detail-card">
                    <h4>Additional Notes</h4>
                    <p>${item.notes || 'N/A'}</p>
                </div>
                <div class="detail-card">
                    <h4>Confidence Score</h4>
                    <p class="${getConfidenceClass(item.confidence_score ?? 0)}">${item.confidence_score ?? 'N/A'}</p>
                </div>
                ${type === 'item' && item.buy_price ? `<div class="detail-card"><h4>Buy Price</h4><p>${item.buy_price} aUEC/SCU</p></div>` : ''}
                ${type === 'ship' ? `<div class="detail-card"><h4>Last Sync</h4><p>${item.last_sync ? new Date(item.last_sync).toLocaleString() : 'Never'}</p></div>` : ''}
            `;
        }

        function goBackToDashboard() {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById('dashboard').classList.add('active');
            document.querySelector('.nav-tab[data-tab="dashboard"]').classList.add('active');
            currentDetailItem = null;
            currentDetailType = null;
        }

        // Edit & Delete
        async function editItem(type, idOrName) {
            const modal = document.getElementById('edit-modal');
            modal.style.display = 'block';
            editingItemKind = type;
            if (type === 'ship') {
                const ship = await db.ships.get(idOrName);
                if (!ship) { alert('Ship not found'); return; }
                editingItemKey = ship.name;
                document.getElementById('edit-name').value = ship.name;
                document.getElementById('edit-manufacturer').value = ship.manufacturer || '';
                document.getElementById('edit-role').value = ship.role || '';
                document.getElementById('edit-size').value = ship.size || '';
                document.getElementById('edit-qty').value = ship.owned_qty || 1;
                document.getElementById('edit-location').value = ship.location || '';
                document.getElementById('edit-loadout').value = ship.loadout || '';
                document.getElementById('edit-notes').value = ship.notes || '';
                document.getElementById('edit-image').value = ship.image_url || '';
                document.getElementById('edit-buy-price').value = ''; // not applicable
                document.getElementById('edit-type').style.display = 'none';
            } else {
                const itemId = Number(idOrName);
                const item = await db.items.get(itemId);
                if (!item) { alert('Item not found'); return; }
                editingItemKey = item.id;
                document.getElementById('edit-name').value = item.name;
                document.getElementById('edit-manufacturer').value = item.type || '';
                document.getElementById('edit-role').value = '';
                document.getElementById('edit-size').value = item.size || '';
                document.getElementById('edit-qty').value = item.owned_qty || 1;
                document.getElementById('edit-location').value = item.location || '';
                document.getElementById('edit-loadout').value = '';
                document.getElementById('edit-notes').value = item.notes || '';
                document.getElementById('edit-image').value = '';
                document.getElementById('edit-buy-price').value = item.buy_price || 0;
                document.getElementById('edit-type').style.display = 'block';
                document.getElementById('edit-type').value = item.type || 'component';
            }
        }

        async function deleteItem(type, idOrName) {
            if (!confirm('Delete this entry?')) return;
            if (type === 'ship') {
                try {
                    await db.ships.delete(idOrName);
                    updateDashboard();
                    alert('Ship deleted');
                } catch (e) {
                    console.error(e);
                    alert('Delete failed');
                }
            } else {
                const itemId = Number(idOrName);
                try {
                    await db.items.delete(itemId);
                    updateDashboard();
                    updateTrading();
                    alert('Item deleted');
                } catch (e) {
                    console.error(e);
                    alert('Delete failed');
                }
            }
        }

        // Save modal edits
        document.getElementById('save-edit').addEventListener('click', async () => {
            if (!editingItemKind || editingItemKey == null) { alert('No edit target'); return; }
            if (editingItemKind === 'ship') {
                const updates = {
                    manufacturer: document.getElementById('edit-manufacturer').value || '',
                    role: document.getElementById('edit-role').value || '',
                    size: document.getElementById('edit-size').value || '',
                    owned_qty: parseInt(document.getElementById('edit-qty').value) || 1,
                    location: document.getElementById('edit-location').value || '',
                    loadout: document.getElementById('edit-loadout').value || '',
                    notes: document.getElementById('edit-notes').value || '',
                    image_url: document.getElementById('edit-image').value || ''
                };
                try {
                    await db.ships.update(editingItemKey, updates);
                    updateDashboard();
                    closeModal();
                } catch (e) {
                    console.error(e);
                    alert('Update failed');
                }
            } else {
                const itemId = Number(editingItemKey);
                const updates = {
                    type: document.getElementById('edit-type').value || 'component',
                    size: document.getElementById('edit-size').value || '',
                    owned_qty: parseInt(document.getElementById('edit-qty').value) || 1,
                    location: document.getElementById('edit-location').value || '',
                    notes: document.getElementById('edit-notes').value || '',
                    buy_price: parseFloat(document.getElementById('edit-buy-price').value) || 0
                };
                try {
                    await db.items.update(itemId, updates);
                    updateDashboard();
                    updateTrading();
                    closeModal();
                } catch (e) {
                    console.error(e);
                    alert('Update failed');
                }
            }
        });

        function closeModal() {
            document.getElementById('edit-modal').style.display = 'none';
            editingItemKey = null;
            editingItemKind = null;
        }

        // Search
        async function performSearch() {
            const q = (document.getElementById('search-query').value || '').toLowerCase();
            const typeFilter = document.getElementById('search-filter-type').value;
            const manuf = (document.getElementById('search-filter-manufacturer').value || '').toLowerCase();
            const role = document.getElementById('search-filter-role').value;
            const size = document.getElementById('search-filter-size').value;
            const location = (document.getElementById('search-filter-location').value || '').toLowerCase();

            const results = [];
            const ships = await db.ships.toArray();
            const items = await db.items.toArray();

            ships.forEach(s => {
                let match = true;
                if (q && !s.name.toLowerCase().includes(q)) match = false;
                if (manuf && !(s.manufacturer || '').toLowerCase().includes(manuf)) match = false;
                if (role && s.role !== role) match = false;
                if (size && s.size !== size) match = false;
                if (location && !(s.location || '').toLowerCase().includes(location)) match = false;
                if (typeFilter && typeFilter !== 'ship') match = false;
                if (match) results.push({ ...s, __kind: 'ship' });
            });

            items.forEach(i => {
                let match = true;
                if (q && !i.name.toLowerCase().includes(q)) match = false;
                if (typeFilter && typeFilter !== '' && typeFilter !== i.type && typeFilter !== 'item') match = false;
                if (manuf && !(i.type || '').toLowerCase().includes(manuf)) match = false;
                if (role && i.role && i.role !== role) match = false;
                if (size && i.size !== size) match = false;
                if (location && !(i.location || '').toLowerCase().includes(location)) match = false;
                if (match) results.push({ ...i, __kind: 'item' });
            });

            const tbody = document.querySelector('#search-table tbody');
            tbody.innerHTML = '';
            results.forEach(r => {
                const tr = tbody.insertRow();
                const imgCell = tr.insertCell();
                imgCell.textContent = r.image_url ? '' : '';
                const nameCell = tr.insertCell(); nameCell.textContent = r.name;
                tr.insertCell().textContent = r.__kind === 'ship' ? (r.manufacturer || '') : (r.type || '');
                tr.insertCell().textContent = r.role || '';
                tr.insertCell().textContent = r.size || '';
                tr.insertCell().textContent = r.owned_qty || 0;
                tr.insertCell().textContent = r.location || '';
                tr.insertCell().textContent = r.__kind === 'ship' ? (r.loadout || r.notes || '') : (r.notes || '');
                const conf = tr.insertCell(); conf.classList.add(getConfidenceClass(r.confidence_score ?? 0)); conf.textContent = r.confidence_score ?? '';
                const actions = tr.insertCell();
                const key = r.__kind === 'ship' ? r.name : r.id;
                actions.innerHTML = `<button onclick="editItem('${r.__kind === 'ship' ? 'ship' : 'item'}', '${key}')">Edit</button> <button onclick="deleteItem('${r.__kind === 'ship' ? 'ship' : 'item'}', '${key}')">Delete</button>`;
            });

            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.getElementById('search').classList.add('active');
        }

        // Trading (simple heuristic until real UEX integration)
        async function updateTrading() {
            const tbody = document.querySelector('#trading-table tbody');
            tbody.innerHTML = '';
            const items = await db.items.toArray();
            const commodities = items.filter(i => i.type === 'commodity' && i.owned_qty > 0);
            for (const c of commodities) {
                // naive mock: assume sell price = buy_price * 1.2 (if buy_price exists) or value * 1.05
                const buy = c.buy_price || c.value || 0;
                const sell = buy ? Math.round(buy * 1.2) : Math.round((c.value || 1000) * 1.05);
                const profit = Math.round((sell - buy) * (c.owned_qty || 1));
                const tr = tbody.insertRow();
                tr.insertCell().textContent = c.name;
                tr.insertCell().textContent = c.owned_qty || 0;
                tr.insertCell().textContent = 'New Babbage'; // placeholder best port
                tr.insertCell().textContent = sell.toLocaleString();
                tr.insertCell().textContent = profit.toLocaleString();
                tr.insertCell().textContent = profit > 2000 ? '⚠️' : '';
            }
        }

        // Wishlist
        async function updateWishlistTable() {
            const tbody = document.querySelector('#wishlist-table tbody');
            tbody.innerHTML = '';
            const list = await db.wishlist.toArray();
            list.forEach(w => {
                const tr = tbody.insertRow();
                tr.insertCell().textContent = w.name;
                tr.insertCell().textContent = w.type;
                tr.insertCell().textContent = w.target_price;
                const actions = tr.insertCell();
                actions.innerHTML = `<button onclick="removeWishlist('${w.name}')">Remove</button>`;
            });
        }

        async function addToWishlist() {
            const name = (document.getElementById('wishlist-name').value || '').trim();
            const type = document.getElementById('wishlist-type').value;
            const target = parseFloat(document.getElementById('wishlist-target-price').value) || 0;
            const notes = document.getElementById('wishlist-notes').value || '';
            if (!name) { alert('Wishlist name required'); return; }
            await db.wishlist.put({ name, type, target_price: target, notes });
            updateWishlistTable();
            alert('Added to wishlist');
        }

        async function removeWishlist(name) {
            if (!confirm('Remove from wishlist?')) return;
            await db.wishlist.delete(name);
            updateWishlistTable();
        }

        // Wishlist alerts (simple)
        async function checkWishlistAlerts() {
            const wishlist = await db.wishlist.toArray();
            for (const w of wishlist) {
                if (w.type === 'ship') {
                    const ship = await db.ships.get(w.name);
                    if (ship && ship.value && ship.value <= w.target_price) {
                        notify(`Wishlist: ${w.name} reached target price (${ship.value} aUEC)`);
                    }
                } else {
                    const item = (await db.items.where('name').equalsIgnoreCase(w.name).first());
                    if (item && item.value && item.value <= w.target_price) {
                        notify(`Wishlist: ${w.name} reached target price (${item.value} aUEC)`);
                    }
                }
            }
        }

        function notify(msg) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(msg);
            } else {
                console.log('Notify:', msg);
            }
        }

        // Settings
        function saveUexKey() {
            const key = document.getElementById('uex-key').value || '';
            localStorage.setItem('uexKey', key);
            uexKey = key;
            alert('UEX key saved locally (client-side).');
        }

        function saveUserHandle() {
            const h = document.getElementById('user-handle-input').value || '';
            if (h) {
                localStorage.setItem('userHandle', h);
                document.getElementById('user-handle').textContent = h;
                alert('Handle saved');
            } else {
                alert('Enter a handle first');
            }
        }

        // Export/Import (JSON)
        document.getElementById('export-btn').addEventListener('click', async () => {
            const ships = await db.ships.toArray();
            const items = await db.items.toArray();
            const wishlist = await db.wishlist.toArray();
            const exportObj = { ships, items, wishlist, exportedAt: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sc_fleet_export.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });

        document.getElementById('import-btn').addEventListener('click', () => {
            document.getElementById('import-file').click();
        });

        document.getElementById('import-file').addEventListener('change', async (e) => {
            const f = e.target.files[0];
            if (!f) return;
            try {
                const text = await f.text();
                const data = JSON.parse(text);
                if (data.ships && Array.isArray(data.ships)) {
                    for (const s of data.ships) {
                        if (s.name) await db.ships.put(s);
                    }
                }
                if (data.items && Array.isArray(data.items)) {
                    for (const it of data.items) {
                        // ensure not duplicate ID collisions: use add or put depending on presence of id
                        if (it.id) {
                            await db.items.put(it);
                        } else {
                            await db.items.add(it);
                        }
                    }
                }
                if (data.wishlist && Array.isArray(data.wishlist)) {
                    for (const w of data.wishlist) await db.wishlist.put(w);
                }
                updateDashboard();
                updateTrading();
                updateWishlistTable();
                alert('Import complete');
            } catch (err) {
                console.error(err);
                alert('Import failed: invalid JSON');
            } finally {
                e.target.value = '';
            }
        });

        // Modal close
        document.querySelector('#edit-modal .close').addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target === document.getElementById('edit-modal')) closeModal();
        });

        // Default ships add (if DB empty)
        async function addDefaultShips() {
            const shipCount = await db.ships.count();
            if (shipCount === 0) {
                const defaults = [
                    {
                        name: 'Idris-M',
                        manufacturer: 'Aegis Dynamics',
                        role: 'Military',
                        size: 'Capital',
                        value: 25000000,
                        owned_qty: 1,
                        location: 'Area18',
                        loadout: 'Default military loadout with Size 10 spinal gun, 7 manned turrets, hangars for small ships',
                        notes: 'UEE military frigate for patrols and interdiction. Length: 243m, Crew: 8-28, Cargo: 1326 SCU.',
                        image_url: ''
                    },
                    {
                        name: 'Gladius',
                        manufacturer: 'Aegis Dynamics',
                        role: 'Military',
                        size: 'Small',
                        value: 2381400,
                        owned_qty: 1,
                        location: 'Area18',
                        loadout: 'Light fighter with 3x S3 guns, missile racks',
                        notes: 'Fast dogfighter. Length: 21m, SCM: 226 m/s, Max: 1193 m/s, Crew: 1.',
                        image_url: ''
                    },
                    {
                        name: 'Hull-D',
                        manufacturer: 'MISC',
                        role: 'Industrial',
                        size: 'Large',
                        value: 4500000,
                        owned_qty: 1,
                        location: 'Area18',
                        loadout: 'Heavy freight config, 2 remote turrets',
                        notes: 'Cargo hauler. Length: 209m, Cargo: 20736 SCU, Crew: 1-5.',
                        image_url: ''
                    }
                ];
                for (const ship of defaults) {
                    const verified = await verifyData(ship.name, 'ship');
                    ship.value = verified.value || ship.value;
                    ship.confidence_score = verified.confidence || 0.5;
                    ship.last_sync = Date.now();
                    await db.ships.put(ship);
                }
            }
        }

        // Navigation tabs
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const t = tab.getAttribute('data-tab');
                document.querySelectorAll('.nav-tab').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(t).classList.add('active');
            });
        });

        // Sync button
        document.getElementById('sync-btn').onclick = () => syncData(true);

        // Init
        async function init() {
            createStars();
            document.getElementById('app-header').innerHTML = document.title + '<br><small>UEE Citizen Console - Citizen: <span id="user-handle">' + (localStorage.getItem('userHandle') || 'Anonymous') + '</span></small>';
            await addDefaultShips();
            await autoSyncIfNeeded();
            updateDashboard();
            updateWishlistTable();
            updateTrading();
            if (!navigator.onLine) document.getElementById('offline-banner').style.display = 'block';
            if ('Notification' in window) Notification.requestPermission().catch(()=>{});
        }

        function createStars() {
            const starfield = document.querySelector('.starfield');
            for (let i = 0; i < 200; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                star.style.width = star.style.height = Math.random() * 2 + 'px';
                star.style.top = Math.random() * 100 + '%';
                star.style.left = Math.random() * 100 + '%';
                starfield.appendChild(star);
            }
        }

        // Start
        init();
    </script>
</body>
</html>