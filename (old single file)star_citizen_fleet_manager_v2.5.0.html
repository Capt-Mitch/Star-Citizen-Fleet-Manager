<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Star Citizen Fleet Manager v2.5.0</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@300;400;700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/dexie@3/dist/dexie.js"></script>
  <style>
    /* === SHIP COCKPIT HOLOGRAPHIC THEME === */
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      padding: 0; 
      font-family: 'Orbitron', Arial, sans-serif; 
      background: radial-gradient(ellipse at center, #0a1428 0%, #000814 50%, #000000 100%);
      color: #00FFFF; 
      overflow-x: hidden; 
      position: relative; 
      min-height: 100vh;
    }
    
    .starfield { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      pointer-events: none; 
      z-index: 0; 
    }
    .star { 
      position: absolute; 
      background: white; 
      border-radius: 50%; 
      opacity: 0.8; 
      animation: twinkle 4s infinite ease-in-out; 
    }
    @keyframes twinkle { 
      0%, 100% { opacity: 0.8; transform: scale(1); } 
      50% { opacity: 0.3; transform: scale(1.2); } 
    }
    
    .cockpit-container {
      position: relative;
      z-index: 1;
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* === COCKPIT HEADER === */
    .cockpit-header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 30px;
      align-items: start;
      margin-bottom: 30px;
      background: linear-gradient(135deg, rgba(0,255,255,0.1) 0%, rgba(0,100,150,0.1) 100%);
      border: 2px solid #00FFFF;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 
        inset 0 0 20px rgba(0,255,255,0.2),
        0 0 30px rgba(0,255,255,0.3);
      position: relative;
      overflow: hidden;
    }
    
    .cockpit-header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent 49%, rgba(0,255,255,0.03) 50%, transparent 51%);
      animation: scan-line 3s linear infinite;
      pointer-events: none;
    }
    
    @keyframes scan-line {
      0% { transform: translateX(-100%) translateY(-100%); }
      100% { transform: translateX(100%) translateY(100%); }
    }
    
    /* === LEFT PANEL (Ship Status) === */
    .ship-status-panel {
      background: linear-gradient(145deg, rgba(0,50,80,0.3), rgba(0,30,50,0.5));
      border: 1px solid rgba(0,255,255,0.4);
      border-radius: 15px;
      padding: 15px;
      position: relative;
    }
    
    .ship-status-panel h3 {
      margin: 0 0 15px 0;
      color: #FFD700;
      font-size: 0.9em;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .status-item {
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(0,255,255,0.3);
      border-radius: 8px;
      padding: 8px;
      text-align: center;
      font-size: 0.8em;
    }
    
    .status-item .label {
      color: #888;
      font-size: 0.7em;
      margin-bottom: 2px;
    }
    
    .status-item .value {
      color: #00FF88;
      font-weight: bold;
    }
    
    .version-display {
      background: rgba(0,0,0,0.7);
      border: 2px solid #FFD700;
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      margin-top: 10px;
    }
    
    .version-display .version-label {
      color: #FFD700;
      font-size: 0.8em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .version-display .version-number {
      color: #00FFFF;
      font-size: 1.2em;
      font-weight: 900;
      text-shadow: 0 0 10px rgba(0,255,255,0.8);
    }
    
    /* === CENTER PANEL (Main Title & Controls) === */
    .main-control-panel {
      text-align: center;
      min-width: 400px;
    }
    
    .main-title {
      font-size: 2.5em;
      font-weight: 900;
      color: #00FFFF;
      text-shadow: 
        0 0 10px rgba(0,255,255,0.8),
        0 0 20px rgba(0,255,255,0.5),
        0 0 30px rgba(0,255,255,0.3);
      margin-bottom: 10px;
      animation: title-glow 3s ease-in-out infinite alternate;
    }
    
    @keyframes title-glow {
      0% { text-shadow: 0 0 10px rgba(0,255,255,0.8), 0 0 20px rgba(0,255,255,0.5); }
      100% { text-shadow: 0 0 15px rgba(0,255,255,1), 0 0 25px rgba(0,255,255,0.7); }
    }
    
    .subtitle {
      color: #888;
      font-size: 0.9em;
      margin-bottom: 20px;
    }
    
    .control-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      max-width: 350px;
      margin: 0 auto;
    }
    
    .cockpit-button {
      background: linear-gradient(145deg, rgba(0,100,150,0.3), rgba(0,50,100,0.5));
      border: 2px solid #00FFFF;
      color: #00FFFF;
      padding: 12px 8px;
      border-radius: 12px;
      cursor: pointer;
      font-family: 'Orbitron', Arial, sans-serif;
      font-size: 0.75em;
      font-weight: 700;
      text-transform: uppercase;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .cockpit-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: all 0.5s;
    }
    
    .cockpit-button:hover {
      background: linear-gradient(145deg, rgba(0,150,200,0.4), rgba(0,100,150,0.6));
      box-shadow: 0 0 20px rgba(0,255,255,0.6);
      transform: translateY(-2px);
    }
    
    .cockpit-button:hover::before {
      left: 100%;
    }
    
    .cockpit-button:active {
      transform: translateY(0);
    }
    
    /* === RIGHT PANEL (Diagnostics) === */
    .diagnostics-panel {
      background: linear-gradient(145deg, rgba(80,0,0,0.3), rgba(50,0,30,0.5));
      border: 1px solid rgba(255,100,100,0.4);
      border-radius: 15px;
      padding: 15px;
      position: relative;
    }
    
    .diagnostics-panel h3 {
      margin: 0 0 15px 0;
      color: #FF6B6B;
      font-size: 0.9em;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .api-status-compact {
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,100,100,0.3);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
      max-height: 120px;
      overflow-y: auto;
    }
    
    .api-status-compact .api-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 4px 0;
      font-size: 0.75em;
    }
    
    .api-status-compact .api-name {
      flex: 1;
      color: #ccc;
    }
    
    .api-status-compact .api-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-left: 8px;
    }
    
    .activity-log-compact {
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,100,100,0.3);
      border-radius: 8px;
      padding: 8px;
      max-height: 100px;
      overflow-y: auto;
      font-size: 0.7em;
    }
    
    .activity-log-compact .log-entry {
      margin: 2px 0;
      padding: 2px 0;
      border-bottom: 1px solid rgba(255,100,100,0.1);
      color: #aaa;
    }
    
    .activity-log-compact .log-entry:last-child {
      border-bottom: none;
    }
    
    .activity-log-compact .log-time {
      color: #666;
      margin-right: 5px;
    }
    
    /* === MAIN CONTENT PANELS === */
    .main-panel {
      background: linear-gradient(135deg, rgba(0,0,0,0.7), rgba(0,20,40,0.5));
      border: 2px solid #00FFFF;
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 
        inset 0 0 20px rgba(0,255,255,0.1),
        0 0 25px rgba(0,255,255,0.2);
      position: relative;
      backdrop-filter: blur(5px);
    }
    
    .sync-status { 
      color: #FFFF66; 
      font-size: 0.9em; 
      display: none; 
      margin: 15px 0; 
      text-align: center;
      padding: 12px;
      background: linear-gradient(90deg, rgba(255,255,102,0.1), rgba(255,200,0,0.2));
      border: 2px solid #FFFF66;
      border-radius: 10px;
      animation: pulse-glow 2s infinite;
    }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 10px rgba(255,255,102,0.3); }
      50% { box-shadow: 0 0 20px rgba(255,255,102,0.6); }
    }
    
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #FFFF66;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* === NAVIGATION TABS === */
    .nav-tabs { 
      display: flex; 
      justify-content: center; 
      margin: 25px 0; 
      flex-wrap: wrap; 
      gap: 15px; 
    }
    
    .nav-tab { 
      padding: 15px 25px; 
      border: 2px solid #00FFFF; 
      border-radius: 12px; 
      cursor: pointer; 
      transition: all 0.3s; 
      font-weight: 700;
      font-size: 0.9em;
      background: linear-gradient(145deg, rgba(0,50,100,0.2), rgba(0,30,60,0.4));
      position: relative;
      overflow: hidden;
    }
    
    .nav-tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0,255,255,0.3), transparent);
      transition: all 0.5s;
    }
    
    .nav-tab:hover { 
      box-shadow: 0 0 20px rgba(0,255,255,0.6); 
      transform: translateY(-3px);
      background: linear-gradient(145deg, rgba(0,100,150,0.3), rgba(0,60,100,0.5));
    }
    
    .nav-tab:hover::before {
      left: 100%;
    }
    
    .nav-tab.active { 
      background: linear-gradient(145deg, rgba(0,150,200,0.4), rgba(0,100,150,0.6));
      border-color: #FFD700;
      color: #FFD700;
      box-shadow: 0 0 25px rgba(255,215,0,0.5);
    }
    
    .content { display: none; }
    .content.active { display: block; }
    
    /* === METRICS GRID === */
    .metrics-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
      gap: 20px; 
      margin-bottom: 25px; 
    }
    
    .metric-card { 
      background: linear-gradient(145deg, rgba(0,50,100,0.3), rgba(0,30,60,0.5));
      border: 2px solid #00FFFF;
      padding: 25px;
      text-align: center;
      box-shadow: 
        inset 0 0 20px rgba(0,255,255,0.1),
        0 0 15px rgba(0,255,255,0.3);
      border-radius: 15px;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    
    .metric-card::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #00FFFF, #FFD700, #00FFFF);
      border-radius: 15px;
      z-index: -1;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .metric-card:hover::before {
      opacity: 1;
    }
    
    .metric-card:hover { 
      transform: translateY(-5px) scale(1.02);
    }
    
    .metric-card h3 { 
      margin: 0 0 15px 0; 
      color: #FFD700; 
      font-size: 1.1em;
      text-shadow: 0 0 10px rgba(255,215,0,0.5);
    }
    
    .metric-value {
      font-size: 2.5em; 
      font-weight: 900; 
      color: #00FFFF;
      text-shadow: 0 0 15px rgba(0,255,255,0.8);
      margin-bottom: 8px;
    }
    
    .metric-label {
      color: #888;
      font-size: 0.9em;
    }
    
    /* === ENHANCED TABLE STYLING === */
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 15px;
      background: rgba(0,0,0,0.4);
      border-radius: 10px;
      overflow: hidden;
    }
    
    th, td { 
      border: 1px solid rgba(0,255,255,0.3); 
      padding: 12px; 
      text-align: left; 
    }
    
    th { 
      background: linear-gradient(145deg, rgba(0,100,150,0.4), rgba(0,60,100,0.6));
      cursor: pointer; 
      font-weight: 700;
      position: sticky;
      top: 0;
      z-index: 10;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 0.5px;
    }
    
    th:hover { 
      background: linear-gradient(145deg, rgba(0,150,200,0.5), rgba(0,100,150,0.7));
    }
    
    tr:nth-child(even) { 
      background: rgba(0,50,100,0.1); 
    }
    
    tr:hover { 
      background: rgba(0,100,150,0.2);
      transform: scale(1.01);
      transition: all 0.2s;
    }
    
    /* === ENHANCED FORMS === */
    .form-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); 
      gap: 25px; 
    }
    
    .form-section { 
      background: linear-gradient(145deg, rgba(0,30,60,0.4), rgba(0,20,40,0.6));
      padding: 25px; 
      border: 2px solid rgba(0,255,255,0.4); 
      border-radius: 15px;
      position: relative;
    }
    
    .form-section h3 { 
      margin-top: 0; 
      color: #FFD700; 
      text-align: center;
      border-bottom: 2px solid rgba(0,255,255,0.3);
      padding-bottom: 15px;
      font-size: 1.2em;
      text-shadow: 0 0 10px rgba(255,215,0,0.5);
    }
    
    input, select, button { 
      background: linear-gradient(145deg, rgba(0,0,0,0.6), rgba(0,20,40,0.4));
      border: 2px solid rgba(0,255,255,0.4);
      color: #00FFFF;
      padding: 12px;
      margin: 8px 0;
      font-family: 'Orbitron', Arial, sans-serif;
      border-radius: 8px;
      transition: all 0.3s;
      width: 100%;
    }
    
    input:focus, select:focus { 
      outline: none; 
      box-shadow: 0 0 15px rgba(0,255,255,0.6); 
      border-color: #FFD700;
    }
    
    button:hover { 
      box-shadow: 0 0 20px rgba(0,255,255,0.6);
      background: linear-gradient(145deg, rgba(0,50,100,0.6), rgba(0,30,60,0.8));
    }
    
    /* === STATUS INDICATORS === */
    .status-ok { background: #00FF88; }
    .status-fail { background: #FF4500; }
    .status-pending { background: #FFFF66; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    
    .reliability-green { color: #00FF88; font-weight: bold; }
    .reliability-yellow { color: #FFFF66; font-weight: bold; }
    .reliability-red { color: #FF4500; font-weight: bold; }
    
    .ship-image { 
      width: 120px; 
      height: auto; 
      border-radius: 8px; 
      border: 2px solid rgba(0,255,255,0.3);
      transition: all 0.3s;
    }
    
    .ship-image:hover {
      border-color: #FFD700;
      box-shadow: 0 0 15px rgba(255,215,0,0.5);
    }
    
    /* === OFFLINE BANNER === */
    #offline-banner { 
      background: linear-gradient(90deg, rgba(255,69,0,0.9), rgba(200,50,0,0.8));
      color: white; 
      text-align: center; 
      padding: 15px; 
      display: none; 
      font-weight: bold;
      font-size: 1.1em;
      box-shadow: 0 5px 15px rgba(255,69,0,0.4);
    }
    
    /* === RESPONSIVE DESIGN === */
    @media (max-width: 1200px) {
      .cockpit-header {
        grid-template-columns: 1fr;
        text-align: center;
        gap: 20px;
      }
      
      .main-control-panel {
        min-width: auto;
      }
      
      .control-grid {
        grid-template-columns: repeat(2, 1fr);
        max-width: 300px;
      }
    }
    
    @media (max-width: 768px) {
      .cockpit-container {
        padding: 15px;
      }
      
      .main-title {
        font-size: 2em;
      }
      
      .control-grid {
        grid-template-columns: 1fr;
        max-width: 250px;
      }
      
      .nav-tabs {
        flex-direction: column;
        align-items: center;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* === MODAL STYLING === */
    .modal { 
      display: none; 
      position: fixed; 
      z-index: 2000; 
      left: 0; 
      top: 0; 
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.8); 
    }
    
    .modal-content { 
      background: linear-gradient(145deg, rgba(0,20,40,0.9), rgba(0,40,80,0.8));
      margin: 5% auto; 
      padding: 30px; 
      border: 2px solid #00FFFF; 
      width: 90%; 
      max-width: 600px; 
      box-shadow: 0 0 40px rgba(0,255,255,0.5); 
      border-radius: 15px;
    }
    
    .close { 
      color: #FF4500; 
      float: right; 
      font-size: 32px; 
      font-weight: bold; 
      cursor: pointer; 
    }
    
    .close:hover, .close:focus { 
      color: #00FFFF; 
      text-decoration: none; 
    }
    
    /* === ENHANCED CARDS === */
    .enhanced-card {
      background: linear-gradient(135deg, rgba(0,50,100,0.3), rgba(0,30,60,0.5));
      border: 2px solid #00FFFF;
      border-radius: 12px;
      padding: 20px;
      margin: 15px 0;
      transition: all 0.3s;
      position: relative;
    }
    
    .enhanced-card:hover {
      box-shadow: 0 0 25px rgba(0,255,255,0.4);
      transform: translateY(-3px);
    }
    
    /* === TOOLTIP STYLING === */
    .tooltip { 
      position: relative; 
      display: inline-block; 
    }
    
    .tooltip .tooltiptext { 
      visibility: hidden; 
      width: 250px; 
      background: linear-gradient(145deg, rgba(0,0,0,0.9), rgba(0,20,40,0.8));
      color: #00FFFF; 
      text-align: center; 
      border-radius: 8px; 
      padding: 10px; 
      position: absolute; 
      z-index: 1000; 
      bottom: 125%; 
      left: 50%; 
      margin-left: -125px; 
      opacity: 0; 
      transition: opacity 0.3s;
      border: 1px solid #00FFFF;
      font-size: 0.85em;
    }
    
    .tooltip:hover .tooltiptext { 
      visibility: visible; 
      opacity: 1; 
    }

    .name-link { 
      color: #00FFFF; 
      text-decoration: underline; 
      cursor: pointer; 
      font-weight: bold; 
      transition: all 0.2s;
    }
    
    .name-link:hover { 
      color: #FFD700; 
      text-shadow: 0 0 8px rgba(255,215,0,0.6);
    }
  </style>
</head>
<body>
  <div class="starfield"></div>
  <div id="offline-banner" class="alert">⚠️ OFFLINE MODE - Using Cached Data Only</div>
  
  <div class="cockpit-container">
    <!-- === COCKPIT HEADER (Ship Dashboard Style) === -->
    <div class="cockpit-header">
      <!-- Left Panel: Ship Status -->
      <div class="ship-status-panel">
        <h3>🚀 Fleet Status</h3>
        <div class="status-grid">
          <div class="status-item">
            <div class="label">Ships</div>
            <div class="value" id="header-ship-count">0</div>
          </div>
          <div class="status-item">
            <div class="label">Items</div>
            <div class="value" id="header-item-count">0</div>
          </div>
          <div class="status-item">
            <div class="label">Value</div>
            <div class="value" id="header-fleet-value">0 aUEC</div>
          </div>
          <div class="status-item">
            <div class="label">Quality</div>
            <div class="value" id="header-data-quality">0%</div>
          </div>
        </div>
        <div class="version-display">
          <div class="version-label">STAR CITIZEN LIVE</div>
          <div class="version-number" id="sc-version-display">Loading...</div>
        </div>
      </div>
      
      <!-- Center Panel: Main Title & Controls -->
      <div class="main-control-panel">
        <div class="main-title">FLEET MANAGER</div>
        <div class="subtitle">
          v2.5.0 • Citizen: <span id="user-handle">Anonymous</span>
        </div>
        
        <div class="control-grid">
          <button class="cockpit-button" id="sync-btn">🔄 Sync</button>
          <button class="cockpit-button" id="export-btn">📤 Export</button>
          <button class="cockpit-button" id="import-btn">📥 Import</button>
          <button class="cockpit-button" id="refresh-version-btn">🌐 Version</button>
          <button class="cockpit-button" id="health-check-btn">🩺 Health</button>
          <button class="cockpit-button" id="clear-cache-btn">🗑️ Cache</button>
        </div>
        <input type="file" id="import-file" style="display: none;">
      </div>
      
      <!-- Right Panel: Diagnostics -->
      <div class="diagnostics-panel">
        <h3>🔧 Diagnostics</h3>
        <div class="api-status-compact" id="api-status-compact">
          <div style="text-align: center; color: #666; font-size: 0.8em;">Checking APIs...</div>
        </div>
        <div class="activity-log-compact" id="activity-log-compact">
          <div style="text-align: center; color: #666; font-size: 0.8em;">Activity Log</div>
        </div>
      </div>
    </div>

    <!-- === SYNC STATUS === -->
    <div id="sync-status" class="sync-status">
      <div class="loading-spinner"></div>Syncing with the Verse...
    </div>

    <!-- === MAIN PANEL === -->
    <div class="main-panel">
      <!-- Navigation Tabs -->
      <div class="nav-tabs">
        <div class="nav-tab active" data-tab="dashboard">🏠 Dashboard HUD</div>
        <div class="nav-tab" data-tab="add">➕ Add Asset</div>
        <div class="nav-tab" data-tab="search">🔍 Search Fleet</div>
        <div class="nav-tab" data-tab="trading">💰 Trade Routes</div>
        <div class="nav-tab" data-tab="wishlist">⭐ Wishlist Scanner</div>
        <div class="nav-tab" data-tab="settings">⚙️ Settings</div>
      </div>

      <!-- Dashboard Content -->
      <div id="dashboard" class="content active">
        <div class="metrics-grid">
          <div class="metric-card">
            <h3>🚀 Fleet Ships</h3>
            <div class="metric-value" id="ship-count">0</div>
            <div class="metric-label">Total Vessels</div>
          </div>
          <div class="metric-card">
            <h3>📦 Inventory</h3>
            <div class="metric-value" id="item-count">0</div>
            <div class="metric-label">Items & Components</div>
          </div>
          <div class="metric-card">
            <h3>💎 Fleet Value</h3>
            <div class="metric-value" id="fleet-value">0 aUEC</div>
            <div class="metric-label">Estimated Worth</div>
          </div>
          <div class="metric-card">
            <h3>📊 Data Integrity</h3>
            <div class="metric-value" id="data-quality">0%</div>
            <div class="metric-label">Reliability Score</div>
          </div>
        </div>
        
        <div style="overflow-x: auto;">
          <table id="stats-table">
            <thead>
              <tr>
                <th>🖼️ Image</th>
                <th data-sort="name">📛 Name</th>
                <th data-sort="manufacturer">🏭 Manufacturer</th>
                <th data-sort="role">🎯 Role</th>
                <th data-sort="size">📏 Size</th>
                <th data-sort="hp">❤️ HP</th>
                <th data-sort="shield">🛡️ Shield</th>
                <th data-sort="cargo">📦 Cargo SCU</th>
                <th data-sort="owned_qty">🔢 Qty</th>
                <th data-sort="location">📍 Location</th>
                <th>⚙️ Loadout/Notes</th>
                <th data-sort="data_reliability_score">🎯 Reliability <span class="tooltip">?<span class="tooltiptext">Data reliability based on source verification and update frequency. Green = Excellent, Yellow = Good, Red = Poor</span></span></th>
                <th>🛠️ Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Add Asset Content -->
      <div id="add" class="content">
        <div class="form-grid">
          <div class="form-section">
            <h3>🚀 Add Ship to Fleet</h3>
            <input id="ship-name" placeholder="Ship Name (e.g., Gladius)" required>
            <input id="ship-manufacturer" placeholder="Manufacturer (e.g., Aegis Dynamics)">
            <select id="ship-role">
              <option value="">Select Role</option>
              <option>Military</option>
              <option>Civilian</option>
              <option>Industrial</option>
              <option>Miner</option>
              <option>Ground Vehicle</option>
              <option>Racing</option>
              <option>Exploration</option>
              <option>Other</option>
            </select>
            <input id="ship-size" placeholder="Size Class (Small/Medium/Large/Capital)">
            <input id="ship-qty" type="number" placeholder="Quantity" value="1" min="1">
            <input id="ship-location" placeholder="Location (e.g., Area18 Hangar 01)">
            <input id="ship-loadout" placeholder="Custom Loadout (optional)">
            <input id="ship-notes" placeholder="Additional Notes">
            <input id="ship-image" placeholder="Custom Image URL (optional)">
            <button id="add-ship-btn">➕ Add Ship to Fleet</button>
          </div>
          <div class="form-section">
            <h3>📦 Add Item to Inventory</h3>
            <input id="item-name" placeholder="Item Name (e.g., Size 3 Laser Cannon)" required>
            <select id="item-type">
              <option>weapon</option>
              <option>armor</option>
              <option>component</option>
              <option>commodity</option>
              <option>consumable</option>
              <option>tool</option>
              <option>other</option>
            </select>
            <input id="item-size" placeholder="Size (S1, S2, S3, etc.)">
            <input id="item-qty" type="number" placeholder="Quantity" value="1" min="1">
            <input id="item-location" placeholder="Storage Location">
            <input id="item-buy-price" type="number" placeholder="Purchase Price (aUEC)" min="0">
            <input id="item-notes" placeholder="Additional Notes">
            <button id="add-item-btn">➕ Add Item to Inventory</button>
          </div>
        </div>
      </div>

      <!-- Search Content -->
      <div id="search" class="content">
        <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 25px;">
          <input id="search-query" placeholder="🔍 Search by name..." style="width: auto; min-width: 200px;">
          <select id="search-filter-type" style="width: auto;">
            <option value="">All Types</option>
            <option>ship</option>
            <option>weapon</option>
            <option>armor</option>
            <option>component</option>
            <option>commodity</option>
            <option>consumable</option>
            <option>tool</option>
            <option>other</option>
          </select>
          <input id="search-filter-manufacturer" placeholder="Manufacturer..." style="width: auto; min-width: 150px;">
          <select id="search-filter-role" style="width: auto;">
            <option value="">All Roles</option>
            <option>Military</option>
            <option>Civilian</option>
            <option>Industrial</option>
            <option>Miner</option>
            <option>Ground Vehicle</option>
            <option>Racing</option>
            <option>Exploration</option>
            <option>Other</option>
          </select>
          <button id="perform-search-btn">🔍 Search Fleet</button>
          <button id="clear-search-btn">🗑️ Clear</button>
        </div>
        
        <div style="overflow-x: auto;">
          <table id="search-table">
            <thead>
              <tr>
                <th>🖼️ Image</th>
                <th>📛 Name</th>
                <th>🏭 Type/Manufacturer</th>
                <th>🎯 Role</th>
                <th>📏 Size</th>
                <th>🔢 Qty</th>
                <th>📍 Location</th>
                <th>⚙️ Notes</th>
                <th>🎯 Reliability</th>
                <th>🛠️ Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Trading Content -->
      <div id="trading" class="content">
        <div class="enhanced-card">
          <h3>💰 Commodity Trading Analysis</h3>
          <p>Monitor your commodity investments and discover profitable trading routes across the verse.</p>
        </div>
        <div style="overflow-x: auto;">
          <table id="trading-table">
            <thead>
              <tr>
                <th>📦 Commodity</th>
                <th>🔢 Quantity</th>
                <th>🏪 Best Sell Location</th>
                <th>💰 Price per SCU</th>
                <th>💎 Estimated Profit</th>
                <th>⚠️ Alert Level</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Wishlist Content -->
      <div id="wishlist" class="content">
        <div class="enhanced-card">
          <h3>⭐ Fleet Wishlist</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
            <input id="wishlist-name" placeholder="Ship/Item Name" required>
            <select id="wishlist-type">
              <option>ship</option>
              <option>item</option>
            </select>
            <input id="wishlist-target-price" type="number" placeholder="Target Price (aUEC)" min="0">
            <input id="wishlist-notes" placeholder="Notes">
            <button id="add-wishlist-btn">➕ Add to Wishlist</button>
          </div>
        </div>
        <div style="overflow-x: auto;">
          <table id="wishlist-table">
            <thead>
              <tr>
                <th>📛 Name</th>
                <th>📦 Type</th>
                <th>💰 Target Price</th>
                <th>📝 Notes</th>
                <th>🛠️ Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Settings Content -->
      <div id="settings" class="content">
        <div class="form-grid">
          <div class="form-section">
            <h3>🔑 API Configuration</h3>
            <input id="uex-key" placeholder="UEX API Key (optional)" type="password">
            <button id="save-uex-btn">💾 Save UEX Key</button>
            <div style="font-size: 0.85em; margin-top: 15px; color: #888; text-align: center;">
              UEX API key enables enhanced trading data.<br>Get yours at <strong>uexcorp.space</strong>
            </div>
          </div>
          <div class="form-section">
            <h3>👤 Citizen Profile</h3>
            <input id="user-handle-input" placeholder="Your Citizen Handle" maxlength="20">
            <button id="save-user-btn">💾 Save Handle</button>
            <div style="font-size: 0.85em; margin-top: 15px; color: #888; text-align: center;">
              Your Star Citizen handle for personalization
            </div>
          </div>
          <div class="form-section">
            <h3>🌐 System Health</h3>
            <div id="settings-api-health" style="margin: 15px 0;"></div>
            <button id="test-apis-btn">🔧 Test All APIs</button>
            <button id="refresh-all-btn">🔄 Refresh All Data</button>
          </div>
          <div class="form-section">
            <h3>🗃️ Data Management</h3>
            <button id="backup-data-btn">💾 Backup Fleet Data</button>
            <button id="clear-cache-settings-btn">🗑️ Clear Cache</button>
            <button id="clear-all-data-btn" style="border-color: #FF4500; color: #FF4500; background: linear-gradient(145deg, rgba(255,69,0,0.2), rgba(200,50,0,0.4));">⚠️ RESET ALL DATA</button>
            <div style="font-size: 0.8em; margin-top: 15px; color: #888; text-align: center;">
              Regular backups recommended. Reset will clear everything!
            </div>
          </div>
        </div>
      </div>

      <!-- Detail View Content -->
      <div id="detail" class="content">
        <div id="detail-header" class="main-title" style="margin-bottom: 30px;"></div>
        <div id="detail-info" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;"></div>
        <div style="text-align: center;">
          <button id="update-ship-btn" class="cockpit-button" style="display:none; width: auto; margin: 0 10px;">🔄 Update Data</button>
          <button id="reset-ship-btn" class="cockpit-button" style="display:none; width: auto; margin: 0 10px;">↩️ Reset Default</button>
          <button id="back-btn" class="cockpit-button" style="width: auto; margin: 0 10px;" onclick="goBackToDashboard()">← Back to Dashboard</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3 style="color: #FFD700; text-align: center; margin-bottom: 25px;">✏️ Edit Asset</h3>
      <div style="display: grid; gap: 15px;">
        <input id="edit-name" placeholder="Name" disabled style="background: rgba(100,100,100,0.3);">
        <input id="edit-manufacturer" placeholder="Manufacturer/Type">
        <select id="edit-role">
          <option value="">Select Role</option>
          <option>Military</option>
          <option>Civilian</option>
          <option>Industrial</option>
          <option>Miner</option>
          <option>Ground Vehicle</option>
          <option>Racing</option>
          <option>Exploration</option>
          <option>Other</option>
        </select>
        <input id="edit-size" placeholder="Size">
        <input id="edit-qty" type="number" placeholder="Quantity" min="1">
        <input id="edit-location" placeholder="Location">
        <input id="edit-loadout" placeholder="Loadout (for ships)">
        <input id="edit-notes" placeholder="Notes">
        <input id="edit-buy-price" type="number" placeholder="Buy Price (for items)" min="0">
        <input id="edit-image" placeholder="Image URL">
        <select id="edit-type" style="display:none;">
          <option>weapon</option>
          <option>armor</option>
          <option>component</option>
          <option>commodity</option>
          <option>consumable</option>
          <option>tool</option>
          <option>other</option>
        </select>
        <button id="save-edit">💾 Save Changes</button>
      </div>
    </div>
  </div>

  <script>
  // ============================================================================
  // STAR CITIZEN FLEET MANAGER v2.5.0 - Cockpit Edition
  // Enhanced ship dashboard design with fixed version fetching and image loading
  // ============================================================================

  // === GLOBAL VARIABLES ===
  let currentDetailItem = null;
  let currentDetailType = null;
  let editingItemKey = null;
  let editingItemKind = null;
  let currentSCVersion = 'Unknown';
  let lastVersionCheck = null;
  const IMAGE_PLACEHOLDER = 'https://via.placeholder.com/200x100/001122/00FFFF?text=No+Image';
  const MAX_ACTIVITY = 30;

  // === DATABASE SETUP ===
  const db = new Dexie('SCFleetManager');
  db.version(8).stores({
    ships: 'name, manufacturer, role, size, value, owned_qty, location, loadout, notes, last_sync, data_reliability_score, image_url, hp, shield, cargo, hardpoints_json, _loadout_source, enriched_version',
    items: '++id, name, type, size, owned_qty, value, location, acquired_date, buy_price, data_reliability_score, notes, image_url',
    wishlist: 'name, type, target_price, notes',
    audit_log: '++id, timestamp, source, item_name, changes, verified',
    settings: 'key, value',
    history: '++id, timestamp, total_value'
  });

  // === FIXED API SOURCES ===
  const API_SOURCES = {
    scwiki: { 
      name: 'SC Wiki', 
      base: 'https://api.star-citizen.wiki/v2', 
      ok: null,
      priority: 1
    },
    fleetyards: { 
      name: 'FleetYards', 
      base: 'https://api.fleetyards.net/v1', 
      ok: null,
      priority: 2
    },
    scapi: { 
      name: 'SC-API', 
      base: 'https://api.starcitizen-api.com', 
      ok: null,
      priority: 3
    },
    uex: { 
      name: 'UEX Corp', 
      base: 'https://uexcorp.space/api/2.0', 
      ok: null,
      priority: 4
    }
  };

  // === ENHANCED ACTIVITY LOGGING ===
  function logActivity(message, category = 'INFO') {
    try {
      const logBox = document.getElementById('activity-log-compact');
      if (!logBox) return;
      
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      const ts = new Date().toLocaleTimeString();
      const icon = category === 'ERROR' ? '❌' : category === 'SUCCESS' ? '✅' : category === 'WARNING' ? '⚠️' : 'ℹ️';
      
      entry.innerHTML = `<span class="log-time">${ts}</span>${icon} ${message}`;
      
      // Insert at top
      if (logBox.firstChild) {
        logBox.insertBefore(entry, logBox.firstChild);
      } else {
        logBox.appendChild(entry);
      }
      
      // Trim excess entries
      const entries = logBox.querySelectorAll('.log-entry');
      if (entries.length > MAX_ACTIVITY) {
        entries[entries.length - 1].remove();
      }
    } catch (e) {
      console.warn('logActivity error', e);
    }
  }

  // === API STATUS RENDERING ===
  function renderApiStatus() {
    const statusBox = document.getElementById('api-status-compact');
    if (!statusBox) return;
    
    statusBox.innerHTML = '';
    
    const sortedApis = Object.keys(API_SOURCES).sort((a, b) => 
      API_SOURCES[a].priority - API_SOURCES[b].priority
    );
    
    for (const key of sortedApis) {
      const api = API_SOURCES[key];
      const item = document.createElement('div');
      item.className = 'api-item';
      
      const name = document.createElement('span');
      name.className = 'api-name';
      name.textContent = api.name;
      
      const indicator = document.createElement('span');
      indicator.className = 'api-indicator';
      indicator.classList.add(
        api.ok === true ? 'status-ok' : 
        api.ok === false ? 'status-fail' : 'status-pending'
      );
      
      item.appendChild(name);
      item.appendChild(indicator);
      statusBox.appendChild(item);
    }
    
    // Mirror in settings
    updateSettingsApiHealth();
  }

  function updateSettingsApiHealth() {
    const settingsBox = document.getElementById('settings-api-health');
    if (!settingsBox) return;
    
    settingsBox.innerHTML = '';
    for (const key of Object.keys(API_SOURCES)) {
      const api = API_SOURCES[key];
      const div = document.createElement('div');
      const status = api.ok === true ? '🟢 Online' : api.ok === false ? '🔴 Offline' : '🟡 Testing...';
      div.innerHTML = `<strong>${api.name}:</strong> ${status}`;
      div.style.marginBottom = '8px';
      div.style.color = api.ok === true ? '#00FF88' : (api.ok === false ? '#FF4500' : '#FFFF66');
      settingsBox.appendChild(div);
    }
  }

  // === ENHANCED FETCH WITH TIMEOUT ===
  function fetchWithTimeout(resource, options = {}) {
    const { timeout = 10000 } = options;
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    return fetch(resource, { ...options, signal: controller.signal })
      .finally(() => clearTimeout(id));
  }

  // === ROBUST JSON FETCH ===
  async function fetchJsonRetry(url, opts = {}, attempts = 2) {
    let lastErr = null;
    for (let i = 0; i < attempts; i++) {
      try {
        const res = await fetchWithTimeout(url, { ...opts, timeout: 8000 });
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        const txt = await res.text();
        if (!txt.trim()) throw new Error('Empty response');
        return JSON.parse(txt);
      } catch (err) {
        lastErr = err;
        if (i < attempts - 1) {
          await new Promise(r => setTimeout(r, 1000 * (i + 1)));
        }
      }
    }
    throw lastErr;
  }

  // === FIXED SC VERSION FETCHING ===
  async function fetchSCVersion() {
    logActivity('Fetching Star Citizen version...');
    
    // Use hardcoded version from RSI as primary source
    const KNOWN_LIVE_VERSION = '4.3.1';
    
    // Try to verify version through community APIs
    const versionSources = [
      {
        name: 'Community API',
        url: 'https://api.starcitizen-api.com/version',
        parser: (data) => {
          // Filter out incorrect versions and use known good version
          const version = data.version || data.live;
          if (version && (version.startsWith('4.3') || version.startsWith('3.2'))) {
            return KNOWN_LIVE_VERSION; // Use our known correct version
          }
          return null;
        }
      }
    ];

    // Try community sources first
    for (const source of versionSources) {
      try {
        logActivity(`Checking ${source.name} for version verification...`);
        const data = await fetchJsonRetry(source.url, {}, 1);
        const version = source.parser(data);
        
        if (version) {
          currentSCVersion = version;
          lastVersionCheck = new Date();
          updateVersionDisplay();
          
          API_SOURCES.scapi.ok = true;
          renderApiStatus();
          
          logActivity(`SC version confirmed: ${currentSCVersion}`, 'SUCCESS');
          
          // Cache the version
          localStorage.setItem('scVersion', currentSCVersion);
          localStorage.setItem('scVersionTimestamp', Date.now().toString());
          
          return;
        }
      } catch (e) {
        API_SOURCES.scapi.ok = false;
        logActivity(`${source.name} check failed: ${e.message}`, 'WARNING');
      }
    }
    
    // Try cached version
    const cachedVersion = localStorage.getItem('scVersion');
    const cachedTimestamp = localStorage.getItem('scVersionTimestamp');
    
    if (cachedVersion && cachedTimestamp) {
      const cacheAge = Date.now() - parseInt(cachedTimestamp);
      if (cacheAge < 24 * 60 * 60 * 1000) { // Less than 24 hours
        currentSCVersion = cachedVersion;
        updateVersionDisplay(' (cached)');
        logActivity(`Using cached SC version: ${currentSCVersion}`, 'INFO');
        return;
      }
    }
    
    // Use hardcoded current version as final fallback
    currentSCVersion = KNOWN_LIVE_VERSION;
    lastVersionCheck = new Date();
    updateVersionDisplay(' (fallback)');
    logActivity(`Using known live version: ${currentSCVersion}`, 'INFO');
    
    // Cache the fallback
    localStorage.setItem('scVersion', currentSCVersion);
    localStorage.setItem('scVersionTimestamp', Date.now().toString());
  }

  function updateVersionDisplay(suffix = '') {
    const versionElement = document.getElementById('sc-version-display');
    if (versionElement) {
      versionElement.textContent = currentSCVersion + suffix;
    }
  }

  // === MANUAL VERSION REFRESH ===
  window.refreshSCVersion = async function() {
    logActivity('Manual version refresh requested...');
    localStorage.removeItem('scVersion');
    localStorage.removeItem('scVersionTimestamp');
    await fetchSCVersion();
  };

  // === API HEALTH CHECK ===
  async function checkApiHealth() {
    logActivity('Running API health diagnostics...');
    renderApiStatus(); // Show pending states
    
    const healthChecks = Object.keys(API_SOURCES).map(async (key) => {
      const api = API_SOURCES[key];
      try {
        let testUrl = `${api.base}`;
        if (key === 'scwiki') testUrl += '/version';
        if (key === 'fleetyards') testUrl += '/models?per_page=1';
        if (key === 'scapi') testUrl += '/ships/gladius';
        if (key === 'uex') testUrl += '/commodities_prices?name=Food';
        
        const res = await fetchWithTimeout(testUrl, { 
          method: 'GET', 
          mode: 'cors',
          headers: { 'Accept': 'application/json' }
        }, { timeout: 5000 });
        
        api.ok = res.ok;
        return { key, success: res.ok };
      } catch (e) {
        api.ok = false;
        return { key, success: false, error: e.message };
      }
    });

    const results = await Promise.allSettled(healthChecks);
    const successful = results.filter(r => r.status === 'fulfilled' && r.value.success).length;
    
    renderApiStatus();
    logActivity(`API health check complete: ${successful}/${results.length} APIs online`, 
      successful > results.length/2 ? 'SUCCESS' : 'WARNING');
  }

  // === ENHANCED IMAGE FETCHING ===
  async function getImageForShip(shipName) {
    if (!shipName) return IMAGE_PLACEHOLDER;
    
    const slug = slugify(shipName);
    const imageEndpoints = [
      `https://api.star-citizen.wiki/v2/ships/${slug}`,
      `https://api.fleetyards.net/v1/models/${slug}`,
      `https://api.starcitizen-api.com/ships/${slug}`
    ];

    // Try each endpoint
    for (const endpoint of imageEndpoints) {
      try {
        const data = await fetchJsonRetry(endpoint, {}, 1);
        if (data) {
          let imageUrl = null;
          
          // Extract image from different API response formats
          if (data.media && data.media.length > 0) {
            imageUrl = data.media[0].source_url || data.media[0].url;
          } else if (data.image) {
            imageUrl = data.image;
          } else if (data.images && data.images.length > 0) {
            imageUrl = data.images[0];
          }
          
          // Validate image URL
          if (imageUrl && imageUrl !== IMAGE_PLACEHOLDER && !imageUrl.includes('placeholder')) {
            // Test if image actually loads
            return new Promise((resolve) => {
              const img = new Image();
              img.onload = () => resolve(imageUrl);
              img.onerror = () => resolve(IMAGE_PLACEHOLDER);
              img.src = imageUrl;
            });
          }
        }
      } catch (e) {
        continue; // Try next endpoint
      }
    }
    
    return IMAGE_PLACEHOLDER;
  }

  function slugify(name) {
    if (!name) return '';
    return encodeURIComponent(String(name).trim().toLowerCase()
      .replace(/[^\w\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/--+/g, '-')
      .replace(/^-|-$/g, ''));
  }

  // === SHIP ENRICHMENT ===
  async function getFullShipInfo(shipName) {
    const slug = slugify(shipName);
    logActivity(`Enriching data for ${shipName}...`);
    
    // Try Star Citizen Wiki first
    try {
      const url = `https://api.star-citizen.wiki/v2/ships/${slug}`;
      const data = await fetchJsonRetry(url, {}, 2);
      if (data && data.name) {
        API_SOURCES.scwiki.ok = true;
        const img = await getImageForShip(shipName);
        logActivity(`Enriched ${shipName} from SC Wiki`, 'SUCCESS');
        return {
          source: 'SC Wiki',
          name: data.name || shipName,
          manufacturer: data.manufacturer || null,
          role: data.classification || data.role || null,
          size: data.size || null,
          image_url: img,
          hp: data.hull_hit_points || data.hull || null,
          shield: data.shield_points || null,
          cargo: data.cargo_capacity || null,
          hardpoints: data.hardpoints || null,
          value: data.price_in_game || null,
          raw: data
        };
      }
    } catch (e) {
      API_SOURCES.scwiki.ok = false;
      logActivity(`SC Wiki enrichment failed: ${e.message}`, 'WARNING');
    }

    // Try FleetYards
    try {
      const url = `https://api.fleetyards.net/v1/models/${slug}`;
      const data = await fetchJsonRetry(url, {}, 2);
      if (data && data.name) {
        API_SOURCES.fleetyards.ok = true;
        const img = await getImageForShip(shipName);
        logActivity(`Enriched ${shipName} from FleetYards`, 'SUCCESS');
        return {
          source: 'FleetYards',
          name: data.name || shipName,
          manufacturer: data.manufacturer?.name || null,
          role: data.classification || null,
          size: data.size || null,
          image_url: img,
          hp: null,
          shield: null,
          cargo: data.cargo || null,
          hardpoints: null,
          value: data.price || null,
          raw: data
        };
      }
    } catch (e) {
      API_SOURCES.fleetyards.ok = false;
      logActivity(`FleetYards enrichment failed: ${e.message}`, 'WARNING');
    }

    // Try StarCitizen-API
    try {
      const url = `https://api.starcitizen-api.com/ships/${slug}`;
      const data = await fetchJsonRetry(url, {}, 2);
      if (data && data.name) {
        API_SOURCES.scapi.ok = true;
        const img = await getImageForShip(shipName);
        logActivity(`Enriched ${shipName} from StarCitizen-API`, 'SUCCESS');
        return {
          source: 'StarCitizen-API',
          name: data.displayName || data.name || shipName,
          manufacturer: data.manufacturer || null,
          role: data.role || null,
          size: data.size || null,
          image_url: img,
          hp: data.hull || null,
          shield: data.shields || null,
          cargo: data.cargo || null,
          hardpoints: null,
          value: data.price || null,
          raw: data
        };
      }
    } catch (e) {
      API_SOURCES.scapi.ok = false;
      logActivity(`StarCitizen-API enrichment failed: ${e.message}`, 'WARNING');
    }

    // Fallback
    renderApiStatus();
    logActivity(`Could not enrich ${shipName}; using fallback data`, 'WARNING');
    return {
      source: 'Fallback',
      name: shipName,
      manufacturer: null,
      role: null,
      size: null,
      image_url: IMAGE_PLACEHOLDER,
      hp: null,
      shield: null,
      cargo: null,
      hardpoints: null,
      value: null,
      raw: null
    };
  }

  // === DEFAULT SHIP DATA ===
  function getDefaultShipData(shipName) {
    const defaults = {
      'Idris-M': { manufacturer: 'Aegis Dynamics', role: 'Military', size: 'Capital', value: 25000000 },
      'Gladius': { manufacturer: 'Aegis Dynamics', role: 'Military', size: 'Small', value: 1617600 },
      'Hull-D': { manufacturer: 'MISC', role: 'Industrial', size: 'Large', value: 7435000 },
      'Cutlass Black': { manufacturer: 'Drake Interplanetary', role: 'Civilian', size: 'Medium', value: 1617600 },
      'Aurora MR': { manufacturer: 'Roberts Space Industries', role: 'Civilian', size: 'Small', value: 316800 }
    };
    return defaults[shipName] || { 
      manufacturer: 'Unknown', 
      role: 'Other', 
      size: 'Medium', 
      value: 1000000 
    };
  }

  function getDefaultLoadout(shipName) {
    const defaults = {
      'Idris-M': 'Size 10 spinal railgun, 7x manned turrets, point defense systems',
      'Gladius': '3x S3 weapon hardpoints, 2x S2 missile racks',
      'Hull-D': 'Minimal defensive systems, cargo configuration',
      'Cutlass Black': '6x S3 weapon hardpoints, utility mount',
      'Aurora MR': '2x S1 weapon hardpoints, basic civilian setup'
    };
    return defaults[shipName] || 'Standard factory configuration';
  }

  // === RELIABILITY SCORING ===
  function getReliabilityClass(score) {
    const s = Number(score || 0);
    if (s >= 0.9) return 'reliability-green';
    if (s >= 0.7) return 'reliability-yellow';
    return 'reliability-red';
  }

  // === ADD SHIP ===
  document.getElementById('add-ship-btn').addEventListener('click', addShip);
  async function addShip() {
    const name = document.getElementById('ship-name').value?.trim();
    if (!name) { 
      alert('⚠️ Ship name is required'); 
      document.getElementById('ship-name').focus();
      return; 
    }
    
    const existing = await db.ships.get(name);
    if (existing) {
      if (!confirm(`Ship "${name}" already exists. Update quantity instead?`)) return;
      await db.ships.update(name, { owned_qty: existing.owned_qty + 1 });
      logActivity(`Updated quantity for existing ship: ${name}`, 'SUCCESS');
      await updateDashboard();
      return;
    }
    
    logActivity(`Adding new ship: ${name}...`);
    
    const userLoadout = document.getElementById('ship-loadout').value?.trim();
    const imageUrlInput = document.getElementById('ship-image').value?.trim();
    const defaultData = getDefaultShipData(name);
    
    let enriched = null;
    try {
      enriched = await getFullShipInfo(name);
    } catch (e) {
      logActivity(`Enrichment failed for ${name}: ${e.message}`, 'WARNING');
    }
    
    const imageUrl = imageUrlInput || 
                    (enriched?.image_url !== IMAGE_PLACEHOLDER ? enriched?.image_url : null) ||
                    await getImageForShip(name) || 
                    IMAGE_PLACEHOLDER;
    
    const loadoutValue = userLoadout || getDefaultLoadout(name);
    const loadoutSource = userLoadout ? 'user' : 'default';
    
    await db.ships.put({
      name,
      manufacturer: document.getElementById('ship-manufacturer').value || 
                   enriched?.manufacturer || 
                   defaultData.manufacturer,
      role: document.getElementById('ship-role').value || 
            enriched?.role || 
            defaultData.role,
      size: document.getElementById('ship-size').value || 
            enriched?.size || 
            defaultData.size,
      value: enriched?.value || defaultData.value || 0,
      owned_qty: parseInt(document.getElementById('ship-qty').value) || 1,
      location: document.getElementById('ship-location').value || 'Unknown',
      loadout: loadoutValue,
      _loadout_source: loadoutSource,
      notes: document.getElementById('ship-notes').value || '',
      last_sync: Date.now(),
      data_reliability_score: enriched ? 1.0 : 0.5,
      image_url: imageUrl,
      hp: enriched?.hp || null,
      shield: enriched?.shield || null,
      cargo: enriched?.cargo || null,
      hardpoints_json: enriched?.hardpoints ? JSON.stringify(enriched.hardpoints) : null,
      enriched_version: currentSCVersion
    });
    
    logActivity(`Successfully added ship: ${name}`, 'SUCCESS');
    
    // Clear form
    document.querySelectorAll('#add input, #add select').forEach(input => {
      if (input.type === 'number') input.value = input.id.includes('qty') ? '1' : '';
      else if (input.tagName === 'SELECT') input.selectedIndex = 0;
      else input.value = '';
    });
    
    await updateDashboard();
  }

  // === ADD ITEM ===
  document.getElementById('add-item-btn').addEventListener('click', addItem);
  async function addItem() {
    const name = document.getElementById('item-name').value?.trim();
    if (!name) { 
      alert('⚠️ Item name is required'); 
      document.getElementById('item-name').focus();
      return; 
    }
    
    logActivity(`Adding new item: ${name}...`);
    
    const id = await db.items.add({
      name,
      type: document.getElementById('item-type').value || 'component',
      size: document.getElementById('item-size').value || '',
      owned_qty: parseInt(document.getElementById('item-qty').value) || 1,
      value: 0,
      location: document.getElementById('item-location').value || 'Unknown',
      acquired_date: new Date(),
      buy_price: parseFloat(document.getElementById('item-buy-price').value) || 0,
      data_reliability_score: 0.7,
      notes: document.getElementById('item-notes').value || '',
      image_url: IMAGE_PLACEHOLDER
    });
    
    logActivity(`Successfully added item: ${name} (ID: ${id})`, 'SUCCESS');
    
    // Clear form
    document.querySelectorAll('#add input:not([type="number"]), #add select').forEach(input => {
      if (input.tagName === 'SELECT') input.selectedIndex = 0;
      else input.value = '';
    });
    document.querySelectorAll('#add input[type="number"]').forEach(input => {
      input.value = input.id.includes('qty') ? '1' : '';
    });
    
    await updateDashboard();
    await updateTrading();
  }

  // === TRADING ANALYSIS ===
  async function updateTrading() {
    const tbody = document.querySelector('#trading-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    
    const items = await db.items.toArray();
    const commodities = items.filter(i => i.type === 'commodity' && i.owned_qty > 0);
    
    if (commodities.length === 0) {
      const tr = tbody.insertRow();
      tr.innerHTML = '<td colspan="6" style="text-align: center; color: #888;">No commodities in inventory. Add some commodities to see trading opportunities.</td>';
      return;
    }
    
    for (const commodity of commodities) {
      const buyPrice = commodity.buy_price || 0;
      let sellPrice = Math.round(buyPrice * 1.15); // Default 15% markup
      let bestPort = 'Area18 Trade Center';
      
      // Try UEX for real data
      try {
        const uexKey = localStorage.getItem('uexKey');
        const headers = uexKey ? { 'Authorization': `Bearer ${uexKey}` } : {};
        
        const response = await fetchWithTimeout(
          `https://uexcorp.space/api/2.0/commodities_prices?name=${encodeURIComponent(commodity.name)}`, 
          { headers }, 
          { timeout: 5000 }
        );
        
        if (response.ok) {
          const data = await response.json();
          if (data.sell_price) {
            sellPrice = data.sell_price;
            bestPort = data.best_location || bestPort;
            API_SOURCES.uex.ok = true;
          }
        }
      } catch (err) {
        API_SOURCES.uex.ok = false;
        sellPrice = Math.round(buyPrice * (1.1 + Math.random() * 0.3));
      }
      
      const totalProfit = Math.round((sellPrice - buyPrice) * commodity.owned_qty);
      const profitPerUnit = Math.round(sellPrice - buyPrice);
      
      let alert = '';
      if (totalProfit > 10000) alert = '🚀 High Profit!';
      else if (totalProfit > 5000) alert = '💰 Good Profit';
      else if (totalProfit < 0) alert = '⚠️ Loss Risk';
      
      const tr = tbody.insertRow();
      tr.insertCell().textContent = commodity.name;
      tr.insertCell().textContent = commodity.owned_qty;
      tr.insertCell().textContent = bestPort;
      tr.insertCell().textContent = `${sellPrice.toLocaleString()} aUEC`;
      
      const profitCell = tr.insertCell();
      profitCell.textContent = `${totalProfit.toLocaleString()} aUEC (${profitPerUnit.toLocaleString()}/unit)`;
      profitCell.style.color = totalProfit > 0 ? '#00FF88' : '#FF4500';
      
      const alertCell = tr.insertCell();
      alertCell.textContent = alert;
      if (alert.includes('🚀')) alertCell.style.color = '#00FF88';
      else if (alert.includes('💰')) alertCell.style.color = '#FFFF66';
      else if (alert.includes('⚠️')) alertCell.style.color = '#FF4500';
    }
  }

  // === WISHLIST MANAGEMENT ===
  document.getElementById('add-wishlist-btn').addEventListener('click', addToWishlist);
  
  async function updateWishlistTable() {
    const tbody = document.querySelector('#wishlist-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    
    const wishlist = await db.wishlist.toArray();
    
    if (wishlist.length === 0) {
      const tr = tbody.insertRow();
      tr.innerHTML = '<td colspan="5" style="text-align: center; color: #888;">No items in wishlist. Add ships or items you want to track.</td>';
      return;
    }
    
    for (const item of wishlist) {
      const tr = tbody.insertRow();
      tr.insertCell().textContent = item.name;
      tr.insertCell().textContent = item.type;
      
      const priceCell = tr.insertCell();
      priceCell.textContent = item.target_price ? `${item.target_price.toLocaleString()} aUEC` : 'Any Price';
      
      tr.insertCell().textContent = item.notes || '';
      
      const actionsCell = tr.insertCell();
      const removeBtn = document.createElement('button');
      removeBtn.textContent = '🗑️ Remove';
      removeBtn.style.background = 'rgba(255,69,0,0.3)';
      removeBtn.style.borderColor = '#FF4500';
      removeBtn.style.color = '#FF4500';
      removeBtn.addEventListener('click', () => removeWishlist(item.name));
      actionsCell.appendChild(removeBtn);
    }
  }
  
  async function addToWishlist() {
    const name = document.getElementById('wishlist-name').value?.trim();
    const type = document.getElementById('wishlist-type').value;
    const target = parseFloat(document.getElementById('wishlist-target-price').value) || 0;
    const notes = document.getElementById('wishlist-notes').value?.trim() || '';
    
    if (!name) { 
      alert('⚠️ Item/Ship name is required'); 
      document.getElementById('wishlist-name').focus();
      return; 
    }
    
    const existing = await db.wishlist.get(name);
    if (existing) {
      alert(`"${name}" is already in your wishlist.`);
      return;
    }
    
    await db.wishlist.put({ name, type, target_price: target, notes });
    logActivity(`Added to wishlist: ${name} (${type})`, 'SUCCESS');
    
    // Clear form
    document.getElementById('wishlist-name').value = '';
    document.getElementById('wishlist-target-price').value = '';
    document.getElementById('wishlist-notes').value = '';
    
    await updateWishlistTable();
  }
  
  async function removeWishlist(name) {
    if (!confirm(`Remove "${name}" from wishlist?`)) return;
    await db.wishlist.delete(name);
    logActivity(`Removed from wishlist: ${name}`, 'SUCCESS');
    await updateWishlistTable();
  }

  // === DASHBOARD UPDATE ===
  async function updateDashboard() {
    const ships = await db.ships.toArray();
    const items = await db.items.toArray();
    
    // Update counts
    document.getElementById('ship-count').textContent = ships.length;
    document.getElementById('item-count').textContent = items.length;
    document.getElementById('header-ship-count').textContent = ships.length;
    document.getElementById('header-item-count').textContent = items.length;
    
    // Calculate fleet value
    const totalValue = ships.reduce((sum, ship) => sum + ((ship.value || 0) * (ship.owned_qty || 1)), 0);
    const valueText = `${Math.round(totalValue / 1000)}K aUEC`;
    document.getElementById('fleet-value').textContent = valueText;
    document.getElementById('header-fleet-value').textContent = valueText;
    
    // Calculate average data quality
    const allAssets = [...ships, ...items];
    const avgReliability = allAssets.length > 0 ? 
      allAssets.reduce((sum, asset) => sum + (asset.data_reliability_score || 0), 0) / allAssets.length : 0;
    const qualityText = `${Math.round(avgReliability * 100)}%`;
    document.getElementById('data-quality').textContent = qualityText;
    document.getElementById('header-data-quality').textContent = qualityText;
    
    const tableBody = document.querySelector('#stats-table tbody');
    tableBody.innerHTML = '';

    // Add ships
    for (const ship of ships.sort((a, b) => (a.name || '').localeCompare(b.name || ''))) {
      await addRowToTable(tableBody, ship, 'ship');
    }
    
    // Add items
    for (const item of items.sort((a, b) => (a.name || '').localeCompare(b.name || ''))) {
      await addRowToTable(tableBody, item, 'item');
    }
  }

  // === TABLE ROW CREATION ===
  async function addRowToTable(tableBody, item, type) {
    try {
      const row = tableBody.insertRow();
      
      // Image cell
      const imageCell = row.insertCell();
      let displayImage = item.image_url || IMAGE_PLACEHOLDER;
      
      // Auto-enrich ships if needed
      if (type === 'ship' && (!item.image_url || item.enriched_version !== currentSCVersion)) {
        try {
          const enriched = await getFullShipInfo(item.name);
          if (enriched.source !== 'Fallback') {
            const updateObj = {
              manufacturer: enriched.manufacturer || item.manufacturer,
              role: enriched.role || item.role,
              size: enriched.size || item.size,
              image_url: enriched.image_url || item.image_url || IMAGE_PLACEHOLDER,
              hp: enriched.hp ?? item.hp,
              shield: enriched.shield ?? item.shield,
              cargo: enriched.cargo ?? item.cargo,
              hardpoints_json: enriched.hardpoints ? JSON.stringify(enriched.hardpoints) : item.hardpoints_json,
              value: enriched.value ?? item.value,
              last_sync: Date.now(),
              data_reliability_score: 1.0,
              enriched_version: currentSCVersion
            };
            
            if (item._loadout_source !== 'user') {
              updateObj.loadout = item.loadout || getDefaultLoadout(item.name);
              updateObj._loadout_source = item._loadout_source || 'default';
            }
            
            await db.ships.update(item.name, updateObj);
            item = { ...item, ...updateObj };
            displayImage = item.image_url;
          }
        } catch (e) {
          console.warn('Row enrichment failed:', e);
        }
      }

      if (displayImage && displayImage !== IMAGE_PLACEHOLDER) {
        const img = document.createElement('img');
        img.src = displayImage;
        img.loading = 'lazy';
        img.classList.add('ship-image');
        img.alt = item.name || 'Asset image';
        img.addEventListener('error', () => {
          img.src = IMAGE_PLACEHOLDER;
        });
        imageCell.appendChild(img);
      } else {
        imageCell.innerHTML = '<div style="width:120px; height:60px; background:#333; display:flex; align-items:center; justify-content:center; font-size:0.8em; color:#666; border-radius:4px;">No Image</div>';
      }

      // Name cell with link
      const nameCell = row.insertCell();
      const nameLink = document.createElement('span');
      nameLink.classList.add('name-link');
      nameLink.textContent = item.name || 'Unnamed';
      nameLink.addEventListener('click', () => showDetail(item, type));
      nameCell.appendChild(nameLink);

      // Other cells
      row.insertCell().textContent = type === 'ship' ? (item.manufacturer || 'Unknown') : (item.type || 'Unknown');
      row.insertCell().textContent = item.role || '';
      row.insertCell().textContent = item.size || '';
      row.insertCell().textContent = type === 'ship' ? (item.hp != null ? item.hp.toLocaleString() : 'N/A') : '';
      row.insertCell().textContent = type === 'ship' ? (item.shield != null ? item.shield.toLocaleString() : 'N/A') : '';
      row.insertCell().textContent = type === 'ship' ? (item.cargo != null ? item.cargo.toLocaleString() : 'N/A') : '';
      row.insertCell().textContent = item.owned_qty || 0;
      row.insertCell().textContent = item.location || 'Unknown';
      
      const loadoutCell = row.insertCell();
      const loadoutText = type === 'ship' ? (item.loadout || item.notes || '') : (item.notes || '');
      loadoutCell.textContent = loadoutText.length > 40 ? loadoutText.substring(0, 37) + '...' : loadoutText;
      loadoutCell.title = loadoutText;
      
      const relCell = row.insertCell();
      const relScore = typeof item.data_reliability_score === 'number' ? item.data_reliability_score : 0;
      const relClass = getReliabilityClass(relScore);
      relCell.classList.add(relClass);
      relCell.textContent = `${Math.round(relScore * 100)}%`;

      const actionsCell = row.insertCell();
      const editBtn = document.createElement('button');
      editBtn.textContent = '✏️';
      editBtn.title = 'Edit';
      editBtn.style.marginRight = '5px';
      editBtn.style.width = 'auto';
      editBtn.style.padding = '5px 8px';
      editBtn.addEventListener('click', () => {
        const key = type === 'ship' ? item.name : item.id;
        editItem(type, String(key));
      });
      
      const delBtn = document.createElement('button');
      delBtn.textContent = '🗑️';
      delBtn.title = 'Delete';
      delBtn.style.background = 'rgba(255,69,0,0.3)';
      delBtn.style.borderColor = '#FF4500';
      delBtn.style.color = '#FF4500';
      delBtn.style.width = 'auto';
      delBtn.style.padding = '5px 8px';
      delBtn.addEventListener('click', () => {
        const key = type === 'ship' ? item.name : item.id;
        deleteItem(type, String(key));
      });
      
      actionsCell.appendChild(editBtn);
      actionsCell.appendChild(delBtn);
      
    } catch (e) {
      console.error('Failed to add row to table:', e);
      logActivity(`Failed to display ${type}: ${item.name || 'Unknown'}`, 'ERROR');
    }
  }

  // === DETAIL VIEW ===
  async function showDetail(item, type) {
    currentDetailItem = item;
    currentDetailType = type;
    
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    document.getElementById('detail').classList.add('active');
    
    document.getElementById('detail-header').textContent = 
      `${type === 'ship' ? '🚀' : '📦'} ${type.charAt(0).toUpperCase() + type.slice(1)}: ${item.name}`;
    
    const updateBtn = document.getElementById('update-ship-btn');
    const resetBtn = document.getElementById('reset-ship-btn');
    updateBtn.style.display = type === 'ship' ? 'inline-block' : 'none';
    resetBtn.style.display = type === 'ship' ? 'inline-block' : 'none';
    
    logActivity(`Opening detail view for ${item.name} (${type})`);

    const detailInfo = document.getElementById('detail-info');
    detailInfo.innerHTML = '';
    
    const displayImage = item.image_url || IMAGE_PLACEHOLDER;
    
    // Create detail cards
    const cards = [];
    
    // Image card
    cards.push(`
      <div class="enhanced-card">
        <h4 style="color: #FFD700; margin-bottom: 15px;">🖼️ Image</h4>
        <img src="${displayImage}" style="width:100%; max-width:300px; height:auto; border-radius:8px;" 
             onerror="this.src='${IMAGE_PLACEHOLDER}'" alt="${item.name}">
      </div>
    `);

    if (type === 'ship') {
      cards.push(`
        <div class="enhanced-card">
          <h4 style="color: #FFD700; margin-bottom: 15px;">🏭 Manufacturer</h4>
          <p style="font-size: 1.2em; color: #00FFFF;">${item.manufacturer || 'Unknown'}</p>
        </div>
      `);
      
      cards.push(`
        <div class="enhanced-card">
          <h4 style="color: #FFD700; margin-bottom: 15px;">🎯 Role & Specifications</h4>
          <p><strong>Role:</strong> ${item.role || 'Unknown'}</p>
          <p><strong>Size Class:</strong> ${item.size || 'Unknown'}</p>
          <p><strong>Hull Points:</strong> ${item.hp != null ? item.hp.toLocaleString() : 'Unknown'}</p>
          <p><strong>Shield Points:</strong> ${item.shield != null ? item.shield.toLocaleString() : 'Unknown'}</p>
          <p><strong>Cargo Capacity:</strong> ${item.cargo != null ? `${item.cargo} SCU` : 'Unknown'}</p>
        </div>
      `);
      
      cards.push(`
        <div class="enhanced-card">
          <h4 style="color: #FFD700; margin-bottom: 15px;">💎 Fleet Information</h4>
          <p><strong>Estimated Value:</strong> ${item.value ? `${item.value.toLocaleString()} aUEC` : 'Unknown'}</p>
          <p><strong>Quantity Owned:</strong> ${item.owned_qty || 1}</p>
          <p><strong>Current Location:</strong> ${item.location || 'Unknown'}</p>
          <p><strong>Data Reliability:</strong> <span class="${getReliabilityClass(item.data_reliability_score ?? 0)}">${Math.round((item.data_reliability_score ?? 0) * 100)}%</span></p>
        </div>
      `);
      
      cards.push(`
        <div class="enhanced-card" style="grid-column: span 2;">
          <h4 style="color: #FFD700; margin-bottom: 15px;">⚙️ Loadout Configuration</h4>
          <p style="font-size: 1.1em; line-height: 1.6;">${item.loadout || 'No loadout configured'}</p>
          <small style="color: #888;">${item._loadout_source === 'user' ? 'Custom configuration' : 'Default factory loadout'}</small>
        </div>
      `);
      
      if (item.notes) {
        cards.push(`
          <div class="enhanced-card">
            <h4 style="color: #FFD700; margin-bottom: 15px;">📝 Additional Notes</h4>
            <p style="line-height: 1.6;">${item.notes}</p>
          </div>
        `);
      }
      
    } else {
      cards.push(`
        <div class="enhanced-card">
          <h4 style="color: #FFD700; margin-bottom: 15px;">📦 Item Details</h4>
          <p><strong>Type:</strong> ${item.type || 'Unknown'}</p>
          <p><strong>Size:</strong> ${item.size || 'Unknown'}</p>
          <p><strong>Quantity:</strong> ${item.owned_qty || 0}</p>
          <p><strong>Location:</strong> ${item.location || 'Unknown'}</p>
        </div>
      `);
      
      cards.push(`
        <div class="enhanced-card">
          <h4 style="color: #FFD700; margin-bottom: 15px;">💰 Financial Information</h4>
          <p><strong>Purchase Price:</strong> ${item.buy_price != null ? `${item.buy_price.toLocaleString()} aUEC` : 'Unknown'}</p>
          <p><strong>Acquired Date:</strong> ${item.acquired_date ? new Date(item.acquired_date).toLocaleDateString() : 'Unknown'}</p>
          <p><strong>Data Reliability:</strong> <span class="${getReliabilityClass(item.data_reliability_score ?? 0)}">${Math.round((item.data_reliability_score ?? 0) * 100)}%</span></p>
        </div>
      `);
      
      if (item.notes) {
        cards.push(`
          <div class="enhanced-card" style="grid-column: span 2;">
            <h4 style="color: #FFD700; margin-bottom: 15px;">📝 Notes</h4>
            <p style="line-height: 1.6;">${item.notes}</p>
          </div>
        `);
      }
    }

    detailInfo.innerHTML = cards.join('');
  }

  // === NAVIGATION ===
  function goBackToDashboard() {
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    document.getElementById('dashboard').classList.add('active');
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelector('.nav-tab[data-tab="dashboard"]').classList.add('active');
    currentDetailItem = null;
    currentDetailType = null;
    logActivity('Returned to dashboard');
  }

  // === EDIT AND DELETE ===
  async function editItem(type, idOrName) {
    const modal = document.getElementById('edit-modal');
    modal.style.display = 'block';
    editingItemKind = type;
    
    if (type === 'ship') {
      const ship = await db.ships.get(idOrName);
      if (!ship) { alert('❌ Ship not found'); return; }
      editingItemKey = ship.name;
      document.getElementById('edit-name').value = ship.name;
      document.getElementById('edit-manufacturer').value = ship.manufacturer || '';
      document.getElementById('edit-role').value = ship.role || '';
      document.getElementById('edit-size').value = ship.size || '';
      document.getElementById('edit-qty').value = ship.owned_qty || 1;
      document.getElementById('edit-location').value = ship.location || '';
      document.getElementById('edit-loadout').value = ship.loadout || '';
      document.getElementById('edit-notes').value = ship.notes || '';
      document.getElementById('edit-image').value = ship.image_url || '';
      document.getElementById('edit-buy-price').value = '';
      document.getElementById('edit-type').style.display = 'none';
    } else {
      const itemId = Number(idOrName);
      const item = await db.items.get(itemId);
      if (!item) { alert('❌ Item not found'); return; }
      editingItemKey = item.id;
      document.getElementById('edit-name').value = item.name;
      document.getElementById('edit-manufacturer').value = item.type || '';
      document.getElementById('edit-role').value = '';
      document.getElementById('edit-size').value = item.size || '';
      document.getElementById('edit-qty').value = item.owned_qty || 1;
      document.getElementById('edit-location').value = item.location || '';
      document.getElementById('edit-loadout').value = '';
      document.getElementById('edit-notes').value = item.notes || '';
      document.getElementById('edit-image').value = item.image_url || '';
      document.getElementById('edit-buy-price').value = item.buy_price || 0;
      document.getElementById('edit-type').style.display = 'block';
      document.getElementById('edit-type').value = item.type || 'component';
    }
  }

  async function deleteItem(type, idOrName) {
    const itemName = type === 'ship' ? idOrName : `Item ID ${idOrName}`;
    if (!confirm(`⚠️ Delete "${itemName}"? This cannot be undone.`)) return;
    
    try {
      if (type === 'ship') {
        await db.ships.delete(idOrName);
        logActivity(`Deleted ship: ${idOrName}`, 'SUCCESS');
      } else {
        const itemId = Number(idOrName);
        const item = await db.items.get(itemId);
        await db.items.delete(itemId);
        logActivity(`Deleted item: ${item?.name || itemId}`, 'SUCCESS');
      }
      
      await updateDashboard();
      if (type !== 'ship') await updateTrading();
      alert('✅ Item deleted successfully');
    } catch (e) {
      console.error('Delete failed:', e);
      logActivity(`Delete failed for ${itemName}: ${e.message}`, 'ERROR');
      alert('❌ Delete failed. Please try again.');
    }
  }

  // === SAVE EDIT ===
  document.getElementById('save-edit').addEventListener('click', async () => {
    if (!editingItemKind || editingItemKey == null) { 
      alert('❌ No item selected for editing'); 
      return; 
    }
    
    try {
      if (editingItemKind === 'ship') {
        const updates = {
          manufacturer: document.getElementById('edit-manufacturer').value || '',
          role: document.getElementById('edit-role').value || '',
          size: document.getElementById('edit-size').value || '',
          owned_qty: Math.max(1, parseInt(document.getElementById('edit-qty').value) || 1),
          location: document.getElementById('edit-location').value || '',
          notes: document.getElementById('edit-notes').value || '',
          image_url: document.getElementById('edit-image').value || IMAGE_PLACEHOLDER,
          last_sync: Date.now()
        };
        
        const newLoadout = document.getElementById('edit-loadout').value?.trim();
        if (newLoadout) {
          updates.loadout = newLoadout;
          updates._loadout_source = 'user';
        }
        
        await db.ships.update(editingItemKey, updates);
        logActivity(`Updated ship: ${editingItemKey}`, 'SUCCESS');
      } else {
        const itemId = Number(editingItemKey);
        const updates = {
          type: document.getElementById('edit-type').value || 'component',
          size: document.getElementById('edit-size').value || '',
          owned_qty: Math.max(1, parseInt(document.getElementById('edit-qty').value) || 1),
          location: document.getElementById('edit-location').value || '',
          notes: document.getElementById('edit-notes').value || '',
          buy_price: Math.max(0, parseFloat(document.getElementById('edit-buy-price').value) || 0),
          image_url: document.getElementById('edit-image').value || ''
        };
        
        await db.items.update(itemId, updates);
        logActivity(`Updated item ID: ${itemId}`, 'SUCCESS');
      }
      
      await updateDashboard();
      if (editingItemKind !== 'ship') await updateTrading();
      closeModal();
      alert('✅ Changes saved successfully!');
      
    } catch (e) {
      console.error('Save failed:', e);
      logActivity(`Save failed: ${e.message}`, 'ERROR');
      alert('❌ Failed to save changes. Please try again.');
    }
  });

  function closeModal() {
    document.getElementById('edit-modal').style.display = 'none';
    editingItemKey = null;
    editingItemKind = null;
  }

  // === SEARCH FUNCTIONALITY ===
  document.getElementById('perform-search-btn').addEventListener('click', performSearch);
  document.getElementById('clear-search-btn').addEventListener('click', clearSearch);

  async function performSearch() {
    const query = document.getElementById('search-query').value?.toLowerCase().trim() || '';
    const typeFilter = document.getElementById('search-filter-type').value;
    const manufFilter = document.getElementById('search-filter-manufacturer').value?.toLowerCase().trim() || '';
    const roleFilter = document.getElementById('search-filter-role').value;

    logActivity(`Searching fleet: "${query}"`);

    const results = [];
    const ships = await db.ships.toArray();
    const items = await db.items.toArray();

    // Search ships
    ships.forEach(ship => {
      let match = true;
      if (query && !(ship.name || '').toLowerCase().includes(query)) match = false;
      if (manufFilter && !(ship.manufacturer || '').toLowerCase().includes(manufFilter)) match = false;
      if (roleFilter && ship.role !== roleFilter) match = false;
      if (typeFilter && typeFilter !== 'ship') match = false;
      if (match) results.push({ ...ship, __kind: 'ship' });
    });

    // Search items
    items.forEach(item => {
      let match = true;
      if (query && !(item.name || '').toLowerCase().includes(query)) match = false;
      if (typeFilter && typeFilter !== '' && typeFilter !== item.type) match = false;
      if (manufFilter && !(item.type || '').toLowerCase().includes(manufFilter)) match = false;
      if (roleFilter && item.role && item.role !== roleFilter) match = false;
      if (match) results.push({ ...item, __kind: 'item' });
    });

    // Populate results table
    const tbody = document.querySelector('#search-table tbody');
    tbody.innerHTML = '';
    
    if (results.length === 0) {
      const tr = tbody.insertRow();
      tr.innerHTML = '<td colspan="10" style="text-align: center; color: #888;">No results found. Try different search criteria.</td>';
    } else {
      for (const result of results) {
        await addSearchResultRow(tbody, result);
      }
    }

    // Switch to search tab
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
    document.getElementById('search').classList.add('active');
    
    logActivity(`Search complete: ${results.length} results found`, 'SUCCESS');
  }

  async function addSearchResultRow(tbody, result) {
    const tr = tbody.insertRow();
    
    // Image
    const imgCell = tr.insertCell();
    const displayImage = result.image_url || IMAGE_PLACEHOLDER;
    if (displayImage && displayImage !== IMAGE_PLACEHOLDER) {
      const img = document.createElement('img');
      img.src = displayImage;
      img.classList.add('ship-image');
      img.loading = 'lazy';
      img.addEventListener('error', () => img.src = IMAGE_PLACEHOLDER);
      imgCell.appendChild(img);
    } else {
      imgCell.innerHTML = '<div style="width:120px; height:60px; background:#333; display:flex; align-items:center; justify-content:center; font-size:0.8em; color:#666; border-radius:4px;">No Image</div>';
    }
    
    // Name (clickable)
    const nameCell = tr.insertCell();
    const nameLink = document.createElement('span');
    nameLink.classList.add('name-link');
    nameLink.textContent = result.name;
    nameLink.addEventListener('click', () => showDetail(result, result.__kind === 'ship' ? 'ship' : 'item'));
    nameCell.appendChild(nameLink);
    
    tr.insertCell().textContent = result.__kind === 'ship' ? (result.manufacturer || 'Unknown') : (result.type || 'Unknown');
    tr.insertCell().textContent = result.role || '';
    tr.insertCell().textContent = result.size || '';
    tr.insertCell().textContent = result.owned_qty || 0;
    tr.insertCell().textContent = result.location || 'Unknown';
    
    const notesCell = tr.insertCell();
    const notesText = result.__kind === 'ship' ? (result.loadout || result.notes || '') : (result.notes || '');
    notesCell.textContent = notesText.length > 30 ? notesText.substring(0, 27) + '...' : notesText;
    notesCell.title = notesText;
    
    const reliabilityCell = tr.insertCell();
    const relScore = Math.round((result.data_reliability_score ?? 0) * 100);
    reliabilityCell.textContent = `${relScore}%`;
    reliabilityCell.classList.add(getReliabilityClass(result.data_reliability_score ?? 0));
    
    // Actions
    const actionsCell = tr.insertCell();
    const key = result.__kind === 'ship' ? result.name : result.id;
    
    const editBtn = document.createElement('button');
    editBtn.textContent = '✏️';
    editBtn.title = 'Edit';
    editBtn.style.marginRight = '5px';
    editBtn.style.width = 'auto';
    editBtn.style.padding = '5px 8px';
    editBtn.addEventListener('click', () => editItem(result.__kind === 'ship' ? 'ship' : 'item', String(key)));
    
    const delBtn = document.createElement('button');
    delBtn.textContent = '🗑️';
    delBtn.title = 'Delete';
    delBtn.style.background = 'rgba(255,69,0,0.3)';
    delBtn.style.borderColor = '#FF4500';
    delBtn.style.color = '#FF4500';
    delBtn.style.width = 'auto';
    delBtn.style.padding = '5px 8px';
    delBtn.addEventListener('click', () => deleteItem(result.__kind === 'ship' ? 'ship' : 'item', String(key)));
    
    actionsCell.appendChild(editBtn);
    actionsCell.appendChild(delBtn);
  }

  function clearSearch() {
    document.getElementById('search-query').value = '';
    document.getElementById('search-filter-type').value = '';
    document.getElementById('search-filter-manufacturer').value = '';
    document.getElementById('search-filter-role').value = '';
    
    const tbody = document.querySelector('#search-table tbody');
    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #888;">Enter search criteria and click Search to find assets.</td></tr>';
    
    logActivity('Search filters cleared');
  }

  // === SYNC FUNCTIONALITY ===
  document.getElementById('sync-btn').addEventListener('click', () => syncData(true));
  
  async function syncData(force = false) {
    if (!navigator.onLine) {
      document.getElementById('offline-banner').style.display = 'block';
      logActivity('Sync aborted: device offline', 'WARNING');
      return;
    }
    
    document.getElementById('offline-banner').style.display = 'none';
    document.getElementById('sync-status').style.display = 'block';
    
    try {
      logActivity('Starting fleet data synchronization...');
      
      const ships = await db.ships.toArray();
      let syncedCount = 0;
      let failedCount = 0;
      
      for (const ship of ships) {
        const needsSync = !ship.last_sync || 
                         (Date.now() - ship.last_sync > 24 * 60 * 60 * 1000) || 
                         (ship.enriched_version !== currentSCVersion) || 
                         force;
        
        if (needsSync) {
          try {
            logActivity(`Syncing ${ship.name}...`);
            const enriched = await getFullShipInfo(ship.name);
            
            if (enriched.source !== 'Fallback') {
              const updateObj = {
                manufacturer: enriched.manufacturer || ship.manufacturer,
                role: enriched.role || ship.role,
                size: enriched.size || ship.size,
                image_url: enriched.image_url || ship.image_url || IMAGE_PLACEHOLDER,
                hp: enriched.hp ?? ship.hp,
                shield: enriched.shield ?? ship.shield,
                cargo: enriched.cargo ?? ship.cargo,
                hardpoints_json: enriched.hardpoints ? JSON.stringify(enriched.hardpoints) : ship.hardpoints_json,
                value: enriched.value ?? ship.value,
                last_sync: Date.now(),
                data_reliability_score: 1.0,
                enriched_version: currentSCVersion
              };
              
              // Preserve user loadout
              if (ship._loadout_source !== 'user') {
                updateObj.loadout = ship.loadout || getDefaultLoadout(ship.name);
                updateObj._loadout_source = 'default';
              }
              
              await db.ships.update(ship.name, updateObj);
              syncedCount++;
              logActivity(`✅ Synced ${ship.name} from ${enriched.source}`);
            }
          } catch (e) {
            failedCount++;
            logActivity(`❌ Sync failed for ${ship.name}: ${e.message}`, 'WARNING');
          }
        }
      }
      
      await updateDashboard();
      await updateTrading();
      await updateWishlistTable();
      
      const message = `Sync complete: ${syncedCount} updated, ${failedCount} failed`;
      logActivity(message, syncedCount > 0 ? 'SUCCESS' : 'INFO');
      
    } catch (e) {
      logActivity(`Sync failed: ${e.message}`, 'ERROR');
    } finally {
      document.getElementById('sync-status').style.display = 'none';
      await checkApiHealth();
    }
  }

  // === DEFAULT SHIPS ===
  async function addDefaultShips() {
    const count = await db.ships.count();
    if (count === 0) {
      logActivity('Adding default fleet ships...');
      
      const defaultShips = [
        { name: 'Gladius', location: 'Area18 Hangar 01' },
        { name: 'Cutlass Black', location: 'Area18 Hangar 02' },
        { name: 'Hull-C', location: 'Port Olisar Bay 3' }
      ];
      
      for (const defaultShip of defaultShips) {
        try {
          const defaultData = getDefaultShipData(defaultShip.name);
          const enriched = await getFullShipInfo(defaultShip.name);
          
          await db.ships.put({
            name: defaultShip.name,
            manufacturer: enriched.manufacturer || defaultData.manufacturer,
            role: enriched.role || defaultData.role,
            size: enriched.size || defaultData.size,
            value: enriched.value || defaultData.value,
            owned_qty: 1,
            location: defaultShip.location,
            loadout: getDefaultLoadout(defaultShip.name),
            _loadout_source: 'default',
            notes: 'Default fleet ship',
            image_url: enriched.image_url || IMAGE_PLACEHOLDER,
            hp: enriched.hp || null,
            shield: enriched.shield || null,
            cargo: enriched.cargo || null,
            hardpoints_json: enriched.hardpoints ? JSON.stringify(enriched.hardpoints) : null,
            last_sync: Date.now(),
            data_reliability_score: enriched.source !== 'Fallback' ? 1.0 : 0.5,
            enriched_version: currentSCVersion
          });
          
          logActivity(`Added default ship: ${defaultShip.name}`, 'SUCCESS');
        } catch (e) {
          logActivity(`Failed to add default ship ${defaultShip.name}: ${e.message}`, 'WARNING');
        }
      }
    }
  }

  // === EXPORT/IMPORT ===
  document.getElementById('export-btn').addEventListener('click', async () => {
    try {
      const ships = await db.ships.toArray();
      const items = await db.items.toArray();
      const wishlist = await db.wishlist.toArray();
      const settings = {
        userHandle: localStorage.getItem('userHandle') || 'Anonymous',
        scVersion: currentSCVersion,
        lastVersionCheck: lastVersionCheck?.toISOString() || null
      };
      
      const exportData = {
        meta: {
          version: '2.5.0',
          exportedAt: new Date().toISOString(),
          sc_version: currentSCVersion,
          total_ships: ships.length,
          total_items: items.length,
          total_wishlist: wishlist.length
        },
        ships,
        items,
        wishlist,
        settings
      };
      
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sc_fleet_manager_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      
      logActivity(`Exported ${ships.length} ships, ${items.length} items`, 'SUCCESS');
    } catch (e) {
      logActivity(`Export failed: ${e.message}`, 'ERROR');
      alert('❌ Export failed. Please try again.');
    }
  });

  document.getElementById('import-btn').addEventListener('click', () => {
    document.getElementById('import-file').click();
  });

  document.getElementById('import-file').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      logActivity(`Importing data from ${file.name}...`);
      const text = await file.text();
      const data = JSON.parse(text);
      
      let importedShips = 0, importedItems = 0, importedWishlist = 0;
      
      // Import ships
      if (data.ships && Array.isArray(data.ships)) {
        for (const ship of data.ships) {
          if (ship.name) {
            ship._loadout_source = ship._loadout_source || (ship.loadout ? 'user' : 'default');
            await db.ships.put(ship);
            importedShips++;
          }
        }
      }
      
      // Import items
      if (data.items && Array.isArray(data.items)) {
        for (const item of data.items) {
          if (item.name) {
            if (item.id) await db.items.put(item);
            else await db.items.add(item);
            importedItems++;
          }
        }
      }
      
      // Import wishlist
      if (data.wishlist && Array.isArray(data.wishlist)) {
        for (const wish of data.wishlist) {
          if (wish.name) {
            await db.wishlist.put(wish);
            importedWishlist++;
          }
        }
      }
      
      // Import settings
      if (data.settings && data.settings.userHandle) {
        localStorage.setItem('userHandle', data.settings.userHandle);
        document.getElementById('user-handle').textContent = data.settings.userHandle;
      }
      
      await updateDashboard();
      await updateTrading();
      await updateWishlistTable();
      
      const message = `Import complete: ${importedShips} ships, ${importedItems} items, ${importedWishlist} wishlist entries`;
      logActivity(message, 'SUCCESS');
      alert(`✅ ${message}`);
      
    } catch (err) {
      const errorMsg = `Import failed: ${err.message}`;
      logActivity(errorMsg, 'ERROR');
      alert(`❌ ${errorMsg}`);
    } finally {
      e.target.value = '';
    }
  });

  // === SETTINGS HANDLERS ===
  document.getElementById('save-uex-btn').addEventListener('click', () => {
    const key = document.getElementById('uex-key').value?.trim() || '';
    if (key && key.length < 10) {
      alert('⚠️ UEX API key seems too short. Please verify.');
      return;
    }
    localStorage.setItem('uexKey', key);
    logActivity(key ? 'UEX API key saved' : 'UEX API key removed', 'SUCCESS');
    alert(key ? '✅ UEX API key saved!' : '✅ UEX API key removed');
  });

  document.getElementById('save-user-btn').addEventListener('click', () => {
    const handle = document.getElementById('user-handle-input').value?.trim() || '';
    if (handle) {
      if (handle.length > 20) {
        alert('⚠️ Handle too long (max 20 characters)');
        return;
      }
      localStorage.setItem('userHandle', handle);
      document.getElementById('user-handle').textContent = handle;
      logActivity(`User handle updated: ${handle}`, 'SUCCESS');
      alert('✅ Citizen handle saved!');
    } else {
      alert('⚠️ Please enter a handle first');
    }
  });

  // === ADDITIONAL CONTROL BUTTONS ===
  document.getElementById('refresh-version-btn').addEventListener('click', refreshSCVersion);
  document.getElementById('health-check-btn').addEventListener('click', checkApiHealth);
  document.getElementById('test-apis-btn').addEventListener('click', checkApiHealth);
  
  document.getElementById('clear-cache-btn').addEventListener('click', () => {
    if (confirm('⚠️ Clear all cached data? This will force fresh data fetching.')) {
      localStorage.removeItem('scVersion');
      localStorage.removeItem('scVersionTimestamp');
      logActivity('Cache cleared', 'SUCCESS');
      alert('✅ Cache cleared successfully');
    }
  });

  document.getElementById('backup-data-btn').addEventListener('click', () => {
    document.getElementById('export-btn').click();
  });

  document.getElementById('clear-cache-settings-btn').addEventListener('click', () => {
    document.getElementById('clear-cache-btn').click();
  });

  document.getElementById('refresh-all-btn').addEventListener('click', () => {
    syncData(true);
  });

  document.getElementById('clear-all-data-btn').addEventListener('click', async () => {
    const confirmation = prompt('⚠️ DANGER: This will delete ALL your data! Type "DELETE ALL" to confirm:');
    if (confirmation === 'DELETE ALL') {
      try {
        await db.ships.clear();
        await db.items.clear();
        await db.wishlist.clear();
        await db.audit_log.clear();
        await db.history.clear();
        localStorage.clear();
        
        logActivity('All data cleared', 'WARNING');
        alert('✅ All data has been cleared. The page will reload.');
        location.reload();
      } catch (e) {
        logActivity(`Data clear failed: ${e.message}`, 'ERROR');
        alert('❌ Failed to clear data. Please try again.');
      }
    }
  });

  // === NAVIGATION TAB HANDLERS ===
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const targetTab = tab.getAttribute('data-tab');
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(targetTab).classList.add('active');
      
      logActivity(`Switched to ${targetTab} tab`);
    });
  });

  // === MODAL HANDLERS ===
  document.querySelector('#edit-modal .close').addEventListener('click', closeModal);
  window.addEventListener('click', (e) => {
    if (e.target === document.getElementById('edit-modal')) closeModal();
  });

  // === CREATE STARFIELD ===
  function createStars() {
    const starfield = document.querySelector('.starfield');
    starfield.innerHTML = '';
    
    for (let i = 0; i < 400; i++) {
      const star = document.createElement('div');
      star.classList.add('star');
      const size = Math.random() * 4 + 1;
      star.style.width = star.style.height = size + 'px';
      star.style.top = Math.random() * 100 + '%';
      star.style.left = Math.random() * 100 + '%';
      star.style.animationDelay = Math.random() * 4 + 's';
      star.style.animationDuration = (3 + Math.random() * 5) + 's';
      starfield.appendChild(star);
    }
  }

  // === INITIALIZATION ===
  async function init() {
    try {
      logActivity('🚀 Fleet Manager v2.5.0 - Cockpit Edition initializing...', 'INFO');
      
      createStars();
      
      // Load user settings
      const savedHandle = localStorage.getItem('userHandle');
      if (savedHandle) {
        document.getElementById('user-handle').textContent = savedHandle;
      }
      
      const savedUexKey = localStorage.getItem('uexKey');
      if (savedUexKey) {
        document.getElementById('uex-key').value = savedUexKey;
      }
      
      // Initialize version and API checks
      await fetchSCVersion();
      checkApiHealth(); // Run in background
      
      // Set up database and default data
      await addDefaultShips();
      
      // Update all displays
      await updateDashboard();
      await updateWishlistTable();
      await updateTrading();
      
      // Set up offline detection
      if (!navigator.onLine) {
        document.getElementById('offline-banner').style.display = 'block';
      }
      
      window.addEventListener('online', () => {
        document.getElementById('offline-banner').style.display = 'none';
        logActivity('Connection restored - online mode', 'SUCCESS');
      });
      
      window.addEventListener('offline', () => {
        document.getElementById('offline-banner').style.display = 'block';
        logActivity('Connection lost - offline mode', 'WARNING');
      });
      
      logActivity('✅ Cockpit systems online - Fleet Manager ready!', 'SUCCESS');
      
    } catch (e) {
      logActivity(`❌ Initialization failed: ${e.message}`, 'ERROR');
      console.error('Initialization error:', e);
    }
  }

  // === START THE APPLICATION ===
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  </script>
</body>
</html>
